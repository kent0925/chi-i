<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工程管理整合系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 預覽畫布樣式 */
        .preview-canvas {
            font-family: 'DFKai-SB', 'BiauKai', '標楷體', 'Noto Serif TC', serif;
            background-color: white;
            color: black;
            line-height: 1.3;
        }

        .company-title {
            font-size: 20pt;
            font-weight: bold;
            text-align: center;
        }

        .doc-title {
            font-size: 16pt;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        /* 表格樣式 */
        .info-table,
        .items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12pt;
        }

        .info-table td {
            border: 1px solid #000;
            padding: 4px 8px;
        }

        .items-table th {
            border: 1px solid #000;
            border-bottom: 2px solid #000;
            padding: 4px;
            text-align: center;
            font-weight: normal;
        }

        .items-table td {
            border: 1px solid #000;
            padding: 4px;
        }

        .summary-row {
            display: flex;
            justify-content: flex-end;
            font-size: 12pt;
            padding: 2px 0;
        }

        .summary-label {
            text-align: right;
            padding-right: 10px;
            width: 150px;
        }

        .summary-value {
            text-align: right;
            width: 120px;
            padding-right: 4px;
        }

        .history-hint {
            font-size: 0.75rem;
            color: #d97706;
            margin-top: 2px;
            font-family: 'Noto Sans TC', sans-serif;
        }

        @media print {
            .no-print {
                display: none;
            }
        }

        .page-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .page-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 驗證視窗樣式 */
        #auth-modal {
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">

    <!-- ================= 0. 驗證視窗 (新增) ================= -->
    <div id="auth-modal" class="fixed inset-0 z-[100] flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <div class="mb-4 text-blue-900">
                <i class="fa-solid fa-shield-halved text-5xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">系統存取驗證</h2>
            <p class="text-gray-500 text-sm mb-6">請輸入存取金鑰 (Token) 以繼續</p>

            <input type="password" id="auth-token-input"
                class="w-full border border-gray-300 rounded-lg p-3 text-center mb-4 focus:ring-2 focus:ring-blue-500 outline-none"
                placeholder="輸入 Token">

            <button onclick="submitAuth()"
                class="w-full bg-blue-900 text-white font-bold py-3 rounded-lg hover:bg-blue-800 transition">
                驗證登入
            </button>
            <p id="auth-error" class="text-red-500 text-xs mt-3 hidden">請輸入 Token</p>
        </div>
    </div>

    <!-- ================= 1. 首頁 (主選單) ================= -->
    <div id="page-home" class="page-section active p-4 max-w-md mx-auto">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
            <div class="bg-blue-900 p-6 text-center relative">
                <h1 class="text-2xl font-bold text-white tracking-wider">工程管理整合系統</h1>
                <p class="text-blue-200 text-sm mt-2">健益工程有限公司</p>
                <!-- 使用者資訊區 (取代原登出按鈕) -->
                <div id="header-user-info" class="absolute top-4 right-4 text-blue-200 hover:text-white text-xs">
                    <!-- JS 載入後顯示 -->
                </div>
            </div>
            <div class="p-6 grid gap-4">
                <button onclick="navigateTo('page-quotation')"
                    class="flex items-center p-4 bg-white border-2 border-blue-100 rounded-lg shadow-sm hover:bg-blue-50 hover:border-blue-300 transition group">
                    <div
                        class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition">
                        <i class="fa-solid fa-file-invoice-dollar text-xl"></i>
                    </div>
                    <div class="ml-4 text-left">
                        <h3 class="text-lg font-bold text-gray-800">報價系統</h3>
                        <p class="text-xs text-gray-500">客戶報價單</p>
                    </div>
                    <i class="fa-solid fa-chevron-right ml-auto text-gray-300 group-hover:text-blue-500"></i>
                </button>
                <button onclick="navigateTo('page-cost')"
                    class="flex items-center p-4 bg-white border-2 border-green-100 rounded-lg shadow-sm hover:bg-green-50 hover:border-green-300 transition group">
                    <div
                        class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center text-green-600 group-hover:bg-green-600 group-hover:text-white transition">
                        <i class="fa-solid fa-calculator text-xl"></i>
                    </div>
                    <div class="ml-4 text-left">
                        <h3 class="text-lg font-bold text-gray-800">成本系統</h3>
                        <p class="text-xs text-gray-500">工料成本分析</p>
                    </div>
                    <i class="fa-solid fa-chevron-right ml-auto text-gray-300 group-hover:text-green-500"></i>
                </button>
                <button onclick="navigateTo('page-accounting')"
                    class="flex items-center p-4 bg-white border-2 border-orange-100 rounded-lg shadow-sm hover:bg-orange-50 hover:border-orange-300 transition group">
                    <div
                        class="w-12 h-12 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 group-hover:bg-orange-600 group-hover:text-white transition">
                        <i class="fa-solid fa-coins text-xl"></i>
                    </div>
                    <div class="ml-4 text-left">
                        <h3 class="text-lg font-bold text-gray-800">會計系統</h3>
                        <p class="text-xs text-gray-500">請款與帳務</p>
                    </div>
                    <i class="fa-solid fa-chevron-right ml-auto text-gray-300 group-hover:text-orange-500"></i>
                </button>

                <!-- [新增] 使用說明按鈕 -->
                <button onclick="showUserGuide()"
                    class="flex items-center p-4 bg-white border-2 border-gray-200 rounded-lg shadow-sm hover:bg-gray-100 hover:border-gray-400 transition group mt-2">
                    <div
                        class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 group-hover:bg-gray-600 group-hover:text-white transition">
                        <i class="fa-solid fa-book-open text-xl"></i>
                    </div>
                    <div class="ml-4 text-left">
                        <h3 class="text-lg font-bold text-gray-800">系統使用說明</h3>
                        <p class="text-xs text-gray-500">操作教學與注意事項</p>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- [新增] 使用說明 Modal -->
    <div id="guide-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black bg-opacity-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[85vh] overflow-y-auto p-8 relative">
            <button onclick="document.getElementById('guide-modal').classList.add('hidden')"
                class="absolute top-4 right-4 text-gray-500 hover:text-black">
                <i class="fa-solid fa-times text-2xl"></i>
            </button>
            <h2 class="text-3xl font-bold mb-6 border-b pb-4 text-gray-800">工程管理整合系統 - 操作手冊</h2>

            <div class="space-y-8 text-gray-700 leading-relaxed overflow-y-auto pr-2">

                <section>
                    <h3 class="text-xl font-bold text-blue-900 mb-3 border-l-4 border-blue-500 pl-3">一、系統登入與驗證</h3>
                    <ul class="list-disc pl-5 mt-2 space-y-2">
                        <li><strong>操作方式：</strong>系統採用 <strong>LIFF (LINE Front-end Framework)</strong>
                            進行身分驗證，開啟網頁即自動登入。</li>
                        <li><strong>權限說明：</strong>系統將自動記錄您的 LINE User ID，作為後續資料權限判斷依據。</li>
                    </ul>
                </section>

                <section>
                    <h3 class="text-xl font-bold text-blue-900 mb-3 border-l-4 border-blue-500 pl-3">二、建立單據步驟</h3>
                    <ol class="list-decimal pl-5 mt-2 space-y-2">
                        <li>
                            <strong>填寫基本資料：</strong>
                            <ul class="list-disc pl-5 mt-1 text-sm text-gray-600">
                                <li><strong>統編查詢：</strong>輸入 8 碼統編後，系統自動帶入公司名稱 (無需手動輸入)。</li>
                                <li><strong>內控資訊：</strong>點擊「生成」按鈕可取得當日最新專案編號；業務人員可由選單選擇。</li>
                            </ul>
                        </li>
                        <li>
                            <strong>新增項目明細：</strong>
                            <ul class="list-disc pl-5 mt-1 text-sm text-gray-600">
                                <li><strong>智慧提示：</strong>輸入項目名稱前兩字，若歷史資料有相同項目，可直接選用 (自動帶入單價/單位)。</li>
                                <li><strong>單位記憶：</strong>若輸入新單位，系統會自動儲存至後台供下次使用。</li>
                            </ul>
                        </li>
                        <li><strong>預覽與存檔：</strong>確認內容無誤後，點擊下方「預覽並儲存」，系統將自動生成圖片並上傳至資料庫。</li>
                    </ol>
                </section>

                <section>
                    <h3 class="text-xl font-bold text-blue-900 mb-3 border-l-4 border-blue-500 pl-3">三、資料庫欄位說明</h3>
                    <p class="mb-2">系統自動將資料存入 Google Sheet，主要欄位包含：</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-gray-700 border border-gray-200">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 border">欄位</th>
                                    <th class="px-4 py-2 border">說明</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="bg-white border-b">
                                    <td class="px-4 py-2 font-medium">單號/日期/客戶</td>
                                    <td class="px-4 py-2">基本索引資訊</td>
                                </tr>
                                <tr class="bg-gray-50 border-b">
                                    <td class="px-4 py-2 font-medium">專案ID (內控)</td>
                                    <td class="px-4 py-2">內部列管編號 (P-YYYYMMDDxxxx)</td>
                                </tr>
                                <tr class="bg-white border-b">
                                    <td class="px-4 py-2 font-medium">業務人員</td>
                                    <td class="px-4 py-2">負責該案人員</td>
                                </tr>
                                <tr class="bg-gray-50 border-b">
                                    <td class="px-4 py-2 font-medium">檔案連結</td>
                                    <td class="px-4 py-2">自動產生的報價單圖檔連結</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

            </div>

            <div class="mt-8 text-center pt-4 border-t">
                <button onclick="document.getElementById('guide-modal').classList.add('hidden')"
                    class="bg-gray-800 text-white px-8 py-3 rounded-lg hover:bg-gray-700 font-bold transition shadow-lg">
                    關閉說明
                </button>
            </div>
        </div>
    </div>

    <!-- ================= 2. 報價系統 ================= -->
    <div id="page-quotation" class="page-section p-4">
        <!-- 內容由 JS 動態渲染 -->
        <div id="app-container"></div>
    </div>

    <!-- (JS 部分更新) -->
    <script>
        // ... (保留前面)

        function showUserGuide() {
            document.getElementById('guide-modal').classList.remove('hidden');
        }

        // --- 統編查詢 ---
        async function lookupCompany() {
            const taxId = document.getElementById('taxId').value.trim();
            const nameInput = document.getElementById('customer');

            // [新增] 自動查詢邏輯
            if (taxId.length === 8) {
                nameInput.placeholder = "查詢中...";
                try {
                    const response = await fetch(`https://data.gcis.nat.gov.tw/od/data/api/9D17AE0D-09B5-4432-A8F4-81B43F75F718?$format=json&$filter=Business_Accounting_NO eq ${taxId}&$skip=0&$top=1`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data && data.length > 0) {
                            nameInput.value = data[0].Company_Name;
                            loadHistory(currentSystem);
                        } else {
                            // 查無資料不報錯，僅提示
                            nameInput.placeholder = "查無統編，請手動輸入";
                        }
                    }
                } catch (e) { console.log("Lookup error", e); }
            }
        }

        // --- 項目歷史紀錄 ---
        function checkItemHistory(input) {
            const val = input.value.trim();
            if (val.length < 1) return;

            const listId = 'list-' + input.closest('.item-row').id;
            let datalist = document.getElementById(listId);

            // 動態建立 datalist
            if (!datalist) {
                datalist = document.createElement('datalist');
                datalist.id = listId;
                document.body.appendChild(datalist);
                input.setAttribute('list', listId);

                // 監聽選擇事件 (較複雜，需配合 input event 判斷是否選中)
                input.addEventListener('change', function () {
                    const selectedOption = Array.from(datalist.options).find(opt => opt.value === this.value);
                    if (selectedOption) {
                        const price = selectedOption.getAttribute('data-price');
                        const unit = selectedOption.getAttribute('data-unit');
                        const row = this.closest('.item-row');
                        if (price) row.querySelector('.input-price').value = price;
                        // 單位處理較複雜，暫略，或簡單填入 custom
                        if (unit) {
                            row.querySelector('.input-unit-custom').value = unit;
                            row.querySelector('.input-unit-custom').classList.remove('hidden');
                            row.querySelector('.input-unit-select').classList.add('hidden');
                            row.querySelector('.input-unit-select').value = 'custom';
                        }
                    }
                });
            }

            // 讀取歷史
            const history = JSON.parse(localStorage.getItem('item_history') || '[]');
            // 過濾前兩個字符合的
            const matches = history.filter(item => item.name.startsWith(val.slice(0, 2))); // 至少前兩字

            datalist.innerHTML = matches.map(item =>
                `<option value="${item.name}" data-price="${item.price}" data-unit="${item.unit}">歷史: $${item.price}/${item.unit}</option>`
            ).join('');
        }

        function saveNewItemsToHistory(items) {
            let history = JSON.parse(localStorage.getItem('item_history') || '[]');
            items.forEach(newItem => {
                if (newItem.type === 'item') {
                    // 避免重複：以前兩字+名稱完全相同判斷，或更新最新單價
                    const idx = history.findIndex(h => h.name === newItem.name);
                    if (idx > -1) {
                        history[idx] = { name: newItem.name, price: newItem.price, unit: newItem.unit }; // 更新價格
                    } else {
                        history.push({ name: newItem.name, price: newItem.price, unit: newItem.unit });
                    }
                }
            });
            localStorage.setItem('item_history', JSON.stringify(history));
        }

        // ...
    </script>

    <!-- ================= 3. 成本系統 ================= -->
    <div id="page-cost" class="page-section p-4">
        <div id="cost-container"></div>
    </div>

    <!-- ================= 4. 會計系統 ================= -->
    <div id="page-accounting" class="page-section p-4">
        <div id="acc-container"></div>
    </div>

    <!-- 共用預覽區 -->
    <div id="preview-section"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50 overflow-y-auto p-4">
        <div class="bg-white rounded shadow-xl max-w-[230mm] w-full overflow-hidden flex flex-col max-h-[95vh]">
            <div class="overflow-y-auto flex-1 bg-gray-500 p-4 flex justify-center">
                <div id="quotation-canvas"
                    class="preview-canvas bg-white p-12 w-full max-w-[210mm] min-h-[297mm] shadow-lg relative">

                    <!-- 1. 抬頭與 Logo -->
                    <div class="flex items-start mb-4 relative">
                        <div class="absolute left-0 top-0">
                            <img id="disp-logo" src="" class="h-20 object-contain hidden" alt="Company Logo">
                        </div>
                        <div class="w-full text-center">
                            <div class="company-title" id="disp-seller-name">健益工程有限公司</div>
                            <div class="doc-title" id="disp-doc-title">工程報價單</div>
                        </div>
                    </div>

                    <!-- 2. 客戶與工程資訊表格 -->
                    <table class="info-table mb-1">
                        <tr>
                            <td class="text-center w-[15%]">公司名稱</td>
                            <td class="w-[35%]" id="disp-customer"></td>
                            <td class="text-center w-[15%]">聯絡人</td>
                            <td class="w-[35%]" id="disp-contact"></td>
                        </tr>
                        <tr>
                            <td class="text-center">工程名稱</td>
                            <td id="disp-project"></td>
                            <td class="text-center">聯絡電話</td>
                            <td id="disp-phone"></td>
                        </tr>
                    </table>
                    <div class="text-right text-sm mb-2 font-kai">
                        日期：<span id="disp-date"></span> &nbsp;&nbsp; 單號：<span id="disp-id"></span>
                        <span id="disp-taxId-wrapper" class="hidden">&nbsp;&nbsp; 統編：<span
                                id="disp-taxId"></span></span>
                    </div>

                    <!-- 3. 明細表格 -->
                    <table class="items-table mb-2">
                        <thead>
                            <tr class="bg-white">
                                <th style="width: 8%;">項 次</th>
                                <th style="width: 35%;">產品名稱</th>
                                <th style="width: 8%;">單位</th>
                                <th style="width: 10%;">數量</th>
                                <th style="width: 12%;">單 價</th>
                                <th style="width: 12%;">複 價</th>
                                <th style="width: 15%;">備 註</th>
                            </tr>
                        </thead>
                        <tbody id="disp-items"></tbody>
                    </table>

                    <!-- 4. 總計計算區 -->
                    <div class="flex justify-end mt-4 px-2">
                        <div class="w-1/2">
                            <div id="disp-additional-fees"></div>
                            <div class="summary-row">
                                <div class="summary-label">合 計 :</div>
                                <div class="summary-value" id="disp-subtotal-notax">0</div>
                            </div>
                            <div class="summary-row">
                                <div class="summary-label">稅 金 :</div>
                                <div class="summary-value" id="disp-tax-amount">0</div>
                            </div>
                            <div class="summary-row" style="border-top: 1px solid #000; margin-top: 2px;">
                                <div class="summary-label">總 計 :</div>
                                <div class="summary-value" id="disp-grand-total">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- 5. 大寫金額 -->
                    <div class="mt-4 text-lg border-b-2 border-transparent pb-1" style="border-bottom: 2px solid #ccc;">
                        新台幣： <span id="disp-chinese-amt" class="font-bold px-2">零元整</span>
                    </div>

                    <!-- 6. 法律聲明 -->
                    <div class="mt-1 text-center font-bold text-sm bg-gray-100 p-1 border border-black">
                        本交易為附條件買賣，內容依動產擔保交易法第三章規定。
                    </div>

                    <!-- 7. 備註 -->
                    <div class="mt-4 flex">
                        <div class="font-bold w-[60px]">備註:</div>
                        <div class="flex-1">
                            <pre id="disp-note" class="whitespace-pre-wrap font-kai"></pre>
                        </div>
                    </div>

                    <!-- 8. LINE帳號/頁尾資訊 -->
                    <div class="mt-12">
                        <div class="mb-2 font-bold">LINE帳號</div>
                        <div class="border-t border-black pt-2 text-center text-sm" id="disp-seller-contact-footer">
                        </div>
                    </div>

                </div>
            </div>
            <div class="p-4 bg-gray-50 flex gap-4 border-t z-50">
                <button onclick="closePreview()"
                    class="flex-1 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 font-bold">返回修改</button>
                <button onclick="downloadJPG()" id="btn-download"
                    class="flex-1 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold shadow">下載 JPG
                    圖片</button>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzDAF6z227x3Hif3CxISbQSNV_xAHXk8BAYzAd8w0haV_39poKQCjnUbJhZAgcEfBBP/exec';
        const LIFF_ID = '2008974069-Ecojk6W1'; // 請在此填入您的 LIFF ID
        // 資料變數
        let salesPersons = []; // 業務/工務/採購 共用此名單
        let unitOptions = [];
        let vendors = []; // [新增]
        let nextProjectId = '';
        let projectList = [];
        const DEFAULT_LOGO = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFsAAABbCAMAAAAr6AmrAAAAA3NCSVQICAjb4U/gAAAADFBMVEX/igX/////nS7/kBGlc65UAAAApXpUWHRSYXcgcHJvZmlsZSB0eXBlIEFQUDEAABiVfU5bDsIwDPvvKXYE57G0PU5BBU1CgHb/DxI6xCYhHDV2rShOuvZ7X5fz9Fwfl+XW0xQgtaRVKzcABQMCEIOCvQ9sLOSKXeTtz4OtlgzdzTUcMPuEiVH29zZiFnXs0U+ssBcQx+x2zSd8l/7wGU3jJt78fIyGlEiWIuxdJbuqFiBnNRP8r0B6AQnGQScUvA0CAAABdklEQVRoge3ZWxLCIAwF0DTZ/57V6djyJiG5jjjypZQeUoqAQORNRze56UEFQXaTj7NrPdIu9VibGGhnoYfbhLQJaRPSJqRNSJuBNiFt2tWmX2362y38p22+Jom3swkwLS3lrF5VzpOqq3TdUNkTaion8blsbsE34rG79HE2u8MeyCe+bo+iPpl5P+mk7MaqvjvCsogmdZ5UyqwFu/+gRW0eu77E3Cq4QE9fz7o971Vmm/V3mG192Ot2bFG4LR+wNWOP1eZN7V3bBBn3rr+d6wbFBGi2keOg6AM324aNBLvNatxuG7ZXJM9asJOlT97mXEALdrZkkyrXF3e51Hz+J0m/njUlma/Pev4YpmaBGFyc9gCX9mWDXa+wM8Nnt1f4726jscfvt9TvKxp7/iiWSc5qr6dtb2sz6u1Nt5XMP6jvsWFv0z7K2GzoLrh9E01vQ48doOcl0IMe6AkV9GgNeiYY3hVn82mcHTu2aNYCcXZc8C07qIIHIcAGb2GaLZ0AAAAASUVORK5CYII=';
        let userLogoData = DEFAULT_LOGO;

        // 當前系統狀態 'quotation' | 'cost' | 'accounting'
        let currentSystem = 'quotation';

        // LIFF 使用者資訊
        let liffUser = { userId: null, displayName: null, pictureUrl: null };

        let currentOriginId = null; // 用於修改模式記錄原單號

        // 初始化
        window.onload = function () {
            initializeLiff();
            fetchSystemConfig(); // [新增] 載入系統設定
        };

        // --- LIFF 初始化與登入 ---
        async function initializeLiff() {
            try {
                if (LIFF_ID === '您的_LIFF_ID') {
                    console.warn('尚未設定 LIFF ID');
                    renderUI('app-container', 'quotation');
                    return;
                }

                await liff.init({ liffId: LIFF_ID });

                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    liffUser = {
                        userId: profile.userId,
                        displayName: profile.displayName,
                        pictureUrl: profile.pictureUrl
                    };
                    console.log("LIFF 登入成功:", liffUser.displayName);

                    // [新增] 更新右上角使用者資訊
                    updateUserInfoUI();

                    renderUI('app-container', 'quotation');
                }
            } catch (err) {
                console.error('LIFF 初始化失敗:', err);
                renderUI('app-container', 'quotation');
            }
        }

        function updateUserInfoUI() {
            const headerInfo = document.getElementById('header-user-info');
            if (headerInfo && liffUser.displayName) {
                // 移除登出按鈕，僅顯示資訊
                headerInfo.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="flex flex-col text-right">
                             <span class="text-white font-bold text-sm leading-tight">${liffUser.displayName}</span>
                             <span class="text-blue-300 text-[10px]">已連結</span>
                        </div>
                        <img src="${liffUser.pictureUrl || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full border-2 border-white shadow-sm">
                    </div>
                `;
            }
        }

        // --- [新增] 取得後端設定 ---
        function fetchSystemConfig() {
            if (GAS_URL === '您的_GAS_WEB_APP_URL') return;
            fetch(GAS_URL)
                .then(res => res.json())
                .then(data => {
                    if (data) {
                        salesPersons = data.sales || []; // 業務/工務/採購 共用此名單
                        unitOptions = data.units || [];
                        vendors = data.vendors || []; // [新增]
                        nextProjectId = data.nextProjectId || '';
                        projectList = data.projects || []; // [新增]

                        // 若 UI 已渲染，重新更新相關欄位
                        renderDynamicLists();

                        // [新增] 延遲載入的 ID 填入 (解決非同步問題)
                        const idInput = document.getElementById('internalProjectId');
                        if (idInput && currentSystem === 'quotation' && nextProjectId) {
                            idInput.value = nextProjectId;
                        }
                    }
                })
                .catch(e => console.error("Config fetch failed", e));
        }

        // --- 統編驗證 ---
        function checkTaxId(input) {
            // 移除非數字
            input.value = input.value.replace(/\D/g, '');
            const warningId = input.id === 'taxId' ? 'tax-warning' : 'tax-warning-vendor';
            const warning = document.getElementById(warningId);
            if (input.value.length > 0 && input.value.length !== 8) {
                warning?.classList.remove('hidden');
            } else {
                warning?.classList.add('hidden');
            }
        }

        // --- 儲存設定 (人員/單位) ---
        function saveConfig(type, value) {
            if (!value) return;
            // 檢查是否已存在
            if (type === 'sales' && salesPersons.includes(value)) return;
            if (type === 'unit' && unitOptions.includes(value)) return;
            if (type === 'vendor' && vendors.includes(value)) return;

            // 前端更新
            if (type === 'sales') {
                salesPersons.push(value);
            } else if (type === 'unit') {
                unitOptions.push(value);
            } else if (type === 'vendor') {
                vendors.push(value);
            }
            renderDynamicLists();

            // 後端儲存
            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'save_config', configType: type, value: value }),
                mode: 'no-cors'
            });
        }

        function renderDynamicLists() {
            // 更新業務清單
            const salesList = document.getElementById('sales-list');
            if (salesList) {
                salesList.innerHTML = salesPersons.map(s => `<option value="${s}">`).join('');
            }
            // 更新廠商清單
            const vendorList = document.getElementById('vendor-list');
            if (vendorList) {
                vendorList.innerHTML = vendors.map(v => `<option value="${v}">`).join('');
            }
            // 單位清單會在 addRow 時動態生成
        }

        // --- [新增] 邏輯控制 ---
        function checkQty(input) {
            if (parseFloat(input.value) < 0) {
                alert("數量不能為負數！");
                input.value = 0;
            }
        }

        function checkPrice(input) {
            if (parseFloat(input.value) < 0) {
                if (!confirm("警告：單價為負數，確定要繼續嗎？")) {
                    input.value = 0;
                }
            }
        }

        function generateProjectId() {
            const input = document.getElementById('internalProjectId');
            if (input && nextProjectId) {
                input.value = nextProjectId;
                // 為了避免重複，前端顯示後暫時 +1 (實際準確度依賴後端再次確認或由後端更新)
                // 簡易處理：若後端回傳 202601260001, 前端使用後可簡單設為 used
            } else {
                alert("尚未取得專案ID或連線中...");
            }
        }

        function saveUnit(unit) {
            // 檢查是否為新單位
            if (unit && unit !== 'custom' && !unitOptions.includes(unit)) {
                unitOptions.push(unit); // 前端先更新
                // 背景送出儲存
                fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'save_unit', unit: unit }),
                    mode: 'no-cors'
                });
            }
        }

        // --- Cost 專用：計算總額 (因移除明細) ---
        function calculateCostTotal() {
            if (currentSystem !== 'cost') return;
            const amount = parseFloat(document.getElementById('costAmount').value) || 0;
            const needTax = document.getElementById('needTax').checked;
            const tax = needTax ? Math.round(amount * 0.05) : 0;
            const total = amount + tax;

            // 這裡可以更新 UI 顯示總計，例如在 generatePreview 之前
            // 目前先讓 generatePreview 負責最終計算和顯示
        }

        // --- 核心：頁面與系統切換 ---
        function navigateTo(pageId) {
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            window.scrollTo(0, 0);

            if (pageId === 'page-quotation') {
                currentSystem = 'quotation';
                renderUI('app-container', 'quotation');
            } else if (pageId === 'page-cost') {
                currentSystem = 'cost';
                renderUI('cost-container', 'cost');
            } else if (pageId === 'page-accounting') {
                currentSystem = 'accounting';
                renderUI('acc-container', 'accounting');
            }
            // 頁面切換後更新 UI 資訊 (因為 innerHTML 重繪了)
            setTimeout(updateUserInfoUI, 50);
        }

        // --- 動態渲染 UI (共用模板) ---
        function renderUI(containerId, systemType) {
            const titles = { quotation: '建立工程報價單', cost: '專案成本分析表', accounting: '會計請款/帳務單' };
            const docTitles = { quotation: '工程報價單', cost: '成本分析單', accounting: '請款單' };
            const themeColor = { quotation: 'blue', cost: 'green', accounting: 'orange' };

            const color = themeColor[systemType];
            const today = new Date().toISOString().split('T')[0];

            let extraHtml = '';
            let basicInfoHtml = '';
            let detailSectionHtml = '';

            // 共用 datalist
            const sharedDatalists = `
                <datalist id="sales-list">${salesPersons.map(s => `<option value="${s}">`).join('')}</datalist>
                <datalist id="vendor-list">${vendors.map(v => `<option value="${v}">`).join('')}</datalist>
            `;

            // --- 0. 共用頂部區塊 (內控與業務) [置頂需求] ---
            const internalIdVal = (systemType === 'quotation') ? nextProjectId : ''; // 預設值
            const internalInfoHtml = `
            <div class="mb-4 bg-gray-100 p-3 rounded border border-gray-300">
                <h3 class="text-xs font-bold text-gray-500 mb-2 border-b pb-1">業務與內控資訊 (本單據歸屬)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                     <div>
                         <label class="block text-xs font-bold text-gray-600 mb-1">專案ID (內控)</label>
                         <input type="text" id="internalProjectId" class="w-full border border-gray-300 rounded p-1 text-sm bg-white" value="${internalIdVal}" readonly>
                     </div>
                     <div>
                         <label class="block text-xs font-bold text-gray-600 mb-1">業務人員</label>
                         <input type="text" id="salesPerson" list="sales-list" class="w-full border border-gray-300 rounded p-1 text-sm" placeholder="輸入或選擇" onchange="saveConfig('sales', this.value)">
                     </div>
                     <div>
                         <label class="block text-xs font-bold text-gray-600 mb-1">業務手機</label>
                         <input type="text" id="salesMobile" class="w-full border border-gray-300 rounded p-1 text-sm" placeholder="09xx-xxx-xxx">
                     </div>
                </div>
                ${sharedDatalists}
            </div>`;

            // --- 報價系統特有 UI (修改歷史單) ---
            if (systemType === 'quotation') {
                extraHtml = `
                 ${internalInfoHtml}
                 <div class="mb-4 bg-blue-50 p-3 rounded border border-blue-200 flex items-center justify-between">
                    <div>
                        <label class="font-bold text-blue-900 text-sm mr-2">修改歷史單據：</label>
                        <select id="historySelect" onchange="loadQuoteForEdit(this.value)" class="border border-blue-300 rounded p-1 text-sm w-64">
                            <option value="">-- 建立新單據 --</option>
                            ${projectList.map(p => `<option value="${p.id}">${p.date} ${p.customer} (${p.project})</option>`).join('')}
                        </select>
                    </div>
                    <span id="edit-mode-badge" class="hidden bg-red-500 text-white text-xs px-2 py-1 rounded">修改模式</span>
                 </div>`;

                basicInfoHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="md:col-span-2 bg-blue-50 p-3 rounded-md border border-blue-100">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                客戶名稱 <span class="text-xs text-blue-500 font-normal ml-2">(可輸入統編8碼自動帶入)</span>
                            </label>
                            <div class="flex gap-2 mb-2 items-center">
                                <div class="w-1/3 relative">
                                    <input type="text" id="taxId" class="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="統編(選填)" oninput="checkTaxId(this)">
                                    <span id="tax-warning" class="hidden absolute top-full left-0 text-[10px] text-red-500 font-bold">請輸入8碼數字</span>
                                </div>
                                <button onclick="lookupCompany()" class="bg-blue-600 text-white px-3 py-1 rounded-md text-xs h-9">查詢</button>
                                <input type="text" id="customer" class="flex-1 border border-gray-300 rounded-md p-2" placeholder="輸入客戶名稱" oninput="loadHistory('quotation')">
                            </div>
                            <!-- 歷史紀錄下拉區 -->
                            <div id="history-area" class="mt-2 hidden">
                                <p class="text-xs text-gray-500 mb-1 font-bold">該客戶歷史紀錄：</p>
                                <ul id="history-list" class="text-xs text-gray-600 bg-white border border-gray-200 rounded max-h-24 overflow-y-auto p-1"></ul>
                            </div>
                        </div>

                        <!-- 聯絡資訊拆分 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">客戶聯絡人</label>
                            <input type="text" id="contactPerson" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">客戶聯絡電話</label>
                            <input type="text" id="contactPhone" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                        </div>

                        <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">工程/專案名稱</label><input type="text" id="projectName" class="w-full border border-gray-300 rounded-md p-2 text-sm"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">日期</label><input type="date" id="quoteDate" class="w-full border border-gray-300 rounded-md p-2 text-sm" value="${today}"></div>
                    </div>`;

                detailSectionHtml = `
                    <hr class="my-4 border-gray-200">
                    <h3 class="text-md font-bold text-gray-700 mb-2">明細內容</h3>
                    <div id="items-container" class="space-y-3 mb-4"></div>

                    <div class="flex gap-3 mb-6">
                        <button onclick="addRow('category')" class="flex-1 py-2 px-4 border border-gray-300 bg-gray-50 text-gray-700 font-bold rounded hover:bg-gray-100">+ 大項次</button>
                        <button onclick="addRow('item')" class="flex-1 py-2 px-4 border border-${color}-300 bg-${color}-50 text-${color}-700 font-bold rounded hover:bg-${color}-100">+ 細項</button>
                    </div>

                    <div class="mb-4 bg-yellow-50 p-4 rounded border border-yellow-200">
                        <label class="block text-sm font-bold text-gray-700 mb-2">額外費用</label>
                        <div id="fees-container" class="space-y-2 mb-3"></div>
                        <button onclick="addFeeRow()" class="text-sm bg-white border border-yellow-400 text-yellow-700 px-3 py-1 rounded hover:bg-yellow-100">+ 新增費用</button>
                    </div>`;

                // --- 成本系統特有 UI (鎖定與專案選擇) ---
            } else if (systemType === 'cost') {
                // 成本系統不需要 loadQuoteForEdit (除非也要做修正成本單，這邊先針對新建處理)
                // 但若要修改成本單，邏輯類似。這裡先實作「建立新成本單」需選專案
                extraHtml = `
                 ${internalInfoHtml}
                 <div class="mb-4 bg-green-50 p-3 rounded border border-green-200">
                    <label class="font-bold text-green-900 text-sm block mb-1">1. 選擇來源專案 (報價單)：</label>
                    <select id="projectSelect" onchange="fillProjectInfo(this.value)" class="w-full border border-green-300 rounded p-2 text-sm">
                        <option value="">-- 請選擇專案 --</option>
                        ${projectList.map(p => `<option value="${p.id}" data-cust="${p.customer}" data-proj="${p.project}" data-sales="${p.sales || ''}">${p.date} ${p.customer} - ${p.project}</option>`).join('')}
                    </select>
                 </div>`;

                basicInfoHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <!-- 來源資料 (唯讀) -->
                        <div class="md:col-span-2 bg-gray-100 p-3 rounded-md border border-gray-200">
                            <p class="text-xs text-gray-500 font-bold mb-2 border-b pb-1">專案基本資料 (鎖定)</p>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs text-gray-500 mb-1">客戶名稱</label><input type="text" id="customer" class="w-full bg-gray-200 border border-gray-300 rounded p-2 text-sm" readonly></div>
                                <div><label class="block text-xs text-gray-500 mb-1">專案名稱</label><input type="text" id="projectName" class="w-full bg-gray-200 border border-gray-300 rounded p-2 text-sm" readonly></div>
                            </div>
                        </div>

                        <!-- 廠商資料 (輸入) -->
                        <div class="md:col-span-2 bg-green-50 p-3 rounded-md border border-green-200 relative">
                             <div class="absolute top-0 left-0 bg-green-600 text-white text-xs px-2 py-1 rounded-br">廠商資訊</div>
                             <div class="mt-4 grid grid-cols-2 gap-4">
                                <div class="col-span-2">
                                    <label class="block text-sm font-bold text-gray-700 mb-1">廠商統編/名稱</label>
                                    <div class="flex gap-2 items-center">
                                        <div class="w-1/3 relative">
                                            <input type="text" id="vendorTaxId" class="w-full border border-gray-300 rounded p-2 text-sm" placeholder="統編" oninput="checkTaxId(this); lookupVendor()">
                                            <span id="tax-warning-vendor" class="hidden absolute top-full left-0 text-[10px] text-red-500 font-bold">請輸入8碼數字</span>
                                        </div>
                                        <input type="text" id="vendorName" list="vendor-list" class="flex-1 border border-gray-300 rounded p-2 text-sm" placeholder="廠商名稱 (可新增)" onchange="saveConfig('vendor', this.value)">
                                    </div>
                                </div>
                                <!-- 金額與發票 -->
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">未稅金額</label>
                                    <input type="number" id="costAmountNoTax" class="w-full border border-gray-300 rounded p-2 text-sm font-bold" placeholder="0" oninput="calculateCostTotal()">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-blue-700 mb-1">含稅總計 (自動)</label>
                                    <input type="number" id="costAmountTax" class="w-full bg-blue-50 border border-blue-300 rounded p-2 text-sm font-bold" readonly>
                                </div>
                                <div class="col-span-2 grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-1">發票號碼</label>
                                        <input type="text" id="invoiceNo" class="w-full border border-gray-300 rounded p-2 text-sm" placeholder="AB-12345678">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-1">發票憑證</label>
                                        <input type="file" id="invoiceFile" accept="image/*" class="w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-green-100 file:text-green-700">
                                    </div>
                                </div>
                             </div>
                        </div>

                        <!-- 人員設定 (業務鎖定、工務採購共用選單) -->
                        <div class="md:col-span-2 grid grid-cols-3 gap-2 bg-yellow-50 p-2 rounded border border-yellow-200">
                             <div><label class="block text-xs font-bold text-gray-600">業務人員 (鎖定)</label><input type="text" id="costSalesPerson" class="w-full border p-1 text-sm rounded bg-gray-100" readonly></div>
                             <div><label class="block text-xs font-bold text-gray-600">工務人員</label><input type="text" id="workerPerson" list="sales-list" class="w-full border p-1 text-sm rounded bg-white" onchange="saveConfig('sales', this.value)"></div>
                             <div><label class="block text-xs font-bold text-gray-600">採購人員</label><input type="text" id="buyerPerson" list="sales-list" class="w-full border p-1 text-sm rounded bg-white" onchange="saveConfig('sales', this.value)"></div>
                        </div>

                        <!-- 隱藏日期 (預設今日) -->
                        <input type="hidden" id="quoteDate" value="${today}">
                    </div>`;

                // 支出內容 (僅保留摘要)
                detailSectionHtml = `
                 <div class="bg-white p-4 rounded border border-green-300 shadow-sm mt-4">
                     <div class="mb-3">
                         <label class="block text-sm font-bold text-gray-700 mb-1">支出摘要</label>
                         <input type="text" id="costSummary" class="w-full border border-gray-300 rounded p-2 text-lg" placeholder="例如：水電材料費">
                     </div>
                 </div>`;
            } else {
                // 會計系統維持原樣 (暫簡化)
                extraHtml = internalInfoHtml;
                basicInfoHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="md:col-span-2 bg-orange-50 p-3 rounded-md border border-orange-100">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                客戶/廠商名稱
                                <span class="text-xs text-orange-500 font-normal ml-2">(公司戶請輸入統編即可自動帶入)</span>
                            </label>
                            <div class="flex gap-2 mb-2 items-center">
                                <div class="w-1/3 relative">
                                    <input type="text" id="taxId" class="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="統編(選填)" oninput="checkTaxId(this)">
                                    <span id="tax-warning" class="hidden absolute top-full left-0 text-[10px] text-red-500 font-bold">請輸入8碼數字</span>
                                </div>
                                <button onclick="lookupCompany()" class="bg-orange-600 text-white px-3 py-1 rounded-md text-xs h-9 hover:bg-orange-700">查詢</button>
                                <input type="text" id="customer" class="flex-1 border border-gray-300 rounded-md p-2" placeholder="輸入名稱" oninput="loadHistory('${systemType}')">
                            </div>
                            <div id="history-area" class="mt-2 hidden">
                                <p class="text-xs text-gray-500 mb-1 font-bold">歷史紀錄 (${titles[systemType]})：</p>
                                <ul id="history-list" class="text-xs text-gray-600 bg-white border border-gray-200 rounded max-h-24 overflow-y-auto p-1"></ul>
                            </div>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">聯絡人</label><input type="text" id="contactPerson" class="w-full border border-gray-300 rounded-md p-2 text-sm"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">連絡電話</label><input type="text" id="contactPhone" class="w-full border border-gray-300 rounded-md p-2 text-sm"></div>

                        <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">工程/項目名稱</label><input type="text" id="projectName" class="w-full border border-gray-300 rounded-md p-2 text-sm"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">日期</label><input type="date" id="quoteDate" class="w-full border border-gray-300 rounded-md p-2 text-sm" value="${today}"></div>
                    </div>`;

                detailSectionHtml = `
                    <hr class="my-4 border-gray-200">
                    <h3 class="text-md font-bold text-gray-700 mb-2">明細內容</h3>
                    <div id="items-container" class="space-y-3 mb-4"></div>

                    <div class="flex gap-3 mb-6">
                        <button onclick="addRow('category')" class="flex-1 py-2 px-4 border border-gray-300 bg-gray-50 text-gray-700 font-bold rounded hover:bg-gray-100">+ 大項次</button>
                        <button onclick="addRow('item')" class="flex-1 py-2 px-4 border border-${color}-300 bg-${color}-50 text-${color}-700 font-bold rounded hover:bg-${color}-100">+ 細項</button>
                    </div>

                    <div class="mb-4 bg-yellow-50 p-4 rounded border border-yellow-200">
                        <label class="block text-sm font-bold text-gray-700 mb-2">額外費用</label>
                        <div id="fees-container" class="space-y-2 mb-3"></div>
                        <button onclick="addFeeRow()" class="text-sm bg-white border border-yellow-400 text-yellow-700 px-3 py-1 rounded hover:bg-yellow-100">+ 新增費用</button>
                    </div>`;
            }

            // --- 決定是否顯示賣方資料 ---
            // User: "專案成本頁面不需要賣方資料"
            const sellerInfoSection = (systemType === 'cost') ? '' : `
                    <div class="mb-6 bg-gray-50 p-4 rounded border border-gray-200">
                         <h3 class="text-sm font-bold text-gray-700 mb-3">賣方資料 (固定)</h3>
                         <input type="text" id="sellerName" class="w-full border border-gray-300 rounded p-2 text-sm mb-2" value="健益工程有限公司" readonly>
                    </div>`;

            const html = `
            <div class="max-w-3xl mx-auto">
                <div class="flex items-center mb-4">
                    <button onclick="navigateTo('page-home')" class="mr-3 px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm font-bold flex items-center">
                        <i class="fa-solid fa-arrow-left mr-2"></i> 回首頁
                    </button>
                    <h2 class="text-xl font-bold text-gray-800">${titles[systemType]}</h2>
                </div>

                ${extraHtml}

                <div class="bg-white rounded-lg shadow-md p-6 mb-6 border-t-4 border-${color}-500">
                    ${sellerInfoSection}
                    ${basicInfoHtml}
                    ${detailSectionHtml}

                    <div class="mb-6 flex items-center bg-gray-50 p-3 rounded border border-gray-200">
                        <input type="checkbox" id="needTax" class="w-5 h-5 text-blue-600 rounded" checked onchange="calculateCostTotal()">
                        <label for="needTax" class="ml-2 block text-sm font-bold text-gray-700 cursor-pointer">加計 5% 營業稅 (含稅金額自動計算)</label>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">備註</label>
                        <textarea id="footerNote" rows="3" class="w-full border border-gray-300 rounded-md p-2 text-sm">${systemType === 'quotation' ? '1. 本報價單有效期限為 15 天。\n2. 付款方式：訂金 30%，完工驗收後付清尾款。' : ''}</textarea>
                    </div>

                    <button onclick="generatePreview('${titles[systemType]}')" class="w-full py-3 px-4 text-lg font-bold rounded-md text-white bg-${color}-600 hover:bg-${color}-700 shadow-lg">確認並儲存</button>
                </div>
            </div>`;

            const target = document.getElementById(containerId);
            if (target) {
                target.innerHTML = html;
                // 重置
                currentOriginId = null;
            }
        }

        // --- 報價系統：載入資料 ---
        function loadQuoteForEdit(orderId) {
            const project = projectList.find(p => p.id === orderId);
            if (!project) {
                // 如果選擇了 "-- 選擇單號以載入 --" 或找不到，則重置表單
                document.getElementById('edit-mode-badge').classList.add('hidden');
                currentOriginId = null;
                // 清空表單 (簡化處理，實際應重繪或逐一清空)
                renderUI('app-container', 'quotation');
                return;
            }

            // 標記為修改模式
            currentOriginId = project.id.split('-').slice(0, 2).join('-'); // 取得原始 ID (移除版本號)
            document.getElementById('edit-mode-badge').classList.remove('hidden');

            // 填入資料 (簡易版，若要完整需解析 project.json)
            document.getElementById('customer').value = project.customer;
            document.getElementById('projectName').value = project.project;
            document.getElementById('quoteDate').value = project.date; // 填入日期
            if (project.json) {
                try {
                    const data = JSON.parse(project.json);
                    // 填入明細... 這裡需實作還原 items-container 邏輯
                    // 為求時效，本次先實作「填入基本資料」與「標記修改ID」
                    document.getElementById('taxId').value = data.taxId || '';
                    document.getElementById('contactPerson').value = data.contactPerson || '';
                    document.getElementById('contactPhone').value = data.contactPhone || '';
                    document.getElementById('internalProjectId').value = data.internalProjectId || '';
                    document.getElementById('salesPerson').value = data.salesPerson || '';
                    document.getElementById('footerNote').value = data.note || '';
                    document.getElementById('sellerContact').value = data.sellerContact || '';
                    document.getElementById('needTax').checked = data.needTax === true;

                    // 清空現有項目
                    document.getElementById('items-container').innerHTML = '';
                    // 還原項目
                    if (data.items) {
                        data.items.forEach(item => {
                            if (item.type === 'category') {
                                // 模擬新增大項次
                                addRow('category');
                                const rows = document.querySelectorAll('.item-row');
                                rows[rows.length - 1].querySelector('.input-category').value = item.category;
                            } else {
                                // 模擬新增細項
                                addRow('item');
                                const rows = document.querySelectorAll('.item-row');
                                const row = rows[rows.length - 1];
                                row.querySelector('.input-name').value = item.name;
                                row.querySelector('.input-qty').value = item.qty;
                                row.querySelector('.input-price').value = item.price;
                                row.querySelector('.input-remark').value = item.remark || '';
                                // 單位還原略為複雜，暫設 custom
                                const unitSelect = row.querySelector('.input-unit-select');
                                const unitCustom = row.querySelector('.input-unit-custom');
                                if (unitOptions.includes(item.unit)) {
                                    unitSelect.value = item.unit;
                                    unitSelect.classList.remove('hidden');
                                    unitCustom.classList.add('hidden');
                                } else {
                                    unitSelect.value = 'custom';
                                    unitSelect.classList.add('hidden');
                                    unitCustom.classList.remove('hidden');
                                    unitCustom.value = item.unit;
                                }
                            }
                        });
                    }
                    // 清空現有額外費用
                    document.getElementById('fees-container').innerHTML = '';
                    // 還原額外費用
                    if (data.additionalFees) {
                        data.additionalFees.forEach(fee => {
                            addFeeRow();
                            const feeRows = document.querySelectorAll('.fee-row');
                            const lastFeeRow = feeRows[feeRows.length - 1];
                            lastFeeRow.querySelector('.fee-name').value = fee.name;
                            lastFeeRow.querySelector('.fee-type').value = fee.type;
                            lastFeeRow.querySelector('.fee-value').value = fee.val;
                        });
                    }

                } catch (e) { console.error("Parse JSON failed", e); }
            }
        }

        // --- Cost 專用邏輯 ---
        function fillProjectInfo(projId) {
            if (!projId) {
                document.getElementById('customer').value = '';
                document.getElementById('projectName').value = '';
                if (document.getElementById('originalQuoteId')) {
                    document.getElementById('originalQuoteId').value = '';
                }
                const salesInput = document.getElementById('costSalesPerson');
                if (salesInput) salesInput.value = '';
                return;
            }
            // 透過 DOM 選項取得 data attribute (因為 projectList 可能未含 sales 若後端沒更新，但我們已更新後端)
            // 也可以直接查 projectList
            const proj = projectList.find(p => p.id === projId);
            if (proj) {
                document.getElementById('customer').value = proj.customer;
                document.getElementById('projectName').value = proj.project;
                // 自動帶入業務人員並鎖定
                const salesInput = document.getElementById('costSalesPerson');
                if (salesInput) {
                    salesInput.value = proj.sales || '';
                    // 再次確保鎖定 (renderUI 已設 readonly 但防萬一)
                    salesInput.readOnly = true;
                }
                // 設置一個隱藏欄位來儲存原始報價單ID，以便成本單關聯
                if (!document.getElementById('originalQuoteId')) {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.id = 'originalQuoteId';
                    document.getElementById('cost-container').appendChild(hiddenInput);
                }
                document.getElementById('originalQuoteId').value = proj.id;
            }
        }

        function calculateCostTotal() {
            if (currentSystem !== 'cost') return;

            const noTaxInput = document.getElementById('costAmountNoTax');
            const taxTotalInput = document.getElementById('costAmountTax'); // 這是含稅總計
            const needTaxCheckbox = document.getElementById('needTax');

            const amount = parseInt(noTaxInput?.value) || 0;
            const needTax = needTaxCheckbox?.checked || false;

            const tax = needTax ? Math.round(amount * 0.05) : 0;
            const total = amount + tax;

            if (taxTotalInput) taxTotalInput.value = total;

            // 由於 generatePreview 也會再算一次，這裡主要是即時 UI 回饋
        }

        // --- 成本系統：廠商統編查詢 ---
        async function lookupVendor() {
            const taxId = document.getElementById('vendorTaxId').value.trim();
            const nameInput = document.getElementById('vendorName');
            if (taxId.length === 8) {
                nameInput.placeholder = "查詢中...";
                try {
                    const response = await fetch(`https://data.gcis.nat.gov.tw/od/data/api/9D17AE0D-09B5-4432-A8F4-81B43F75F718?$format=json&$filter=Business_Accounting_NO eq ${taxId}&$skip=0&$top=1`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data && data.length > 0) nameInput.value = data[0].Company_Name;
                        else nameInput.value = ""; // Clear if not found
                    } else {
                        nameInput.value = "";
                    }
                } catch (e) {
                    console.error("Vendor lookup failed", e);
                    nameInput.value = "";
                } finally {
                    nameInput.placeholder = "廠商名稱";
                }
            } else {
                nameInput.value = "";
            }
        }

        // 輔助: File to Base64
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // --- 歷史紀錄功能 ---
        function getHistory(type) {
            const key = type + '_history_v1';
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        }

        function saveToHistory(type, data) {
            const key = type + '_history_v1';
            let history = getHistory(type);
            history.unshift(data);
            if (history.length > 100) history = history.slice(0, 100);
            localStorage.setItem(key, JSON.stringify(history));
        }

        function loadHistory(type) {
            const customerName = document.getElementById('customer').value.trim();
            const historyArea = document.getElementById('history-area');
            const historyList = document.getElementById('history-list');
            if (!customerName || !historyArea) {
                if (historyArea) historyArea.classList.add('hidden');
                return;
            }

            const history = getHistory(type);
            const records = history.filter(q => q.customer === customerName);

            if (records.length > 0) {
                let html = '';
                records.forEach(q => {
                    html += `<li class="border-b border-gray-100 py-1 hover:bg-gray-50 flex justify-between"><span>${q.project || '(無工程名)'}</span><span class="font-bold">$${q.subtotalNoTax.toLocaleString()}</span></li>`;
                });
                historyList.innerHTML = html;
                historyArea.classList.remove('hidden');
            } else {
                historyArea.classList.add('hidden');
            }
        }

        function checkItemHistory(inputEl) {
            // 目前僅為 Placeholder，若需實作細項歷史查詢可在此擴充
        }

        // --- 統編查詢 ---
        async function lookupCompany() {
            const taxId = document.getElementById('taxId').value.trim();
            const nameInput = document.getElementById('customer');
            if (taxId.length !== 8) {
                alert("請輸入正確的 8 碼統一編號");
                return;
            }
            nameInput.placeholder = "查詢中...";
            try {
                const response = await fetch(`https://data.gcis.nat.gov.tw/od/data/api/9D17AE0D-09B5-4432-A8F4-81B43F75F718?$format=json&$filter=Business_Accounting_NO eq ${taxId}&$skip=0&$top=1`);
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        nameInput.value = data[0].Company_Name;
                        loadHistory(currentSystem);
                    } else alert("查無此統編資料，請手動輸入名稱。");
                } else throw new Error("API Error");
            } catch (e) {
                console.log("Auto lookup failed.", e);
                if (nameInput.value === "") nameInput.placeholder = "無法自動取得，請手動輸入";
            }
        }

        // --- 表格列操作 ---
        function toggleUnit(el) {
            if (el.value === 'custom') { el.classList.add('hidden'); el.nextElementSibling.classList.remove('hidden'); el.nextElementSibling.focus(); }
        }
        function resetUnit(btn) {
            /* 預留重置功能 */
        }

        function addRow(type) {
            const container = document.getElementById('items-container');
            const rowId = 'row-' + Date.now();
            let html = '';

            if (type === 'category') {
                html = `<div id="${rowId}" class="item-row bg-gray-50 p-3 rounded border border-gray-300 relative mb-2 border-l-4 border-l-gray-500">
                    <input type="hidden" class="row-type" value="category">
                    <button onclick="this.parentElement.remove()" class="absolute top-1 right-1 text-gray-400 hover:text-red-500">✕</button>
                    <label class="text-xs font-bold text-gray-600">大項次名稱</label>
                    <input type="text" class="input-category w-full border border-gray-300 rounded p-1 font-bold" placeholder="分類名稱">
                </div>`;
            } else {
                let optionsHtml = unitOptions.map(u => `<option value="${u}">${u}</option>`).join('');
                optionsHtml += `<option value="custom">自訂</option>`;
                html = `<div id="${rowId}" class="item-row bg-white p-3 rounded border border-gray-200 relative mb-2 ml-4 border-l-4 border-l-blue-300">
                    <input type="hidden" class="row-type" value="item">
                    <button onclick="this.parentElement.remove()" class="absolute top-1 right-1 text-gray-400 hover:text-red-500">✕</button>
                    <div class="grid grid-cols-12 gap-2">
                        <div class="col-span-12 md:col-span-6"><label class="text-xs text-gray-500">項目名稱</label><input type="text" class="input-name w-full border border-gray-300 rounded p-1" placeholder="品項" oninput="checkItemHistory(this)"></div>
                        <div class="col-span-4 md:col-span-2"><label class="text-xs text-gray-500">數量</label><input type="number" class="input-qty w-full border border-gray-300 rounded p-1 text-center" value="1" onchange="checkQty(this)"></div>
                        <div class="col-span-4 md:col-span-2"><label class="text-xs text-gray-500">單位</label>
                            <select class="input-unit-select w-full border p-1" onchange="toggleUnit(this)">${optionsHtml}</select>
                            <input type="text" class="input-unit-custom w-full border p-1 hidden" placeholder="輸入" onchange="saveUnit(this.value)">
                        </div>
                        <div class="col-span-4 md:col-span-2"><label class="text-xs text-gray-500">單價</label><input type="number" class="input-price w-full border p-1 text-right" placeholder="0" onchange="checkPrice(this)"></div>
                        <div class="col-span-12"><label class="text-xs text-gray-500">備註</label><input type="text" class="input-remark w-full border p-1" placeholder="..."></div>
                    </div>
                </div>`;
            }
            container.insertAdjacentHTML('beforeend', html);
        }

        function addFeeRow() {
            const html = `<div class="fee-row flex gap-2 items-center bg-white p-2 rounded border border-gray-200 mb-1">
                <input type="text" class="fee-name w-1/2 border p-1 text-sm" placeholder="費用名稱">
                <select class="fee-type border p-1 text-sm"><option value="percent">%</option><option value="amount">$</option></select>
                <input type="number" class="fee-value w-full border p-1 text-sm text-right" placeholder="數值">
                <button onclick="this.parentElement.remove()" class="text-red-500 font-bold px-2">✕</button>
            </div>`;
            document.getElementById('fees-container').insertAdjacentHTML('beforeend', html);
        }

        // --- [修改] 資料收集與預覽 ---
        async function generatePreview(title) {
            // 基本驗證
            const requiredFields = (currentSystem === 'cost')
                ? ['projectName', 'costAmount', 'customer', 'vendorName']
                : ['customer', 'projectName', 'quoteDate']; // 報價單必填

            for (let id of requiredFields) {
                const el = document.getElementById(id);
                if (!el || !el.value.trim()) {
                    alert(`請確認必填欄位：${id} 未填寫`);
                    return;
                }
            }

            // 額外驗證：成本單金額
            if (currentSystem === 'cost') {
                const costAmount = parseInt(document.getElementById('costAmount').value) || 0;
                if (costAmount <= 0) {
                    alert('成本金額必須大於 0');
                    return;
                }
            }

            // 收集資料
            const basicData = collectFormBasicData();
            let itemsData = [];
            let feesData = [];
            let subtotal = 0;
            let tax = 0;
            let total = 0;

            if (currentSystem === 'cost') {
                // Cost 系統：讀取單一輸入
                const summary = document.getElementById('costSummary').value || '支出';
                const amount = parseInt(document.getElementById('costAmount').value) || 0;

                // 為了相容報價單格式，轉為單一項目陣列 (或後端只需總額)
                itemsData = [{
                    name: summary,
                    qty: 1,
                    unit: '式',
                    price: amount,
                    subtotal: amount
                }];
                subtotal = amount;

            } else {
                // Quotation 系統：讀取表格
                itemsData = collectTableData('item');
                feesData = collectTableData('fee');

                const itemsTotal = itemsData.reduce((sum, item) => sum + item.subtotal, 0);
                const feesTotal = feesData.reduce((sum, fee) => sum + fee.amount, 0);
                subtotal = itemsTotal + feesTotal;
            }

            // 稅金計算
            const needTax = document.getElementById('needTax').checked;
            const newOrderId = `${prefix}-${dateStr}-${random}`;

            const displayId = currentOriginId ? `${currentOriginId} (修)` : newOrderId;

            // 儲存資料物件
            window.tempSubmitData = {
                type: currentSystem,
                originId: currentOriginId,
                lineUser: liffUser,

                orderId: currentOriginId || newOrderId,
                date, customer, project, sellerName, sellerContact,
                contact, phone, taxId,
                internalProjectId, salesPerson,

                vendorName, vendorTaxId, invoiceNo, workerPerson, buyerPerson, invoiceImage: invoiceBase64,

                items: itemsData, fees: feesData,
                subtotalNoTax, taxAmount, grandTotal, note,
                needTax: needTax
            };

            // 生成預覽 HTML
            let headerInfoGrid = '';
            if (currentSystem === 'cost') {
                headerInfoGrid = `
                <div class="grid grid-cols-2 gap-4 text-sm mb-4 border-b pb-4">
                    <div>
                        <p><span class="text-gray-500">日期：</span>${date}</p>
                        <p><span class="text-gray-500">來源專案：</span>${project}</p>
                        <p><span class="text-gray-500">客戶名稱：</span>${customer}</p>
                    </div>
                    <div class="text-right">
                        <p><span class="text-gray-500">單號：</span>${displayId}</p>
                        <p><span class="text-gray-500">廠商：</span>${vendorName} (${vendorTaxId})</p>
                        <p><span class="text-gray-500">發票：</span>${invoiceNo}</p>
                    </div>
                </div>
                <div class="flex justify-between text-xs text-gray-500 mb-2">
                    <span>業務: ${salesPerson}</span>
                    <span>工務: ${workerPerson}</span>
                    <span>採購: ${buyerPerson}</span>
                </div>`;
            } else {
                headerInfoGrid = `
                <div class="grid grid-cols-2 gap-4 text-sm mb-4 border-b pb-4">
                    <div>
                        <h4 class="font-bold text-lg mb-1">${customer}</h4>
                        ${taxId ? `<p class="text-gray-600">統編：${taxId}</p>` : ''}
                        ${contact ? `<p class="text-gray-600">聯絡人：${contact} ${phone ? `(${phone})` : ''}</p>` : ''}
                    </div>
                    <div class="text-right">
                        <p><span class="text-gray-500">日期：</span>${date}</p>
                        <p><span class="text-gray-500">單號：</span>${displayId}</p>
                        <p><span class="text-gray-500">專案：</span>${project}</p>
                        <p class="text-xs text-gray-400 mt-1">ID: ${internalProjectId}</p>
                    </div>
                </div>`;
            }

            let tableRows = itemsData.map(item => {
                if (item.type === 'category') {
                    return `<tr class="bg-gray-100"><td colspan="5" class="p-2 font-bold text-left pl-4">${item.category}</td></tr>`;
                }
                return `
                <tr class="border-b border-gray-100">
                    <td class="p-2 text-left">${item.name}<div class="text-xs text-gray-400">${item.remark}</div></td>
                    <td class="p-2 text-center text-gray-600">${item.qty}</td>
                    <td class="p-2 text-center text-gray-600">${item.unit}</td>
                    <td class="p-2 text-right text-gray-600">$${item.price.toLocaleString()}</td>
                    <td class="p-2 text-right font-medium">$${item.amount.toLocaleString()}</td>
                </tr>`;
            }).join('');

            let totalHtml = `
                <div class="w-1/2 ml-auto">
                    <div class="flex justify-between py-1 text-gray-600"><span>小計</span><span>$${subtotalNoTax.toLocaleString()}</span></div>
                    ${feesData.map(f => `<div class="flex justify-between py-1 text-red-500 text-sm"><span>${f.name}</span><span>$${f.amount.toLocaleString()}</span></div>`).join('')}
                    ${needTax ? `<div class="flex justify-between py-1 text-gray-600"><span>稅金 (5%)</span><span>$${taxAmount.toLocaleString()}</span></div>` : ''}
                    <div class="flex justify-between py-2 border-t border-gray-300 font-bold text-xl mt-2">
                        <span>總計</span>
                        <span class="text-blue-600">$${grandTotal.toLocaleString()}</span>
                    </div>
                </div>`;

            const previewHtml = `
            <div id="preview-capture" class="bg-white p-8 max-w-2xl mx-auto border border-gray-200 shadow-lg">
                <div class="text-center mb-6 border-b-2 border-gray-800 pb-4">
                     <div class="flex justify-center items-center gap-4 mb-2">
                         ${userLogoData ? `<img src="${userLogoData}" class="h-12 object-contain">` : ''}
                         <h2 class="text-3xl font-bold tracking-widest text-gray-800">${title}</h2>
                     </div>
                     <p class="text-sm text-gray-600">${sellerName} / ${sellerContact}</p>
                </div>
                
                ${headerInfoGrid}

                <table class="w-full mb-6">
                    <thead class="bg-gray-50 border-b-2 border-gray-200">
                        <tr>
                            <th class="p-2 text-left w-5/12 text-sm text-gray-600">項目</th>
                            <th class="p-2 text-center w-2 text-sm text-gray-600">數</th>
                            <th class="p-2 text-center w-2 text-sm text-gray-600">單位</th>
                            <th class="p-2 text-right w-2/12 text-sm text-gray-600">單價</th>
                            <th class="p-2 text-right w-2/12 text-sm text-gray-600">金額</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
                
                <div class="flex justify-end mb-6">${totalHtml}</div>
                
                <div class="text-sm text-gray-500 border-t pt-4 mt-4">
                    <p class="font-bold mb-1">備註：</p>
                    <pre class="whitespace-pre-wrap font-sans">${note}</pre>
                </div>
            </div>
            
            <div class="mt-6 flex gap-4">
                <button onclick="document.getElementById('preview-modal').classList.add('hidden')" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded font-bold">返回修改</button>
                <button onclick="submitData()" class="flex-1 bg-green-600 text-white py-3 rounded font-bold shadow-lg status-btn">
                   <span class="normal-text">確認上傳並存檔</span>
                   <span class="loading-text hidden"><i class="fa-solid fa-spinner fa-spin"></i> 上傳中...</span>
                </button>
                <button onclick="downloadImage('${newOrderId}')" class="bg-blue-500 text-white px-4 rounded font-bold"><i class="fa-solid fa-download"></i></button>
            </div>
            `;

            document.getElementById('preview-content').innerHTML = previewHtml;
            document.getElementById('preview-modal').classList.remove('hidden');

            // 儲存新項目至歷史紀錄
            if (itemsData.length > 0) saveNewItemsToHistory(itemsData);
        }

        // --- 上傳並存檔 ---
        function submitData() {
            if (!GAS_URL || GAS_URL === '您的_GAS_WEB_APP_URL') {
                alert("未設定 GAS URL，無法上傳");
                return;
            }
            if (!window.tempSubmitData) return;

            const btn = document.querySelector('.status-btn');
            btn.disabled = true;
            btn.querySelector('.normal-text').classList.add('hidden');
            btn.querySelector('.loading-text').classList.remove('hidden');

            const element = document.getElementById('preview-capture');
            const data = window.tempSubmitData;

            // 截圖
            html2canvas(element, {
                scale: 1.5,
                useCORS: true,
                backgroundColor: '#ffffff',
                logging: false
            }).then(canvas => {
                const imageBase64 = canvas.toDataURL('image/jpeg', 0.8);
                const folderName = data.type === 'quotation' ? '報價資料' : (data.type === 'cost' ? '成本資料' : '會計資料');

                const payload = {
                    ...data,
                    folder: folderName,
                    image: imageBase64
                };

                // POST 到 GAS
                fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    mode: 'no-cors'
                }).then(() => {
                    alert("上傳成功！");
                    document.getElementById('preview-modal').classList.add('hidden');
                    // 可選擇是否重置表單，或保留讓使用者繼續操作
                    // location.reload(); 
                }).catch(e => {
                    console.error(e);
                    alert("上傳失敗：" + e);
                }).finally(() => {
                    btn.disabled = false;
                    btn.querySelector('.normal-text').classList.remove('hidden');
                    btn.querySelector('.loading-text').classList.add('hidden');
                });
            });
        }

        // --- 修正版下載圖片函式 ---
        function downloadImage(filenameRaw) {
            const element = document.getElementById('preview-capture');
            // 檔名加上系統名稱與客戶
            const customer = window.tempSubmitData?.customer || 'Client';
            const project = window.tempSubmitData?.project || 'Project';
            const date = window.tempSubmitData?.date || '';
            const filename = `${date}_${customer}_${project}.jpg`;

            html2canvas(element, { scale: 2, useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
            });
        }

        // --- 下載 JPG (檔名格式：日期_客戶_專案.jpg) ---
        function downloadJPG() {
            const element = document.getElementById('quotation-canvas');
            const btn = document.getElementById('btn-download');
            const originalText = btn.innerText;
            btn.innerText = '處理中...';
            btn.disabled = true;

            const date = document.getElementById('disp-date').innerText;
            const customer = document.getElementById('disp-customer').innerText;
            const project = document.getElementById('disp-project').innerText || '專案';
            // 設定檔案名稱
            const filename = `${date}_${customer}_${project}.jpg`;

            const options = { scale: 2, useCORS: true, backgroundColor: '#ffffff', logging: false, windowWidth: element.scrollWidth, windowHeight: element.scrollHeight };

            setTimeout(() => {
                html2canvas(element, options).then(canvas => {
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                    btn.innerText = originalText;
                    btn.disabled = false;
                }).catch(err => {
                    console.error(err);
                    alert("生成失敗");
                    btn.innerText = originalText;
                    btn.disabled = false;
                });
            }, 300);
        }

        function closePreview() { document.getElementById('preview-section').classList.add('hidden'); loadHistory(currentSystem); }
        function toChineseNum(num) {
            if (!/^\d*(\.\d*)?$/.test(num)) return "Number is wrong!";
            var AA = ["零", "壹", "貳", "參", "肆", "伍", "陸", "柒", "捌", "玖"], BB = ["", "拾", "佰", "仟", "萬", "億", "兆", "京"];
            var a = ("" + num).replace(/(^0*)/g, "").split("."), k = 0, re = "";
            for (var i = a[0].length - 1; i >= 0; i--) {
                switch (k) { case 0: re = BB[7] + re; break; case 4: if (!new RegExp("0{4}\\d{" + (a[0].length - i - 1) + "}$").test(a[0])) re = BB[4] + re; break; case 8: re = BB[5] + re; break; }
                if (k % 4 == 2 && a[0].charAt(i + 2) != 0 && a[0].charAt(i + 1) == 0) re = AA[0] + re;
                if (a[0].charAt(i) != 0) re = AA[a[0].charAt(i)] + BB[k % 4] + re; k++;
            }
            if (a.length > 1) { re += "點"; for (var i = 0; i < a[1].length; i++) re += AA[a[1].charAt(i)]; }
            return (re == '' ? '零元整' : re + "元整");
        }
    </script>
</body>

</html>
