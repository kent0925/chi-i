<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工程管理整合系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 預覽畫布樣式 */
        .preview-canvas {
            font-family: 'DFKai-SB', 'BiauKai', '標楷體', 'Noto Serif TC', serif;
            background-color: white;
            color: black;
            line-height: 1.3;
        }

        .company-title {
            font-size: 20pt;
            font-weight: bold;
            text-align: center;
        }

        .doc-title {
            font-size: 16pt;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        /* 表格樣式 */
        .info-table,
        .items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12pt;
        }

        .info-table td {
            border: 1px solid #000;
            padding: 4px 8px;
        }

        .items-table th {
            border: 1px solid #000;
            border-bottom: 2px solid #000;
            padding: 4px;
            text-align: center;
            font-weight: normal;
        }

        .items-table td {
            border: 1px solid #000;
            padding: 4px;
        }

        .summary-row {
            display: flex;
            justify-content: flex-end;
            font-size: 12pt;
            padding: 2px 0;
        }

        .summary-label {
            text-align: right;
            padding-right: 10px;
            width: 150px;
        }

        .summary-value {
            text-align: right;
            width: 120px;
            padding-right: 4px;
        }

        .history-hint {
            font-size: 0.75rem;
            color: #d97706;
            margin-top: 2px;
            font-family: 'Noto Sans TC', sans-serif;
        }

        @media print {
            .no-print {
                display: none;
            }
        }

        .page-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .page-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 驗證視窗樣式 */
        #auth-modal {
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">

    <!-- ================= 0. 驗證視窗 (新增) ================= -->
    <div id="auth-modal" class="fixed inset-0 z-[100] flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <div class="mb-4 text-blue-900">
                <i class="fa-solid fa-shield-halved text-5xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">系統存取驗證</h2>
            <p class="text-gray-500 text-sm mb-6">請輸入存取金鑰 (Token) 以繼續</p>

            <input type="password" id="auth-token-input"
                class="w-full border border-gray-300 rounded-lg p-3 text-center mb-4 focus:ring-2 focus:ring-blue-500 outline-none"
                placeholder="輸入 Token">

            <button onclick="submitAuth()"
                class="w-full bg-blue-900 text-white font-bold py-3 rounded-lg hover:bg-blue-800 transition">
                驗證登入
            </button>
            <p id="auth-error" class="text-red-500 text-xs mt-3 hidden">請輸入 Token</p>
        </div>
    </div>

    <!-- ================= 1. 首頁 (主選單) ================= -->
    <div id="page-home" class="page-section active p-4 max-w-md mx-auto">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
            <div class="bg-blue-900 p-6 text-center relative">
                <h1 class="text-2xl font-bold text-white tracking-wider">工程管理整合系統</h1>
                <p class="text-blue-200 text-sm mt-2">健益工程有限公司</p>
                <!-- 使用者資訊區 (取代原登出按鈕) -->
                <div id="header-user-info" class="absolute top-4 right-4 text-blue-200 hover:text-white text-xs">
                    <!-- JS 載入後顯示 -->
                </div>
            </div>
            <div class="p-6 grid gap-4">
                <button onclick="navigateTo('page-quotation')"
                    class="flex items-center p-4 bg-white border-2 border-blue-100 rounded-lg shadow-sm hover:bg-blue-50 hover:border-blue-300 transition group">
                    <div
                        class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition">
                        <i class="fa-solid fa-file-invoice-dollar text-xl"></i>
                    </div>
                    <div class="ml-4 text-left">
                        <h3 class="text-lg font-bold text-gray-800">報價系統</h3>
                        <p class="text-xs text-gray-500">客戶報價單</p>
                    </div>
                    <i class="fa-solid fa-chevron-right ml-auto text-gray-300 group-hover:text-blue-500"></i>
                </button>
                <button onclick="navigateTo('page-cost')"
                    class="flex items-center p-4 bg-white border-2 border-green-100 rounded-lg shadow-sm hover:bg-green-50 hover:border-green-300 transition group">
                    <div
                        class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center text-green-600 group-hover:bg-green-600 group-hover:text-white transition">
                        <i class="fa-solid fa-calculator text-xl"></i>
                    </div>
                    <div class="ml-4 text-left">
                        <h3 class="text-lg font-bold text-gray-800">成本系統</h3>
                        <p class="text-xs text-gray-500">工料成本分析</p>
                    </div>
                    <i class="fa-solid fa-chevron-right ml-auto text-gray-300 group-hover:text-green-500"></i>
                </button>
                <button onclick="navigateTo('page-accounting')"
                    class="flex items-center p-4 bg-white border-2 border-orange-100 rounded-lg shadow-sm hover:bg-orange-50 hover:border-orange-300 transition group">
                    <div
                        class="w-12 h-12 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 group-hover:bg-orange-600 group-hover:text-white transition">
                        <i class="fa-solid fa-coins text-xl"></i>
                    </div>
                    <div class="ml-4 text-left">
                        <h3 class="text-lg font-bold text-gray-800">會計系統</h3>
                        <p class="text-xs text-gray-500">請款與帳務</p>
                    </div>
                    <i class="fa-solid fa-chevron-right ml-auto text-gray-300 group-hover:text-orange-500"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ================= 2. 報價系統 ================= -->
    <div id="page-quotation" class="page-section p-4">
        <!-- 內容由 JS 動態渲染 -->
        <div id="app-container"></div>
    </div>

    <!-- ================= 3. 成本系統 ================= -->
    <div id="page-cost" class="page-section p-4">
        <div id="cost-container"></div>
    </div>

    <!-- ================= 4. 會計系統 ================= -->
    <div id="page-accounting" class="page-section p-4">
        <div id="acc-container"></div>
    </div>

    <!-- 共用預覽區 -->
    <div id="preview-section"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50 overflow-y-auto p-4">
        <div class="bg-white rounded shadow-xl max-w-[230mm] w-full overflow-hidden flex flex-col max-h-[95vh]">
            <div class="overflow-y-auto flex-1 bg-gray-500 p-4 flex justify-center">
                <div id="quotation-canvas"
                    class="preview-canvas bg-white p-12 w-full max-w-[210mm] min-h-[297mm] shadow-lg relative">

                    <!-- 1. 抬頭與 Logo -->
                    <div class="flex items-start mb-4 relative">
                        <div class="absolute left-0 top-0">
                            <img id="disp-logo" src="" class="h-20 object-contain hidden" alt="Company Logo">
                        </div>
                        <div class="w-full text-center">
                            <div class="company-title" id="disp-seller-name">健益工程有限公司</div>
                            <div class="doc-title" id="disp-doc-title">工程報價單</div>
                        </div>
                    </div>

                    <!-- 2. 客戶與工程資訊表格 -->
                    <table class="info-table mb-1">
                        <tr>
                            <td class="text-center w-[15%]">公司名稱</td>
                            <td class="w-[35%]" id="disp-customer"></td>
                            <td class="text-center w-[15%]">聯絡人</td>
                            <td class="w-[35%]" id="disp-contact"></td>
                        </tr>
                        <tr>
                            <td class="text-center">工程名稱</td>
                            <td id="disp-project"></td>
                            <td class="text-center">聯絡電話</td>
                            <td id="disp-phone"></td>
                        </tr>
                    </table>
                    <div class="text-right text-sm mb-2 font-kai">
                        日期：<span id="disp-date"></span> &nbsp;&nbsp; 單號：<span id="disp-id"></span>
                        <span id="disp-taxId-wrapper" class="hidden">&nbsp;&nbsp; 統編：<span
                                id="disp-taxId"></span></span>
                    </div>

                    <!-- 3. 明細表格 -->
                    <table class="items-table mb-2">
                        <thead>
                            <tr class="bg-white">
                                <th style="width: 8%;">項 次</th>
                                <th style="width: 35%;">產品名稱</th>
                                <th style="width: 8%;">單位</th>
                                <th style="width: 10%;">數量</th>
                                <th style="width: 12%;">單 價</th>
                                <th style="width: 12%;">複 價</th>
                                <th style="width: 15%;">備 註</th>
                            </tr>
                        </thead>
                        <tbody id="disp-items"></tbody>
                    </table>

                    <!-- 4. 總計計算區 -->
                    <div class="flex justify-end mt-4 px-2">
                        <div class="w-1/2">
                            <div id="disp-additional-fees"></div>
                            <div class="summary-row">
                                <div class="summary-label">合 計 :</div>
                                <div class="summary-value" id="disp-subtotal-notax">0</div>
                            </div>
                            <div class="summary-row">
                                <div class="summary-label">稅 金 :</div>
                                <div class="summary-value" id="disp-tax-amount">0</div>
                            </div>
                            <div class="summary-row" style="border-top: 1px solid #000; margin-top: 2px;">
                                <div class="summary-label">總 計 :</div>
                                <div class="summary-value" id="disp-grand-total">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- 5. 大寫金額 -->
                    <div class="mt-4 text-lg border-b-2 border-transparent pb-1" style="border-bottom: 2px solid #ccc;">
                        新台幣： <span id="disp-chinese-amt" class="font-bold px-2">零元整</span>
                    </div>

                    <!-- 6. 法律聲明 -->
                    <div class="mt-1 text-center font-bold text-sm bg-gray-100 p-1 border border-black">
                        本交易為附條件買賣，內容依動產擔保交易法第三章規定。
                    </div>

                    <!-- 7. 備註 -->
                    <div class="mt-4 flex">
                        <div class="font-bold w-[60px]">備註:</div>
                        <div class="flex-1">
                            <pre id="disp-note" class="whitespace-pre-wrap font-kai"></pre>
                        </div>
                    </div>

                    <!-- 8. LINE帳號/頁尾資訊 -->
                    <div class="mt-12">
                        <div class="mb-2 font-bold">LINE帳號</div>
                        <div class="border-t border-black pt-2 text-center text-sm" id="disp-seller-contact-footer">
                        </div>
                    </div>

                </div>
            </div>
            <div class="p-4 bg-gray-50 flex gap-4 border-t z-50">
                <button onclick="closePreview()"
                    class="flex-1 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 font-bold">返回修改</button>
                <button onclick="downloadJPG()" id="btn-download"
                    class="flex-1 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold shadow">下載 JPG
                    圖片</button>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzDAF6z227x3Hif3CxISbQSNV_xAHXk8BAYzAd8w0haV_39poKQCjnUbJhZAgcEfBBP/exec';
        const LIFF_ID = '2008974069-Ecojk6W1'; // 請在此填入您的 LIFF ID
        // 資料變數
        let salesPersons = []; // 從後端載入
        let unitOptions = [];  // 從後端載入
        let nextProjectId = ''; // 從後端載入
        const DEFAULT_LOGO = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFsAAABbCAMAAAAr6AmrAAAAA3NCSVQICAjb4U/gAAAADFBMVEX/igX/////nS7/kBGlc65UAAAApXpUWHRSYXcgcHJvZmlsZSB0eXBlIEFQUDEAABiVfU5bDsIwDPvvKXYE57G0PU5BBU1CgHb/DxI6xCYhHDV2rShOuvZ7X5fz9Fwfl+XW0xQgtaRVKzcABQMCEIOCvQ9sLOSKXeTtz4OtlgzdzTUcMPuEiVH29zZiFnXs0U+ssBcQx+x2zSd8l/7wGU3jJt78fIyGlEiWIuxdJbuqFiBnNRP8r0B6AQnGQScUvA0CAAABdklEQVRoge3ZWxLCIAwF0DTZ/57V6djyJiG5jjjypZQeUoqAQORNRze56UEFQXaTj7NrPdIu9VibGGhnoYfbhLQJaRPSJqRNSJuBNiFt2tWmXW362y38p21+Jom3swkwLS3lrF5VzpOqq3TdUNkTaion8blsbsE34rG79HE2u8MeyCe+bo+iPpl5P+mk7MaqvjvCsogmdZ5UyqwFu/+gRW0eu77E3Cq4QE9fz7o971Vmm/V3mG192Ot2bFG4LR+wNWOP1eZN7V3bBBn3rr+d6wbFBGi2keOg6AM324aNBLvNatxuD7ZXJM9asJOlT97mXEALdrZkkyrXF3e51Hz+J0m/njUlma/Pev4YpmaBGFyc9gCX9mWDXa+wM8Nnt1f4726jscfvt9TvKxp7/iiWSc5qr6dtbXsz6u1Nt5XMP6jvsWFv0z7K2GzoLrh9E01vQ48doOcl0IMe6AkV9GgNeiYY3hVn82mcHTu2aNYCcXZc8C07qIIHIcAGb2GaLZ0AAAAASUVORK5CYII=';
        let userLogoData = DEFAULT_LOGO;

        // 當前系統狀態 'quotation' | 'cost' | 'accounting'
        let currentSystem = 'quotation';

        // LIFF 使用者資訊
        let liffUser = { userId: null, displayName: null, pictureUrl: null };

        // 初始化
        window.onload = function () {
            initializeLiff();
            fetchSystemConfig(); // [新增] 載入系統設定
        };

        // --- LIFF 初始化與登入 ---
        async function initializeLiff() {
            try {
                if (LIFF_ID === '您的_LIFF_ID') {
                    console.warn('尚未設定 LIFF ID');
                    renderUI('app-container', 'quotation');
                    return;
                }

                await liff.init({ liffId: LIFF_ID });

                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    liffUser = {
                        userId: profile.userId,
                        displayName: profile.displayName,
                        pictureUrl: profile.pictureUrl
                    };
                    console.log("LIFF 登入成功:", liffUser.displayName);

                    // [新增] 更新右上角使用者資訊
                    updateUserInfoUI();

                    renderUI('app-container', 'quotation');
                }
            } catch (err) {
                console.error('LIFF 初始化失敗:', err);
                renderUI('app-container', 'quotation');
            }
        }

        function updateUserInfoUI() {
            const headerInfo = document.getElementById('header-user-info');
            if (headerInfo && liffUser.displayName) {
                headerInfo.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="flex flex-col text-right">
                             <span class="text-white font-bold text-sm">${liffUser.displayName}</span>
                        </div>
                        <img src="${liffUser.pictureUrl || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full border-2 border-white shadow-sm">
                        <button onclick="logout()" class="text-blue-200 hover:text-white ml-1 text-sm" title="登出">
                            <i class="fa-solid fa-right-from-bracket"></i>
                        </button>
                    </div>
                `;
            }
        }

        // --- [新增] 取得後端設定 ---
        function fetchSystemConfig() {
            if (GAS_URL === '您的_GAS_WEB_APP_URL') return;
            fetch(GAS_URL)
                .then(res => res.json())
                .then(data => {
                    if (data) {
                        salesPersons = data.sales || [];
                        unitOptions = data.units || [];
                        nextProjectId = data.nextProjectId || '';
                        // 若 UI 已渲染，重新更新相關欄位 (如 datalist)
                        renderDynamicLists();
                    }
                })
                .catch(e => console.error("Config fetch failed", e));
        }

        function renderDynamicLists() {
            // 更新業務清單
            const salesList = document.getElementById('sales-list');
            if (salesList) {
                salesList.innerHTML = salesPersons.map(s => `<option value="${s}">`).join('');
            }
            // 單位清單會在 addRow 時動態生成
        }

        // --- [新增] 邏輯控制 ---
        function checkQty(input) {
            if (parseFloat(input.value) < 0) {
                alert("數量不能為負數！");
                input.value = 0;
            }
        }

        function checkPrice(input) {
            if (parseFloat(input.value) < 0) {
                if (!confirm("警告：單價為負數，確定要繼續嗎？")) {
                    input.value = 0;
                }
            }
        }

        function generateProjectId() {
            const input = document.getElementById('internalProjectId');
            if (input && nextProjectId) {
                input.value = nextProjectId;
                // 為了避免重複，前端顯示後暫時 +1 (實際準確度依賴後端再次確認或由後端更新)
                // 簡易處理：若後端回傳 202601260001, 前端使用後可簡單設為 used
            } else {
                alert("尚未取得專案ID或連線中...");
            }
        }

        function saveUnit(unit) {
            // 檢查是否為新單位
            if (unit && unit !== 'custom' && !unitOptions.includes(unit)) {
                unitOptions.push(unit); // 前端先更新
                // 背景送出儲存
                fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'save_unit', unit: unit }),
                    mode: 'no-cors'
                });
            }
        }

        // --- 核心：頁面與系統切換 ---
        function navigateTo(pageId) {
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            window.scrollTo(0, 0);

            if (pageId === 'page-quotation') {
                currentSystem = 'quotation';
                renderUI('app-container', 'quotation');
            } else if (pageId === 'page-cost') {
                currentSystem = 'cost';
                renderUI('cost-container', 'cost');
            } else if (pageId === 'page-accounting') {
                currentSystem = 'accounting';
                renderUI('acc-container', 'accounting');
            }
            // 頁面切換後更新 UI 資訊 (因為 innerHTML 重繪了)
            setTimeout(updateUserInfoUI, 50);
        }

        // --- 動態渲染 UI (共用模板) ---
        function renderUI(containerId, systemType) {
            const titles = { quotation: '建立工程報價單', cost: '專案成本分析表', accounting: '會計請款/帳務單' };
            const docTitles = { quotation: '工程報價單', cost: '成本分析單', accounting: '請款單' };
            const themeColor = { quotation: 'blue', cost: 'green', accounting: 'orange' };

            const color = themeColor[systemType];
            const today = new Date().toISOString().split('T')[0];

            const html = `
            <div class="max-w-3xl mx-auto">
                <div class="flex items-center mb-4">
                    <button onclick="navigateTo('page-home')" class="mr-3 px-3 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm font-bold flex items-center">
                        <i class="fa-solid fa-arrow-left mr-2"></i> 回首頁
                    </button>
                    <h2 class="text-xl font-bold text-gray-800">${titles[systemType]}</h2>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 mb-6 border-t-4 border-${color}-500">
                    <div class="mb-6 bg-gray-50 p-4 rounded border border-gray-200">
                        <h3 class="text-sm font-bold text-gray-700 mb-3">基本資料</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-xs text-gray-500 mb-1">公司名稱 (賣方)</label><input type="text" id="sellerName" class="w-full border border-gray-300 rounded p-2 text-sm" value="健益工程有限公司"></div>
                            <div><label class="block text-xs text-gray-500 mb-1">聯絡人資訊</label><input type="text" id="sellerContact" class="w-full border border-gray-300 rounded p-2 text-sm" placeholder="顯示於頁尾"></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="md:col-span-2 bg-${color}-50 p-3 rounded-md border border-${color}-100">
                            <label class="block text-sm font-medium text-gray-700 mb-1">客戶/廠商名稱</label>
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="taxId" class="w-1/3 border border-gray-300 rounded-md p-2 text-sm" placeholder="統編(選填)" onchange="lookupCompany()">
                                <button onclick="lookupCompany()" class="bg-${color}-600 text-white px-3 rounded-md text-xs hover:bg-${color}-700">查詢</button>
                            </div>
                            <input type="text" id="customer" class="w-full border border-gray-300 rounded-md p-2" placeholder="輸入名稱" oninput="loadHistory('${systemType}')">
                            <div id="history-area" class="mt-2 hidden">
                                <p class="text-xs text-gray-500 mb-1 font-bold">歷史紀錄 (${titles[systemType]})：</p>
                                <ul id="history-list" class="text-xs text-gray-600 bg-white border border-gray-200 rounded max-h-24 overflow-y-auto p-1"></ul>
                            </div>
                        </div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">聯絡人</label><input type="text" id="contactPerson" class="w-full border border-gray-300 rounded-md p-2 text-sm"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">連絡電話</label><input type="text" id="contactPhone" class="w-full border border-gray-300 rounded-md p-2 text-sm"></div>
                        
                        <!-- [新增] 內控資訊 -->
                        <div class="md:col-span-1 bg-gray-50 p-2 rounded border border-gray-200">
                             <label class="block text-xs font-bold text-gray-500 mb-1">專案ID (內控)</label>
                             <div class="flex gap-1">
                                <input type="text" id="internalProjectId" class="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="編號">
                                <button onclick="generateProjectId()" class="bg-blue-600 text-white px-2 py-1 rounded text-xs whitespace-nowrap">生成</button>
                             </div>
                        </div>
                        <div class="md:col-span-1 bg-gray-50 p-2 rounded border border-gray-200">
                             <label class="block text-xs font-bold text-gray-500 mb-1">業務人員</label>
                             <input type="text" id="salesPerson" list="sales-list" class="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="選擇或輸入">
                             <datalist id="sales-list">
                                ${salesPersons.map(s => `<option value="${s}">`).join('')}
                             </datalist>
                        </div>

                        <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-1">工程/項目名稱</label><input type="text" id="projectName" class="w-full border border-gray-300 rounded-md p-2 text-sm"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-1">日期</label><input type="date" id="quoteDate" class="w-full border border-gray-300 rounded-md p-2 text-sm" value="${today}"></div>
                    </div>

                    <hr class="my-4 border-gray-200">
                    <h3 class="text-md font-bold text-gray-700 mb-2">項目明細</h3>
                    <div id="items-container" class="space-y-3 mb-4"></div>

                    <div class="flex gap-3 mb-6">
                        <button onclick="addRow('category')" class="flex-1 py-2 px-4 border border-gray-300 bg-gray-50 text-gray-700 font-bold rounded hover:bg-gray-100">+ 大項次</button>
                        <button onclick="addRow('item')" class="flex-1 py-2 px-4 border border-${color}-300 bg-${color}-50 text-${color}-700 font-bold rounded hover:bg-${color}-100">+ 細項</button>
                    </div>

                    <div class="mb-4 bg-yellow-50 p-4 rounded border border-yellow-200">
                        <label class="block text-sm font-bold text-gray-700 mb-2">額外費用</label>
                        <div id="fees-container" class="space-y-2 mb-3"></div>
                        <button onclick="addFeeRow()" class="text-sm bg-white border border-yellow-400 text-yellow-700 px-3 py-1 rounded hover:bg-yellow-100">+ 新增費用</button>
                    </div>

                    <div class="mb-6 flex items-center bg-gray-50 p-3 rounded border border-gray-200">
                        <input type="checkbox" id="needTax" class="w-5 h-5 text-blue-600 rounded" checked>
                        <label for="needTax" class="ml-2 block text-sm font-bold text-gray-700 cursor-pointer">加計 5% 營業稅</label>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">備註</label>
                        <textarea id="footerNote" rows="3" class="w-full border border-gray-300 rounded-md p-2 text-sm">${systemType === 'quotation' ? '1. 本報價單有效期限為 15 天。\n2. 付款方式：訂金 30%，完工驗收後付清尾款。' : ''}</textarea>
                    </div>

                    <button onclick="generatePreview('${docTitles[systemType]}')" class="w-full py-3 px-4 text-lg font-bold rounded-md text-white bg-${color}-600 hover:bg-${color}-700 shadow-lg">預覽並儲存</button>
                </div>
            </div>`;

            const target = document.getElementById(containerId);
            if (target) {
                target.innerHTML = html;
            } else {
                console.error("Target container not found:", containerId);
            }
        }

        // --- 歷史紀錄功能 ---
        function getHistory(type) {
            const key = type + '_history_v1';
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        }

        function saveToHistory(type, data) {
            const key = type + '_history_v1';
            let history = getHistory(type);
            history.unshift(data);
            if (history.length > 100) history = history.slice(0, 100);
            localStorage.setItem(key, JSON.stringify(history));
        }

        function loadHistory(type) {
            const customerName = document.getElementById('customer').value.trim();
            const historyArea = document.getElementById('history-area');
            const historyList = document.getElementById('history-list');
            if (!customerName || !historyArea) {
                if (historyArea) historyArea.classList.add('hidden');
                return;
            }

            const history = getHistory(type);
            const records = history.filter(q => q.customer === customerName);

            if (records.length > 0) {
                let html = '';
                records.forEach(q => {
                    html += `<li class="border-b border-gray-100 py-1 hover:bg-gray-50 flex justify-between"><span>${q.project || '(無工程名)'}</span><span class="font-bold">$${q.subtotalNoTax.toLocaleString()}</span></li>`;
                });
                historyList.innerHTML = html;
                historyArea.classList.remove('hidden');
            } else {
                historyArea.classList.add('hidden');
            }
        }

        function checkItemHistory(inputEl) {
            // 目前僅為 Placeholder，若需實作細項歷史查詢可在此擴充
        }

        // --- 統編查詢 ---
        async function lookupCompany() {
            const taxId = document.getElementById('taxId').value.trim();
            const nameInput = document.getElementById('customer');
            if (taxId.length !== 8) {
                alert("請輸入正確的 8 碼統一編號");
                return;
            }
            nameInput.placeholder = "查詢中...";
            try {
                const response = await fetch(`https://data.gcis.nat.gov.tw/od/data/api/9D17AE0D-09B5-4432-A8F4-81B43F75F718?$format=json&$filter=Business_Accounting_NO eq ${taxId}&$skip=0&$top=1`);
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        nameInput.value = data[0].Company_Name;
                        loadHistory(currentSystem);
                    } else alert("查無此統編資料，請手動輸入名稱。");
                } else throw new Error("API Error");
            } catch (e) {
                console.log("Auto lookup failed.", e);
                if (nameInput.value === "") nameInput.placeholder = "無法自動取得，請手動輸入";
            }
        }

        // --- 表格列操作 ---
        function toggleUnit(el) {
            if (el.value === 'custom') { el.classList.add('hidden'); el.nextElementSibling.classList.remove('hidden'); el.nextElementSibling.focus(); }
        }
        function resetUnit(btn) {
            /* 預留重置功能 */
        }

        function addRow(type) {
            const container = document.getElementById('items-container');
            const rowId = 'row-' + Date.now();
            let html = '';

            if (type === 'category') {
                html = `<div id="${rowId}" class="item-row bg-gray-50 p-3 rounded border border-gray-300 relative mb-2 border-l-4 border-l-gray-500">
                    <input type="hidden" class="row-type" value="category">
                    <button onclick="this.parentElement.remove()" class="absolute top-1 right-1 text-gray-400 hover:text-red-500">✕</button>
                    <label class="text-xs font-bold text-gray-600">大項次名稱</label>
                    <input type="text" class="input-category w-full border border-gray-300 rounded p-1 font-bold" placeholder="分類名稱">
                </div>`;
            } else {
                let optionsHtml = unitOptions.map(u => `<option value="${u}">${u}</option>`).join('');
                optionsHtml += `<option value="custom">自訂</option>`;
                html = `<div id="${rowId}" class="item-row bg-white p-3 rounded border border-gray-200 relative mb-2 ml-4 border-l-4 border-l-blue-300">
                    <input type="hidden" class="row-type" value="item">
                    <button onclick="this.parentElement.remove()" class="absolute top-1 right-1 text-gray-400 hover:text-red-500">✕</button>
                    <div class="grid grid-cols-12 gap-2">
                        <div class="col-span-12 md:col-span-6"><label class="text-xs text-gray-500">項目名稱</label><input type="text" class="input-name w-full border border-gray-300 rounded p-1" placeholder="品項" oninput="checkItemHistory(this)"></div>
                        <div class="col-span-4 md:col-span-2"><label class="text-xs text-gray-500">數量</label><input type="number" class="input-qty w-full border border-gray-300 rounded p-1 text-center" value="1" onchange="checkQty(this)"></div>
                        <div class="col-span-4 md:col-span-2"><label class="text-xs text-gray-500">單位</label>
                            <select class="input-unit-select w-full border p-1" onchange="toggleUnit(this)">${optionsHtml}</select>
                            <input type="text" class="input-unit-custom w-full border p-1 hidden" placeholder="輸入" onchange="saveUnit(this.value)">
                        </div>
                        <div class="col-span-4 md:col-span-2"><label class="text-xs text-gray-500">單價</label><input type="number" class="input-price w-full border p-1 text-right" placeholder="0" onchange="checkPrice(this)"></div>
                        <div class="col-span-12"><label class="text-xs text-gray-500">備註</label><input type="text" class="input-remark w-full border p-1" placeholder="..."></div>
                    </div>
                </div>`;
            }
            container.insertAdjacentHTML('beforeend', html);
        }

        function addFeeRow() {
            const html = `<div class="fee-row flex gap-2 items-center bg-white p-2 rounded border border-gray-200 mb-1">
                <input type="text" class="fee-name w-1/2 border p-1 text-sm" placeholder="費用名稱">
                <select class="fee-type border p-1 text-sm"><option value="percent">%</option><option value="amount">$</option></select>
                <input type="number" class="fee-value w-full border p-1 text-sm text-right" placeholder="數值">
                <button onclick="this.parentElement.remove()" class="text-red-500 font-bold px-2">✕</button>
            </div>`;
            document.getElementById('fees-container').insertAdjacentHTML('beforeend', html);
        }

        // --- 生成預覽與資料處理 (已更新：Token 驗證) ---
        async function generatePreview(docTitle) {
            const customer = document.getElementById('customer').value.trim();
            if (!customer) return alert('請輸入客戶/廠商名稱');

            const authToken = "123456"; // 為了相容後端，暫時保留預設 Token，實際驗證依賴 LIFF User ID

            const needTax = document.getElementById('needTax').checked;
            const sellerName = document.getElementById('sellerName').value;
            const sellerContact = document.getElementById('sellerContact').value;
            const project = document.getElementById('projectName').value;
            // [新增] 內控資料
            const internalProjectId = document.getElementById('internalProjectId').value;
            const salesPerson = document.getElementById('salesPerson').value;

            const date = document.getElementById('quoteDate').value;
            const taxId = document.getElementById('taxId').value;
            const contact = document.getElementById('contactPerson').value;
            const phone = document.getElementById('contactPhone').value;
            const note = document.getElementById('footerNote').value;
            const orderId = (currentSystem === 'quotation' ? 'QT-' : (currentSystem === 'cost' ? 'CT-' : 'AC-')) + Date.now().toString().slice(-6);

            const rows = document.querySelectorAll('.item-row');
            let itemsTotal = 0;
            let displayHtml = '';
            let globalIndex = 1;
            let itemsData = [];

            let currentGroup = null;
            let miscItems = [];
            let groups = [];

            // 1. 收集表格資料
            rows.forEach(row => {
                const type = row.querySelector('.row-type').value;
                if (type === 'category') {
                    if (currentGroup) groups.push(currentGroup);
                    currentGroup = { name: row.querySelector('.input-category').value.trim() || '未命名', items: [], subtotal: 0 };
                } else {
                    const name = row.querySelector('.input-name').value.trim();
                    if (name) {
                        const qty = parseFloat(row.querySelector('.input-qty').value) || 0;
                        const uSelect = row.querySelector('.input-unit-select');
                        const unit = !uSelect.classList.contains('hidden') ? uSelect.value : row.querySelector('.input-unit-custom').value;
                        const price = parseFloat(row.querySelector('.input-price').value) || 0;
                        const subtotal = qty * price;
                        const remark = row.querySelector('.input-remark').value;

                        const itemObj = { name, qty, unit, price, subtotal, remark };
                        itemsTotal += subtotal;

                        if (currentGroup) {
                            currentGroup.items.push(itemObj);
                            currentGroup.subtotal += subtotal;
                        } else {
                            miscItems.push(itemObj);
                        }
                    }
                }
            });
            if (currentGroup) groups.push(currentGroup);

            if (groups.length === 0 && miscItems.length === 0) return alert('請至少輸入一項內容');

            // 2. 處理額外費用
            let totalFees = 0;
            let feesHtml = '';
            let feesData = [];
            document.querySelectorAll('.fee-row').forEach(row => {
                const name = row.querySelector('.fee-name').value.trim();
                const type = row.querySelector('.fee-type').value;
                const val = parseFloat(row.querySelector('.fee-value').value) || 0;
                if (name) {
                    let amount = type === 'percent' ? Math.round(itemsTotal * (val / 100)) : val;
                    totalFees += amount;
                    feesData.push({ name, type, val, amount });
                    feesHtml += `<div class="summary-row"><div class="summary-label">${name}${type === 'percent' ? '(' + val + '%)' : ''} :</div><div class="summary-value">$${amount.toLocaleString()}</div></div>`;
                }
            });

            const subtotalNoTax = itemsTotal + totalFees;
            const taxAmount = needTax ? Math.round(subtotalNoTax * 0.05) : 0;
            const grandTotal = subtotalNoTax + taxAmount;

            // 3. 產生 HTML 表格
            const genRow = (idx, item) => `<tr><td class="text-center">${idx}</td><td>${item.name}</td><td class="text-center">${item.unit}</td><td class="text-center">${item.qty}</td><td class="text-right">${item.price.toLocaleString()}</td><td class="text-right">${item.subtotal.toLocaleString()}</td><td class="text-left text-sm">${item.remark}</td></tr>`;

            miscItems.forEach(item => { displayHtml += genRow(globalIndex++, item); itemsData.push({ type: 'item', ...item }); });
            groups.forEach(group => {
                displayHtml += `<tr><td class="text-center">${globalIndex++}</td><td class="font-bold text-lg" colspan="4">${group.name}</td><td class="text-right font-bold">${group.subtotal.toLocaleString()}</td><td></td></tr>`;
                itemsData.push({ type: 'category', category: group.name, subtotal: group.subtotal });
                group.items.forEach(item => { displayHtml += genRow(globalIndex++, item); itemsData.push({ type: 'item', ...item }); });
            });

            // 4. 填入預覽資料
            document.getElementById('disp-doc-title').innerText = docTitle;
            document.getElementById('disp-seller-name').innerText = sellerName;
            document.getElementById('disp-customer').innerText = customer;
            document.getElementById('disp-taxId').innerText = taxId;
            if (taxId) document.getElementById('disp-taxId-wrapper').classList.remove('hidden'); else document.getElementById('disp-taxId-wrapper').classList.add('hidden');

            document.getElementById('disp-project').innerText = project;
            document.getElementById('disp-contact').innerText = contact;
            document.getElementById('disp-phone').innerText = phone;
            document.getElementById('disp-date').innerText = date;
            document.getElementById('disp-id').innerText = orderId;
            document.getElementById('disp-items').innerHTML = displayHtml;
            document.getElementById('disp-note').innerText = note;
            document.getElementById('disp-seller-contact-footer').innerText = sellerContact;

            document.getElementById('disp-additional-fees').innerHTML = feesHtml;
            document.getElementById('disp-subtotal-notax').innerText = '$' + subtotalNoTax.toLocaleString();
            document.getElementById('disp-tax-amount').innerText = '$' + taxAmount.toLocaleString();
            document.getElementById('disp-grand-total').innerText = '$' + grandTotal.toLocaleString();
            document.getElementById('disp-chinese-amt').innerText = toChineseNum(grandTotal);

            const logoImg = document.getElementById('disp-logo');
            if (userLogoData) { logoImg.src = userLogoData; logoImg.classList.remove('hidden'); } else { logoImg.classList.add('hidden'); }

            // 5. 顯示預覽視窗
            document.getElementById('preview-section').classList.remove('hidden');

            const currentData = {
                taxId, contact, phone, project, date, note, orderId, sellerName, sellerContact, customer,
                internalProjectId, salesPerson, // [新增]
                items: itemsData, fees: feesData, subtotalNoTax, grandTotal
            };

            // 存入 LocalStorage 歷史紀錄
            saveToHistory(currentSystem, currentData);

            // 6. [新增] 截圖並傳送至 GAS (含 Token)
            if (GAS_URL && GAS_URL !== '您的_GAS_WEB_APP_URL') {
                const element = document.getElementById('quotation-canvas');

                setTimeout(() => {
                    html2canvas(element, {
                        scale: 1.5,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        logging: false
                    }).then(canvas => {
                        const imageBase64 = canvas.toDataURL('image/jpeg', 0.8);
                        const folderName = currentSystem === 'quotation' ? '報價資料' : (currentSystem === 'cost' ? '成本資料' : '會計資料');

                        const payload = {
                            token: authToken, // 加入 Token
                            type: currentSystem,
                            lineUser: liffUser, // 加入 LINE 使用者資訊
                            folder: folderName,
                            image: imageBase64,
                            ...currentData
                        };

                        fetch(GAS_URL, {
                            method: 'POST',
                            body: JSON.stringify(payload),
                            headers: { 'Content-Type': 'text/plain' },
                            mode: 'no-cors'
                        }).then(() => {
                            console.log("資料與圖片已傳送至後端儲存");
                        }).catch(e => console.error("傳送失敗:", e));
                    });
                }, 500);
            }
        }

        // --- 下載 JPG (檔名格式：日期_客戶_專案.jpg) ---
        function downloadJPG() {
            const element = document.getElementById('quotation-canvas');
            const btn = document.getElementById('btn-download');
            const originalText = btn.innerText;
            btn.innerText = '處理中...';
            btn.disabled = true;

            const date = document.getElementById('disp-date').innerText;
            const customer = document.getElementById('disp-customer').innerText;
            const project = document.getElementById('disp-project').innerText || '專案';
            // 設定檔案名稱
            const filename = `${date}_${customer}_${project}.jpg`;

            const options = { scale: 2, useCORS: true, backgroundColor: '#ffffff', logging: false, windowWidth: element.scrollWidth, windowHeight: element.scrollHeight };

            setTimeout(() => {
                html2canvas(element, options).then(canvas => {
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                    btn.innerText = originalText;
                    btn.disabled = false;
                }).catch(err => {
                    console.error(err);
                    alert("生成失敗");
                    btn.innerText = originalText;
                    btn.disabled = false;
                });
            }, 300);
        }

        function closePreview() { document.getElementById('preview-section').classList.add('hidden'); loadHistory(currentSystem); }
        function toChineseNum(num) {
            if (!/^\d*(\.\d*)?$/.test(num)) return "Number is wrong!";
            var AA = ["零", "壹", "貳", "參", "肆", "伍", "陸", "柒", "捌", "玖"], BB = ["", "拾", "佰", "仟", "萬", "億", "兆", "京"];
            var a = ("" + num).replace(/(^0*)/g, "").split("."), k = 0, re = "";
            for (var i = a[0].length - 1; i >= 0; i--) {
                switch (k) { case 0: re = BB[7] + re; break; case 4: if (!new RegExp("0{4}\\d{" + (a[0].length - i - 1) + "}$").test(a[0])) re = BB[4] + re; break; case 8: re = BB[5] + re; break; }
                if (k % 4 == 2 && a[0].charAt(i + 2) != 0 && a[0].charAt(i + 1) == 0) re = AA[0] + re;
                if (a[0].charAt(i) != 0) re = AA[a[0].charAt(i)] + BB[k % 4] + re; k++;
            }
            if (a.length > 1) { re += "點"; for (var i = 0; i < a[1].length; i++) re += AA[a[1].charAt(i)]; }
            return (re == '' ? '零元整' : re + "元整");
        }
    </script>
</body>

</html>
