// --- 系統設定與初始化 API ---
function doGet(e) {
    var ss = SpreadsheetApp.getActiveSpreadsheet();

    // [新增] 統編查詢 API (GET)
    if (e.parameter.action === 'lookup') {
        var taxId = e.parameter.taxId;
        if (!taxId) return ContentService.createTextOutput(JSON.stringify({ error: "No ID" })).setMimeType(ContentService.MimeType.JSON);

        var filterStr = "Business_Accounting_NO eq " + taxId;
        var url1 = "https://data.gcis.nat.gov.tw/od/data/api/9D17AE0D-09B5-4732-A8F4-81ADED04B679?$format=json&$filter=" + encodeURIComponent(filterStr);
        var url2 = "https://data.gcis.nat.gov.tw/od/data/api/5F6402A4-EB18-440A-B010-903760CA1663?$format=json&$filter=" + encodeURIComponent(filterStr);

        var resultName = "";

        try {
            // 嘗試查詢公司登記
            var resp1 = UrlFetchApp.fetch(url1, { muteHttpExceptions: true });
            var json1 = JSON.parse(resp1.getContentText());
            if (json1 && json1.length > 0) {
                resultName = json1[0].Company_Name;
            } else {
                // 嘗試查詢商業登記
                var resp2 = UrlFetchApp.fetch(url2, { muteHttpExceptions: true });
                var json2 = JSON.parse(resp2.getContentText());
                if (json2 && json2.length > 0) {
                    resultName = json2[0].Business_Name;
                }
            }
        } catch (err) {
            return ContentService.createTextOutput(JSON.stringify({ error: err.toString() })).setMimeType(ContentService.MimeType.JSON);
        }

        return ContentService.createTextOutput(JSON.stringify({ name: resultName })).setMimeType(ContentService.MimeType.JSON);
    }

    // --- 原有邏輯: 載入系統設定 ---

    // 1. 取得或建立「系統設定」分頁
    var configSheet = ss.getSheetByName("系統設定");
    if (!configSheet) {
        configSheet = ss.insertSheet("系統設定");
        configSheet.appendRow(["人員名單(共用)", "單位清單", "廠商名單"]); // 標題修正
        configSheet.getRange(2, 1).setValue("王小明");
        configSheet.getRange(2, 2).setValue("式");
        configSheet.getRange(2, 3).setValue("廠商A");
    }

    // 2. 讀取清單 (共用人員名單)
    var lastRow = configSheet.getLastRow();
    var sales = [], units = [], vendors = [];

    if (lastRow > 1) {
        // 讀取 A~C 欄
        var data = configSheet.getRange(2, 1, lastRow - 1, 3).getValues();
        data.forEach(function (row) {
            if (row[0]) sales.push(row[0]);
            if (row[1]) units.push(row[1]);
            if (row[2]) vendors.push(row[2]); // C欄: 廠商
        });
    } else {
        sales = ["業務A"]; units = ["式"]; vendors = ["廠商A"];
    }

    // 3. 工務與採購共用 Sales 名單
    var workers = sales;
    var buyers = sales;

    // 4. 計算今日專案ID序號 (格式: YYYYMMDDxxxx)
    var quoteSheet = ss.getSheetByName("報價紀錄");
    var nextSeq = "0001";
    var todayStr = Utilities.formatDate(new Date(), "GMT+8", "yyyyMMdd");

    // [新增] 歷史專案列表
    var projectList = [];

    if (quoteSheet && quoteSheet.getLastRow() > 1) {
        // 簡單抓取全部資料，欄位需對應 doPost 的寫入順序
        // doPost 順序: ..., 4:客戶, 5:專案, 6:ID...
        var qData = quoteSheet.getRange(2, 1, quoteSheet.getLastRow() - 1, 16).getValues();

        qData.forEach(function (row) {
            // ID 計算邏輯: 專案ID在 G欄 (Index 6)
            var pid = row[6];
            if (pid && pid.toString().indexOf(todayStr) === 0 && pid.toString().length === 12) {
                var currentSeq = parseInt(pid.toString().substring(8));
                var potNext = currentSeq + 1;
                var potSeq = ("0000" + potNext).slice(-4);
                if (potSeq > nextSeq) nextSeq = potSeq;
            }

            // 專案列表
            projectList.push({
                id: row[1], // 單號
                date: Utilities.formatDate(new Date(row[0]), "GMT+8", "yyyy-MM-dd"),
                customer: row[4],
                project: row[5],
                sales: row[7], // [新增] 業務人員
                json: row[14] // 詳細 JSON
            });
        });
    }
    projectList.reverse();

    var result = {
        sales: sales,
        units: units,
        vendors: vendors, // [新增]
        workers: workers,
        buyers: buyers,
        nextProjectId: todayStr + nextSeq,
        projects: projectList
    };

    return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
    var ss = SpreadsheetApp.getActiveSpreadsheet();

    try {
        var data = JSON.parse(e.postData.contents);

        // --- [修改] 通用設定儲存邏輯 ---
        if (data.action === "save_config") {
            var configSheet = ss.getSheetByName("系統設定");
            if (!configSheet) configSheet = ss.insertSheet("系統設定");

            var colIndex = 0;
            switch (data.configType) {
                case 'sales': colIndex = 1; break;  // A
                case 'unit': colIndex = 2; break;   // B
                case 'vendor': colIndex = 3; break; // C [新增]
                case 'worker': colIndex = 1; break; // 共用 sales
                case 'buyer': colIndex = 1; break;  // 共用 sales
            }

            if (colIndex > 0 && data.value) {
                // 找出該欄最後一列
                var lastRow = configSheet.getLastRow();
                var rangeLetter;
                if (colIndex === 1) {
                    rangeLetter = "A";
                } else if (colIndex === 2) {
                    rangeLetter = "B";
                } else if (colIndex === 3) {
                    rangeLetter = "C";
                } else {
                    // Should not happen with current configTypes, but as a fallback
                    // or if new types are added without updating this logic.
                    // For now, it will only be 1, 2, or 3.
                    rangeLetter = "A"; // Default to A if something unexpected happens
                }
                var values = configSheet.getRange(rangeLetter + "1:" + rangeLetter).getValues();
                var realLast = values.filter(String).length + 1;
                configSheet.getRange(realLast, colIndex).setValue(data.value);
            }

            return ContentService.createTextOutput(JSON.stringify({ status: "success" }));
        }

        // --- 核心邏輯 ---
        var systemType = data.type;
        var sheetName = "";
        var headerRow = [];

        if (systemType === 'quotation') {
            sheetName = "報價紀錄";
            // [修改] 增加業務手機
            headerRow = [
                "時間戳記", "單號", "版號", "日期", "客戶/廠商", "專案名稱",
                "專案ID(內控)", "業務人員", "業務手機", "LINE ID", "LINE 名稱",
                "未稅金額", "稅金", "總金額", "備註",
                "詳細資料(JSON)", "檔案連結"
            ];
        } else if (systemType === 'cost') {
            sheetName = "成本紀錄";
            headerRow = [
                "時間戳記", "成本單號", "版號", "日期", "專案名稱(來源)", "廠商名稱", "廠商統編",
                "發票號碼", "業務", "業務手機", "工務", "採購",
                "未稅金額", "稅金", "總金額", "備註",
                "詳細資料(JSON)", "分析表連結", "發票連結"
            ];
        } else {
            sheetName = systemType === 'accounting' ? "會計紀錄" : "其他紀錄";
            headerRow = ["時間戳記", "單號", "日期", "說明", "金額", "備註", "JSON", "連結"];
        }

        var sheet = ss.getSheetByName(sheetName);
        if (!sheet) {
            sheet = ss.insertSheet(sheetName);
            sheet.appendRow(headerRow);
        }

        // --- 版本控制邏輯 (維持不變) ---
        var version = 0;
        var fileSuffix = "";
        var orderId = data.orderId;

        if (data.originId) {
            var rows = sheet.getDataRange().getValues();
            var maxVer = 0;
            for (var i = 1; i < rows.length; i++) {
                var dbId = rows[i][1].toString();
                if (dbId.indexOf(data.originId) === 0) {
                    var v = parseInt(rows[i][2] || 0);
                    if (v > maxVer) maxVer = v;
                }
            }
            version = maxVer + 1;
            orderId = data.originId + "-" + version;
            fileSuffix = "-" + version;
        }

        // --- 檔案處理 (略，維持原樣) ---
        var fileUrl = "";
        if (data.image) {
            var folderName = data.folder || "工程管理系統_未分類";
            var folder = getOrCreateFolder(folderName);

            var safeProjectName = (data.project || "專案").replace(/[\/\\:*?"<>|]/g, "_");
            // 檔名加上版號
            var fileName = [data.date, data.customer, safeProjectName].join("_") + fileSuffix + ".jpg";

            fileUrl = saveBase64ToDrive(folder, data.image, fileName);
            data.fileUrl = fileUrl;
        }

        var invoiceUrl = "";
        if (data.invoiceImage) {
            var folder = getOrCreateFolder("廠商發票憑證");
            var safeVendor = (data.vendorName || "廠商").replace(/[\/\\:*?"<>|]/g, "_");
            var invFileName = [data.date, safeVendor, (data.invoiceNo || ""), orderId].join("_") + ".jpg";
            invoiceUrl = saveBase64ToDrive(folder, data.invoiceImage, invFileName);
            data.invoiceUrl = invoiceUrl;
        }

        // --- [修改] 寫入資料 (加入 salesMobile) ---
        var rowData = [];
        var timestamp = new Date();
        var lineId = (data.lineUser && data.lineUser.userId) ? data.lineUser.userId : "";
        var lineName = (data.lineUser && data.lineUser.displayName) ? data.lineUser.displayName : "";
        var mobile = data.salesMobile || "";

        if (systemType === 'quotation') {
            rowData = [
                timestamp, orderId, version, data.date, data.customer, data.project,
                data.internalProjectId || "", data.salesPerson || "", mobile, lineId, lineName,
                data.subtotalNoTax, data.taxAmount, data.grandTotal, data.note,
                JSON.stringify(data), fileUrl
            ];
        } else if (systemType === 'cost') {
            rowData = [
                timestamp, orderId, version, data.date, data.project, data.vendorName, data.vendorTaxId,
                data.invoiceNo, data.salesPerson, mobile, data.workerPerson, data.buyerPerson,
                data.subtotalNoTax, data.taxAmount, data.grandTotal, data.note,
                JSON.stringify(data), fileUrl, invoiceUrl
            ];
        } else {
            rowData = [timestamp, orderId, data.date, "一般紀錄", data.grandTotal, data.note, JSON.stringify(data), fileUrl];
        }

        sheet.appendRow(rowData);

        return ContentService.createTextOutput(JSON.stringify({
            status: "success",
            message: "成功 (" + orderId + ")",
            fileUrl: fileUrl,
            invoiceUrl: invoiceUrl
        })).setMimeType(ContentService.MimeType.JSON);

    } catch (error) {
        return ContentService.createTextOutput(JSON.stringify({
            status: "error",
            message: error.toString()
        })).setMimeType(ContentService.MimeType.JSON);
    }
}

// 輔助函式
function getOrCreateFolder(name) {
    var folders = DriveApp.getFoldersByName(name);
    if (folders.hasNext()) return folders.next();
    return DriveApp.createFolder(name);
}

function saveBase64ToDrive(folder, base64, name) {
    var base64Data = base64.split(',')[1] || base64;
    var decoded = Utilities.base64Decode(base64Data);
    var blob = Utilities.newBlob(decoded, "image/jpeg", name);
    return folder.createFile(blob).getUrl();
}
