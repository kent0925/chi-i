# 工程管理整合系統 - 操作與資料庫說明書 (2026/01/28 更新版)

## 1. 系統架構說明

本系統採用 **Google Apps Script (GAS)** 作為後端資料庫引擎，前端由四個獨立的 HTML 網頁組成，提供更穩定且專業的操作體驗。

### 1.1 網頁組成 (響應式版本)

* **`index.html` (入口首頁)**：採用 Glassmorphism (玻璃擬態) 與漸層背景設計，提供跳轉至各項功能模組的快捷鍵。包含專案財務概況儀表板。
* **`quotation.html` (報價系統)**：對客戶進行工程報價與版本管理，深藍色主題。支援追加單功能。
* **`cost.html` (成本系統)**：針對專案支出進行多廠商、多明細的成本登錄，綠色主題。支援工務/採購人員指派。
* **`accounting.html` (帳務系統)**：會計帳務管理，包含客戶應收、廠商應付、獎金分配三大功能，橘色主題。

### 1.2 響應式設計特色

所有頁面均支援手機與桌機雙裝置自動適配：

* iOS 縮放防止（輸入欄位 16px 字體）
* 觸控友善 44px 最小點擊區域
* 手機版返回按鈕僅顯示圖示
* 表單控制項手機版垂直排列

---

## 2. Google Sheet 資料庫結構

資料儲存於雲端試算表，各工作表欄對應如下：

### 2.1 系統設定 (System Config)

| 欄位 | 名稱 | 說明 |
| :--- | :--- | :--- |
| A | 業務人員名單 | 供報價/成本/會計系統選用 |
| B | 單位清單 | 供報價明細選用 |
| C | 廠商名單 | 供成本/會計紀錄選用 |

### 2.2 報價紀錄 (Quotation Records)

| 欄位 | 代號 | 欄位名稱 | 說明 |
| :--- | :--- | :--- | :--- |
| A | Timestamp | 時間戳記 | |
| B | ID | 單號 | 格式：YYYYMMDD001 或 YYYYMMDD001A (追加) |
| C | Version | 版號 | |
| D | Date | 日期 | |
| E | Customer | 客戶/廠商 | |
| F | Project | 專案名稱 | |
| G | InternalID | 專案ID (內控) | |
| H | Sales | 業務人員 | |
| I | Mobile | 業務手機 | |
| J | LineID | LINE ID | |
| K | LineName | LINE 名稱 | |
| L | Subtotal | 未稅金額 | |
| M | Tax | 稅金 | |
| N | Total | 總金額 | |
| O | Note | 備註 | |
| P | Fax | 傳真 | 客戶傳真 |
| Q | Status | 狀態 | 已成交 (closed) / 未成交 (open) |
| R | JSON | 詳細資料(JSON) | 重要：所有還原資料皆儲存於此 |
| S | Link | 檔案連結 | Google Drive 報價單圖片 |

### 2.3 成本紀錄 (Cost Records)

| 欄位 | 代號 | 欄位名稱 | 說明 |
| :--- | :--- | :--- | :--- |
| A | Timestamp | 時間戳記 | |
| B | ID | 成本單號 | (對應來源專案名稱) |
| C | Version | 版號 | |
| D | Date | 日期 | |
| E | Project | 專案名稱(來源) | |
| F | Vendor | 廠商名稱 | |
| G | TaxID | 廠商統編 | |
| H | Invoice | 發票號碼 | |
| I | Sales | 業務人員 | |
| J | Mobile | 業務手機 | |
| K | Worker | 工務人員 | 可多人 |
| L | Buyer | 採購人員 | 可多人 |
| M | Subtotal | 未稅金額 | |
| N | Tax | 稅金 | |
| O | Total | 總金額 | |
| P | Note | 備註 | |
| Q | JSON | 詳細資料(JSON) | |
| R | AnalysisLink | 分析表連結 | |
| S | InvoiceLink | 發票連結 | |

### 2.4 銀行代碼對照表 (Bank Codes)

會計系統使用銀行代碼自動查詢銀行名稱，資料來源為外部 API：

* 輸入 3 碼銀行代碼自動顯示銀行名稱
* 支援匯款銀行、存入銀行欄位

### 2.5 會計紀錄 (Accounting Records)

| 欄位 | 說明 |
| :--- | :--- |
| 專案名稱 | 連結至報價系統已成交專案 |
| 收款方式 | 銀行匯款 / 票據 / 現金 |
| 付款資訊 | 廠商、銀行代碼、帳號、金額 |
| 發票比對 | 與成本系統發票號碼比對 |

---

## 3. 各模組操作導引

### 3.1 報價系統 (Quotation)

1. **ID 生成機制**：開啟新單時顯示「自動產生」，按下儲存成功後，系統會跳出正式的 **內控ID** 提醒，便於追蹤。
2. **追加單功能**：勾選「追加單」後，ID 會在原始 ID 後加上字母（如 YYYYMMDD001A）。
3. **統編自動化**：輸入 8 碼統編後點擊「查詢」，後端會自動檢索公司、商業、分公司資料庫。
4. **版本管理**：開啟歷史單據修改後存檔，系統會自動生成新版本（不覆蓋原紀錄）。
5. **已成交設定**：勾選「已成交」後，該專案才會同步至成本系統與會計系統供選擇。
6. **防呆格式**：電話欄位自動格式化 (09xx-xxx-xxx)，數量/單價欄位限制數字輸入。

### 3.2 成本系統 (Cost)

1. **專案選擇**：僅顯示報價系統中已標記「成交」的專案。
2. **人員指派**：可新增多位工務人員與採購人員，系統自動鎖定專案業務。
3. **多廠商支援**：可透過「增加廠商支出」按鈕，在同一張單據內登錄多筆不同廠商的費用。
4. **稅額自動計算**：輸入未稅金額後，系統自動算出 1.05 倍含稅價。
5. **發票類型**：支援「發票」與「收據」兩種類型選擇。
6. **發票上傳**：每一筆支出均可獨立拍照或上傳發票照片至 Google Drive。

### 3.3 會計系統 (Accounting)

1. **功能分頁**：客戶應收、廠商應付、獎金分配三大功能透過標籤切換。
2. **專案選擇**：下拉選單僅顯示已成交專案。
3. **收款方式**：
   * **銀行匯款**：填寫匯款銀行代碼（自動查詢銀行名稱）、帳號、戶名、日期、金額。
   * **票據**：填寫支票號碼、兌現日期、存入銀行、帳號、金額。
   * **現金**：填寫收款人、日期、金額。
4. **廠商應付**：選擇廠商、填寫銀行資訊、比對成本發票號碼。
5. **獎金分配**：自動計算業務/工務/採購/公司利潤分配比例。

---

## 4. 系統部署與權限 (針對管理員)

若系統出現權限錯誤（如 `UrlFetchApp` 錯誤），請執行以下設定。

### 4.1 授權外部要求

進入 GAS 編輯器，在 `appsscript.json` (資訊清單) 中定義如下權限：

```json
"oauthScopes": [
  "https://www.googleapis.com/auth/spreadsheets",
  "https://www.googleapis.com/auth/script.external_request",
  "https://www.googleapis.com/auth/drive"
]
```

### 4.2 部署更新

每次修改 `doPost` 後，必須進行 **「新部署」** 並確認權限設定為 **「所有人」** 存取，否則前端網頁將無法成功上傳資料。

---

## 5. 數字欄位輸入說明

為確保手機使用者有最佳輸入體驗，所有數字相關欄位已設定：

* `inputmode="numeric"` - 手機自動顯示數字鍵盤
* `pattern="[0-9]*"` - 限制輸入數字

適用欄位：銀行代碼、銀行帳號、收款/付款金額、數量、單價、費用金額等。

---

## 6. 常見問題 (FAQ)

* **Q: 為什麼統編查詢查不到？**
  * A: 請確認該公司是否有在經濟部合法登記，或檢查 GAS 原程式碼內的 API 網址是否正常連線。

* **Q: 修改歷史單據會影響舊資料嗎？**
  * A: 不會。系統會增加一列帶有新版號的紀錄，舊資料會永久保留以備審核。

* **Q: 為什麼專案在成本/會計系統選不到？**
  * A: 請確認該專案在報價系統中已勾選「已成交」狀態。

* **Q: 銀行代碼查不到銀行名稱？**
  * A: 請輸入正確的 3 碼銀行代碼，系統會自動從外部 API 查詢銀行名稱。

* **Q: 手機版畫面太擠？**
  * A: 系統已針對手機版進行全面優化，包含響應式版面、更緊湊的按鈕與欄位。

---

*最後更新：2026/01/28*
