# 工程管理整合系統 - 操作與資料庫說明書 (2026/01 更新版)

## 1. 系統架構說明

本系統採用 **Google Apps Script (GAS)** 作為後端資料庫引擎，前端由四個獨立的 HTML 網頁組成，提供更穩定且專業的操作體驗。

### 1.1 網頁組成 (UI 優化版)

* **`index.html` (入口首頁)**：採用 Glassmorphism (玻璃擬態) 與漸層背景設計，提供跳轉至各項功能模組的快捷鍵。
* **`quotation.html` (報價系統)**：對客戶進行工程報價與版本管理，深藍色主題。
* **`cost.html` (成本系統)**：針對專案支出進行多廠商、多明細的成本登錄，綠色主題。
* **`accounting.html` (帳務系統)**：一般會計帳務、行政支出或無來源單據之款項紀錄，橘色主題。

---

## 2. Google Sheet 資料庫結構

資料儲存於雲端試算表，各工作表欄對應如下：

### 2.1 系統設定 (System Config)

| 欄位 | 名稱 | 說明 |
| :--- | :--- | :--- |
| A | 業務人員名單 | 供報價/成本系統選用 |
| B | 單位清單 | 供報價明細選用 |
| C | 廠商名單 | 供成本紀錄選用 |

### 2.2 報價紀錄 (Quotation Records)

| 欄位 | 代號 | 欄位名稱 | 說明 |
| :--- | :--- | :--- | :--- |
| A | Timestamp | 時間戳記 | |
| B | ID | 單號 | |
| C | Version | 版號 | |
| D | Date | 日期 | |
| E | Customer | 客戶/廠商 | |
| F | Project | 專案名稱 | |
| G | InternalID | 專案ID (內控) | |
| H | Sales | 業務人員 | |
| I | Mobile | 業務手機 | |
| J | LineID | LINE ID | |
| K | LineName | LINE 名稱 | |
| L | Subtotal | 未稅金額 | |
| M | Tax | 稅金 | |
| N | Total | 總金額 | |
| O | Note | 備註 | |
| P | Fax | 傳真 | [新增] 客戶傳真 |
| Q | Status | 狀態 | [新增] 已成交 (closed) / 未成交 (open) |
| R | JSON | 詳細資料(JSON) | 重要：所有還原資料皆儲存於此 |
| S | Link | 檔案連結 | |

### 2.3 成本紀錄 (Cost Records)

| 欄位 | 代號 | 欄位名稱 | 說明 |
| :--- | :--- | :--- | :--- |
| A | Timestamp | 時間戳記 | |
| B | ID | 成本單號 | (對應來源單號) |
| C | Version | 版號 | |
| D | Date | 日期 | |
| E | Project | 專案名稱(來源) | |
| F | Vendor | 廠商名稱 | |
| G | TaxID | 廠商統編 | |
| H | Invoice | 發票號碼 | |
| I | Sales | 業務人員 | |
| J | Mobile | 業務手機 | |
| K | Worker | 工務人員 | |
| L | Buyer | 採購人員 | |
| M | Subtotal | 未稅金額 | |
| N | Tax | 稅金 | |
| O | Total | 總金額 | |
| P | Note | 備註 | |
| Q | JSON | 詳細資料(JSON) | |
| R | AnalysisLink | 分析表連結 | |
| S | InvoiceLink | 發票連結 | |

---

## 3. 各模組操作導引

### 3.1 報價系統 (Quotation)

1. **ID 生成機制**：開啟新單時顯示「自動產生」，按下儲存成功後，系統會跳出正式的 **內控ID** 提醒，便於追蹤。
2. **統編自動化**：輸入 8 碼統編後點擊「查詢」，後端會自動檢索「公司、商業、分公司」資料庫並自動填入公司名稱。
3. **版本管理**：開啟歷史單據修改後存檔，系統會自動生成新版本（不覆蓋原紀錄）。
4. **已成交設定**：勾選「已成交」後，該專案才會同步至成本系統供選擇。
5. **連線測試**：新增「測試系統連線」按鈕，可用於診斷與後端 GAS 的通訊狀態。
6. **防呆格式**：電話欄位自動格式化 (09xx-xxx-xxx)。

### 3.2 成本系統 (Cost)

1. **多廠商支援**：可透過「增加廠商支出」按鈕，在同一張單據內登錄多筆不同廠商的費用。
2. **稅額自動計算**：輸入未稅金額後，系統自動算出 **1.05 倍** 含稅價。
3. **負數防呆**：系統會阻擋輸入負數金額，確保財務數據準確。
4. **發票上傳**：每一筆支出均可獨立拍照或上傳發票照片。

---

## 4. 系統部署與權限 (針對管理員)

若系統出現權限錯誤（如 `UrlFetchApp` 錯誤），請執行以下設定。

### 4.1 授權外部要求

進入 GAS 編輯器，在 `appsscript.json` (資訊清單) 中定義如下權限：

```json
"oauthScopes": [
  "https://www.googleapis.com/auth/spreadsheets",
  "https://www.googleapis.com/auth/script.external_request",
  "https://www.googleapis.com/auth/drive"
]
```

### 4.2 部署更新

每次修改 `doPost` 後，必須進行 **「新部署」** 並確認權限設定為 **「所有人」** 存取，否則前端網頁將無法成功上傳資料。

---

## 5. 常見問題 (FAQ)

* **Q: 為什麼統編查詢查不到？**
  * A: 請確認該公司是否有在經濟部合法登記，或檢查 GAS 原程式碼內的 API 網址是否正常連線。
* **Q: 修改歷史單據會影響舊資料嗎？**
  * A: 不會。系統會增加一列帶有新版號的紀錄，舊資枓會永久保留以備審核。
