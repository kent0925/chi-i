# 健益工程有限公司 - ERP 管理系統

## 系統簡介

本系統為健益工程有限公司開發的整合式工程管理系統，涵蓋報價、成本、會計三大核心功能，並整合 LINE LIFF 登入與 Google Sheets 作為資料庫。

### 核心功能

- **報價系統** - 客戶報價單建立、管理與圖片匯出
- **成本系統** - 工料分析、廠商管理與成本追蹤
- **會計系統** - 客戶應收、廠商應付、獎金分配管理
- **財務儀表板** - 即時專案財務概況與進度追蹤

---

## 系統架構

### 前端頁面

| 頁面 | 檔案 | 功能說明 |
|------|------|---------|
| 首頁 | `index.html` | 系統導航與財務儀表板 |
| 報價系統 | `quotation.html` | 客戶報價單建立與管理 |
| 成本系統 | `cost.html` | 工料分析與成本紀錄 |
| 會計系統 | `accounting.html` | 應收應付與獎金分配 |

### 後端服務

- **Google Apps Script** - `function doPost(e) {.js`
- **資料庫** - Google Sheets (4 個分頁)
- **外部 API** - 統編查詢、銀行代碼查詢

---

## 操作說明

### 1. 報價系統 (quotation.html)

#### 基本流程

1. **選擇專案** - 從歷史專案選擇或建立新專案
2. **填寫客戶資料** - 客戶名稱、統編、聯絡資訊
3. **新增報價項目** - 品名、數量、單位、單價
4. **預覽與匯出** - 產生 A4 格式報價單圖片

#### 特殊功能

- **統編查詢** - 自動查詢公司名稱（政府開放資料）
- **追加報價** - 勾選「追加」產生 A 版、B 版報價單
- **圖片下載** - 自動儲存至 Google Drive 並下載

#### 注意事項

- 業務人員名單由系統設定統一管理，前端無法新增
- 報價單號格式：`YYYYMMDD0001` 或 `YYYYMMDD0001A`（追加）

---

### 2. 成本系統 (cost.html)

#### 基本流程

1. **選擇專案** - 選擇對應的報價專案
2. **新增廠商區塊** - 填寫廠商統編、名稱、發票號碼
3. **新增成本項目** - 品名、數量、單位、單價
4. **指定人員** - 工務人員、採購人員
5. **預覽與提交** - 產生成本單圖片並儲存

#### 特殊功能

- **統編查詢** - 自動查詢廠商名稱
- **發票驗證** - 檢查發票/收據必填
- **人員防呆** - 避免重複新增相同人員
- **圖片組織** - 自動建立 `YYYYMMDD_客戶_專案` 子資料夾

#### 注意事項

- 工務、採購人員共用系統設定的人員名單
- 每個廠商區塊可包含多個成本項目

---

### 3. 會計系統 (accounting.html)

#### 三大功能區塊

##### 3.1 客戶應收

- **匯款** - 銀行代碼、帳號、匯款日期、金額
- **支票** - 銀行代碼、帳號、支票號碼、金額
- **現金** - 收款人、金額、日期

**銀行代碼查詢**：輸入代碼（如 `4` 或 `004`）自動顯示銀行名稱

##### 3.2 廠商應付

- 選擇廠商（來自成本紀錄）
- 填寫付款金額、日期
- 發票驗證（比對成本紀錄）

##### 3.3 獎金分配

- 自動載入專案人員（業務、工務、採購）
- 顯示應收、應付、毛利 (皆為未稅金額)
- 自動計算分配比例與金額

**分配規則**：

- 業務 25%、工務 25%、採購 15%、公司 35%
- 若無工務或採購，其份額平均分配給其他角色
- 若僅有業務，則業務與公司各 50%

#### 注意事項

- 專案人員名單嚴格來自報價與成本系統，無法手動新增
- 廠商清單嚴格來自成本紀錄，無法手動新增

---

### 4. 財務儀表板 (index.html)

#### 顯示內容

- **專案名稱** - 進行中的專案
- **毛利** - 未稅應收 - 未稅應付
- **毛利率** - (毛利 / 未稅應收) × 100%
- **收款進度** - 已收款 / 總應收（含稅）
- **付款進度** - 已付款 / 總應付（含稅）

#### 資料來源

- 報價紀錄 → 應收金額
- 成本紀錄 → 應付金額
- 會計紀錄 → 實際收付款

---

## Google Sheets 資料結構

### 1. 系統設定 (Sheet: "系統設定")

| 欄位 | 說明 | 範例 |
|------|------|------|
| A 欄 | 人員名單（共用） | 王小明 |
| B 欄 | 單位清單 | 式、組、個 |
| C 欄 | 廠商名單 | 廠商 A |

**用途**：

- 人員名單供業務、工務、採購共用
- 單位清單供報價與成本系統使用
- 廠商名單供成本系統參考

---

### 2. 報價紀錄 (Sheet: "報價紀錄")

| 欄位 | Index | 說明 | 範例 |
|------|-------|------|------|
| A | 0 | 時間戳記 | 2026-01-28 12:00:00 |
| B | 1 | 單號 | 202601280001 |
| C | 2 | 版本 | A（追加版本） |
| D | 3 | 日期 | 2026/01/28 |
| E | 4 | 客戶 | ABC 公司 |
| F | 5 | 專案名稱 | 辦公室裝修 |
| G | 6 | 內部專案 ID | 202601280001 |
| H | 7 | 業務人員 | 王小明 |
| I | 8 | 業務電話 | 0912-345-678 |
| J | 9 | LINE ID | user123 |
| K | 10 | LINE 名稱 | 王小明 |
| L | 11 | 小計（未稅） | 100000 |
| M | 12 | 稅金 | 5000 |
| N | 13 | 總計（含稅） | 105000 |
| O | 14 | 備註 | - |
| P | 15 | 傳真 | 02-1234-5678 |
| Q | 16 | 狀態 | 已送出 |
| R | 17 | JSON 詳細資料 | `{"items":[...]}` |
| S | 18 | 圖片 URL | <https://drive.google.com/>... |

**JSON 結構**：

```json
{
  "items": [
    {
      "name": "項目名稱",
      "qty": 10,
      "unit": "式",
      "price": 1000,
      "total": 10000
    }
  ],
  "note": "備註說明",
  "chineseAmount": "壹拾萬伍仟元整"
}
```

---

### 3. 成本紀錄 (Sheet: "成本紀錄")

| 欄位 | Index | 說明 | 範例 |
|------|-------|------|------|
| A | 0 | 時間戳記 | 2026-01-28 12:00:00 |
| B | 1 | 成本單號 | C202601280001 |
| C | 2 | 版本 | - |
| D | 3 | 日期 | 2026/01/28 |
| E | 4 | 專案名稱 | 辦公室裝修 |
| F | 5 | 廠商名稱 | 材料行 A |
| G | 6 | 統一編號 | 12345678 |
| H | 7 | 發票號碼 | AB12345678 |
| I | 8 | 業務人員 | 王小明 |
| J | 9 | 業務電話 | 0912-345-678 |
| K | 10 | 工務人員 | 李大華, 陳小明 |
| L | 11 | 採購人員 | 張三, 李四 |
| M | 12 | 小計（未稅） | 50000 |
| N | 13 | 稅金 | 2500 |
| O | 14 | 總計（含稅） | 52500 |
| P | 15 | 摘要 | 材料費用 |
| Q | 16 | JSON 詳細資料 | `{"vendors":[...]}` |
| R | 17 | 圖片 URL | <https://drive.google.com/>... |
| S | 18 | 發票圖片 URL | <https://drive.google.com/>... |

**JSON 結構**：

```json
{
  "vendors": [
    {
      "name": "材料行 A",
      "taxId": "12345678",
      "invNo": "AB12345678",
      "items": [
        {
          "name": "水泥",
          "qty": 10,
          "unit": "包",
          "price": 500,
          "total": 5000
        }
      ],
      "subtotal": 50000
    }
  ],
  "workers": ["李大華", "陳小明"],
  "buyers": ["張三", "李四"]
}
```

---

### 4. 會計紀錄 (Sheet: "會計紀錄")

| 欄位 | Index | 說明 | 範例 |
|------|-------|------|------|
| A | 0 | 時間戳記 | 2026-01-28 12:00:00 |
| B | 1 | 會計單號 | ACC202601280001 |
| C | 2 | 類型 | receivable / payable |
| D | 3 | 日期 | 2026/01/28 |
| E | 4 | 專案名稱 | 辦公室裝修 |
| F | 5 | 金額 | 50000 |
| G | 6 | 客戶/廠商 | ABC 公司 |
| H | 7 | JSON 詳細資料 | `{"accType":"receivable",...}` |

**JSON 結構（應收）**：

```json
{
  "accType": "receivable",
  "method": "remittance",
  "bankCode": "004",
  "bankName": "臺灣銀行",
  "account": "1234567890",
  "remittanceDate": "2026-01-28",
  "amount": 50000
}
```

**JSON 結構（應付）**：

```json
{
  "accType": "payable",
  "vendor": "材料行 A",
  "amount": 30000,
  "date": "2026-01-28",
  "invoiceNo": "AB12345678",
  "validated": true
}
```

---

## API 端點說明

### GET 端點

#### 1. 預設端點（無 action 參數）

**URL**: `{GAS_URL}`  
**回傳**:

```json
{
  "sales": ["王小明", "李大華"],
  "units": ["式", "組", "個"],
  "vendors": ["廠商A", "廠商B"],
  "workers": ["王小明", "李大華"],
  "buyers": ["王小明", "李大華"],
  "nextProjectId": "202601280001",
  "projects": [...],
  "costs": [...]
}
```

#### 2. 統編查詢

**URL**: `{GAS_URL}?action=lookup&taxId=12345678`  
**回傳**:

```json
{
  "name": "公司名稱",
  "taxId": "12345678",
  "source": "history",
  "error": ""
}
```

#### 3. 銀行代碼清單

**URL**: `{GAS_URL}?action=getBanks`  
**回傳**:

```json
[
  {"code": "004", "name": "臺灣銀行"},
  {"code": "700", "name": "中華郵政"}
]
```

#### 4. 全局財務概況

**URL**: `{GAS_URL}?action=getGlobalFinancials`  
**回傳**:

```json
[
  {
    "name": "專案名稱",
    "recNoTax": 100000,
    "payNoTax": 50000,
    "recGrand": 105000,
    "payGrand": 52500,
    "received": 50000,
    "paid": 20000
  }
]
```

#### 5. 專案財務詳情

**URL**: `{GAS_URL}?action=getProjectFinancials&projectId=辦公室裝修`  
**回傳**:

```json
{
  "customer": "ABC公司",
  "sales": "王小明",
  "receivable": 105000,
  "receivableNoTax": 100000,
  "payable": 52500,
  "payableNoTax": 50000,
  "invoices": [...],
  "vendors": ["廠商A"],
  "workers": ["李大華"],
  "buyers": ["張三"]
}
```

### POST 端點

#### 1. 儲存系統設定

```json
{
  "action": "save_config",
  "configType": "sales|unit|vendor",
  "value": "新增項目"
}
```

#### 2. 儲存報價單

```json
{
  "type": "quotation",
  "data": {...}
}
```

#### 3. 儲存成本單

```json
{
  "type": "cost",
  "data": {...}
}
```

#### 4. 儲存會計紀錄

```json
{
  "type": "accounting",
  "data": {...}
}
```

---

## 系統配置

### LIFF ID

```javascript
const LIFF_ID = '2008974069-Ecojk6W1';
```

### GAS URL

```javascript
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxrXo9AcczzlIazBPTqxZij7CVAcqcXtbbpGJMKQ4RoEFRp8JsTtjLZw1R6xZwwvnnt/exec';
```

### Google Drive 資料夾 ID

- **報價圖片**: `1Iy_gXTgPfKxmDpjqgWwZxhDNJqNGJqzn`
- **成本圖片**: `1Iy_gXTgPfKxmDpjqgWwZxhDNJqNGJqzn`
- **發票圖片**: `1Iy_gXTgPfKxmDpjqgWwZxhDNJqNGJqzn`

---

## 常見問題

### Q1: 銀行代碼查詢顯示「查無」？

**A**: 系統會自動補零，輸入 `4` 會自動轉為 `004`。若仍查無，請確認代碼正確性。

### Q2: 獎金分配人員名單無法修改？

**A**: 人員名單嚴格來自報價與成本系統，確保分配對象與實際參與人員一致。

### Q3: 廠商清單無法手動新增？

**A**: 廠商清單來自成本紀錄，請先在成本系統建立廠商資料。

### Q4: 圖片無法下載？

**A**: 請確認 Google Drive 權限設定，並檢查瀏覽器是否允許下載。

### Q5: 載入速度較慢？

**A**: 系統已優化為僅載入最近 150 筆資料，若仍慢請檢查網路連線。

---

## 技術支援

### 系統維護

- 定期檢查 Google Sheets 資料完整性
- 清理過期的圖片檔案
- 更新銀行代碼清單（自動）

### 錯誤處理

- 所有錯誤會記錄在瀏覽器 Console
- 錯誤訊息包含詳細資訊供除錯
- 建議使用 Chrome DevTools 檢查

---

## 版本資訊

**版本**: 2.1  
**最後更新**: 2026-01-28  
**開發者**: Google Deepmind Antigravity  
**公司**: 健益工程有限公司

---

## 授權聲明

本系統為健益工程有限公司專屬使用，未經授權不得複製或散布。
