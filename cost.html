<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工程管理 - 成本系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        emerald: {
                            50: '#ecfdf5',
                            100: '#d1fae5',
                            600: '#059669',
                            700: '#047857',
                            800: '#065f46',
                            900: '#064e3b',
                        },
                        teal: {
                            600: '#0d9488',
                            700: '#0f766e',
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                        serif: ['Noto Serif TC', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f1f5f9;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .preview-canvas {
            font-family: 'Noto Serif TC', serif;
            background: white;
            color: #333;
            line-height: 1.6;
        }

        /* Custom Scrollbar for preview modal */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Sticky Footer Animation */
        .sticky-footer-enter {
            transform: translateY(100%);
            opacity: 0;
        }

        .sticky-footer-enter-active {
            transform: translateY(0);
            opacity: 1;
            transition: all 0.3s ease-out;
        }

        /* Mobile Optimization: Prevent iOS Zoom */
        @media (max-width: 768px) {

            input,
            select,
            textarea {
                font-size: 16px !important;
            }

            .container {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen pb-32">
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="text-center">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl text-emerald-600 mb-4"></i>
            <p class="text-emerald-800 font-bold tracking-widest animate-pulse">資料載入中...</p>
        </div>
    </div>

    <!-- Header Background -->
    <div class="fixed top-0 left-0 w-full h-64 bg-gradient-to-br from-emerald-900 via-emerald-800 to-teal-800 -z-10">
    </div>

    <div class="max-w-6xl mx-auto px-4 pt-6">

        <!-- Header Card -->
        <div
            class="bg-white/10 backdrop-blur-md rounded-2xl p-6 text-white shadow-xl border border-white/20 mb-8 flex flex-col md:flex-row justify-between items-center gap-4 relative overflow-hidden">
            <!-- Decorative Pattern -->
            <div
                class="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -translate-y-1/2 translate-x-1/2 blur-3xl pointer-events-none">
            </div>

            <div class="flex items-center gap-5 z-10">
                <div class="bg-white/20 p-4 rounded-2xl shadow-inner backdrop-blur-md border border-white/10">
                    <i class="fa-solid fa-calculator text-3xl text-emerald-100"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-bold tracking-wide text-white drop-shadow-sm">工程成本分析系統</h1>
                    <p class="text-emerald-100/80 text-sm font-medium mt-1">Cost Management & Analysis</p>
                </div>
            </div>

            <div class="flex items-center gap-3 z-10">
                <!-- LIFF Profile -->
                <div id="liff-profile"
                    class="hidden flex items-center gap-3 bg-black/20 py-2 px-4 rounded-full border border-white/10 backdrop-blur-sm">
                    <img id="liff-picture" src="" alt="Profile"
                        class="w-8 h-8 rounded-full border-2 border-white/30 shadow-sm">
                    <span id="liff-name" class="text-sm font-bold text-white tracking-wide">User</span>
                </div>

                <button onclick="location.href='index.html'"
                    class="group bg-white/10 hover:bg-white/20 text-white text-sm py-2 px-5 rounded-full border border-white/30 transition-all duration-300 flex items-center gap-2 shadow-lg hover:shadow-xl hover:-translate-y-0.5">
                    <i class="fa-solid fa-house group-hover:scale-110 transition-transform"></i>
                    <span>返回主選單</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-100 mb-8">

            <!-- Project Selection Section -->
            <div class="p-8 border-b border-gray-100 bg-gray-50/50">
                <div class="max-w-3xl mx-auto">
                    <label class="block text-emerald-800 text-xs font-bold uppercase tracking-wider mb-2 ml-1">
                        <i class="fa-solid fa-folder-open mr-1"></i> 選擇來源專案
                    </label>
                    <div class="relative">
                        <select id="projectSelect" onchange="fillProjectInfo(this.value)"
                            class="w-full pl-4 pr-10 py-3 bg-white border border-gray-200 rounded-xl text-gray-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all appearance-none cursor-pointer hover:border-emerald-300">
                            <option value="">-- 請選擇專案 --</option>
                        </select>
                        <div
                            class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-emerald-600">
                            <i class="fa-solid fa-chevron-down"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-8">
                <!-- Project Details Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Read-only Fields -->
                    <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100 shadow-sm">
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">客戶名稱</label>
                        <input type="text" id="customer" readonly
                            class="w-full bg-transparent border-0 p-0 text-gray-800 font-bold focus:ring-0 text-base"
                            placeholder="尚未選擇">
                    </div>
                    <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100 shadow-sm">
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">專案名稱</label>
                        <input type="text" id="projectName" readonly
                            class="w-full bg-transparent border-0 p-0 text-gray-800 font-bold focus:ring-0 text-base"
                            placeholder="尚未選擇">
                    </div>
                    <div
                        class="bg-emerald-50 rounded-2xl p-4 border border-emerald-100 shadow-sm relative overflow-hidden group">
                        <div
                            class="absolute right-0 top-0 p-4 text-emerald-100 group-hover:text-emerald-200 transition-colors">
                            <i class="fa-solid fa-user-tie text-4xl transform translate-x-2 -translate-y-2"></i>
                        </div>
                        <label
                            class="block text-xs font-bold text-emerald-600 uppercase mb-1 relative z-10">負責業務</label>
                        <input type="text" id="costSalesPerson" readonly
                            class="w-full bg-transparent border-0 p-0 text-emerald-900 font-bold focus:ring-0 text-base relative z-10"
                            placeholder="尚未選擇">
                    </div>
                </div>

                <!-- Personnel Section -->
                <div class="mb-10">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <span class="w-1 h-6 bg-emerald-500 rounded-full"></span>
                            專案人員配置
                        </h3>
                        <div class="flex gap-2">
                            <button onclick="addPerson('worker')"
                                class="px-3 py-1.5 bg-yellow-50 text-yellow-700 hover:bg-yellow-100 rounded-lg text-xs font-bold border border-yellow-200 transition-colors flex items-center gap-1">
                                <i class="fa-solid fa-hard-hat"></i> 工務
                            </button>
                            <button onclick="addPerson('buyer')"
                                class="px-3 py-1.5 bg-blue-50 text-blue-700 hover:bg-blue-100 rounded-lg text-xs font-bold border border-blue-200 transition-colors flex items-center gap-1">
                                <i class="fa-solid fa-cart-shopping"></i> 採購
                            </button>
                        </div>
                    </div>
                    <div id="person-container"
                        class="space-y-2 min-h-[40px] p-4 bg-gray-50 rounded-2xl border border-dashed border-gray-300 flex flex-wrap gap-3 items-center">
                        <span class="text-sm text-gray-400 italic w-full text-center"
                            id="person-empty-msg">點擊右上方按鈕新增人員...</span>
                    </div>
                </div>

                <!-- Vendor Blocks Header -->
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <span
                            class="bg-emerald-100 text-emerald-700 w-8 h-8 rounded-full flex items-center justify-center text-sm shadow-sm"><i
                                class="fa-solid fa-file-invoice-dollar"></i></span>
                        支出明細
                    </h3>
                    <button onclick="addVendorBlock()"
                        class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg hover:shadow-emerald-500/30 transition-all transform hover:-translate-y-0.5 flex items-center gap-2">
                        <i class="fa-solid fa-plus"></i> 新增廠商支出
                    </button>
                </div>

                <!-- Vendor Items Container -->
                <div id="vendor-items-container" class="space-y-6">
                    <!-- Blocks injected here -->
                </div>

                <!-- Spacer for sticky footer -->
                <div class="h-24"></div>

            </div>
        </div>
    </div>

    <!-- Sticky Bottom Footer Summary -->
    <div class="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-xl border-t border-gray-200 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] z-40 transition-transform duration-300"
        id="sticky-footer">
        <div class="max-w-6xl mx-auto px-6 py-4 flex flex-col md:flex-row items-center justify-between gap-4">

            <div class="flex items-center gap-6 text-sm text-gray-600">
                <div class="hidden md:block">
                    <span class="block text-xs uppercase tracking-wider text-gray-400 mb-1">筆數</span>
                    <span class="font-bold text-lg text-gray-800"><span id="item-count">0</span> <span
                            class="text-xs font-normal">筆</span></span>
                </div>
                <div class="h-8 w-px bg-gray-200 hidden md:block"></div>
                <div>
                    <span class="block text-xs uppercase tracking-wider text-gray-400 mb-1">未稅總額</span>
                    <span class="font-bold text-lg text-gray-800 tracking-tight" id="total-untax">$ 0</span>
                </div>
                <div class="hidden sm:block">
                    <span class="block text-xs uppercase tracking-wider text-gray-400 mb-1">稅額 (5%)</span>
                    <span class="font-bold text-lg text-gray-800 tracking-tight" id="total-tax">$ 0</span>
                </div>
            </div>

            <div class="flex items-center gap-6 w-full md:w-auto">
                <div class="text-right flex-1 md:flex-none">
                    <span class="block text-xs font-bold text-emerald-600 uppercase tracking-wider mb-0.5">總計金額
                        (含稅)</span>
                    <span class="text-2xl font-bold text-emerald-700 tracking-tight font-mono" id="total-inc">$ 0</span>
                </div>

                <button onclick="generatePreview()" id="btn-submit"
                    class="bg-gray-800 hover:bg-gray-900 text-white px-8 py-3 rounded-xl font-bold text-sm shadow-xl hover:shadow-2xl transition-all transform hover:-translate-y-1 flex items-center gap-2 whitespace-nowrap">
                    <span>預覽確認</span>
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title"
        role="dialog" aria-modal="true">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-gray-900/75 backdrop-blur-sm transition-opacity"
            onclick="document.getElementById('preview-modal').classList.add('hidden')"></div>

        <div class="flex min-h-screen items-center justify-center p-4 text-center sm:p-0">
            <div
                class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 w-full max-w-4xl flex flex-col max-h-[90vh]">

                <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-gray-900" id="modal-title"><i
                            class="fa-solid fa-magnifying-glass-chart mr-2 text-emerald-600"></i>成本表預覽</h3>
                    <button onclick="document.getElementById('preview-modal').classList.add('hidden')"
                        class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>

                <div class="flex-1 overflow-auto bg-gray-100 p-6 flex justify-center items-start">
                    <div id="cost-canvas" class="preview-canvas bg-white p-12 shadow-lg relative mx-auto shrink-0"
                        style="width: 210mm; min-height: 297mm;">
                        <!-- Preview Content Injected Here -->
                    </div>
                </div>

                <div class="bg-white px-6 py-4 border-t border-gray-200 flex gap-3 justify-end">
                    <button onclick="document.getElementById('preview-modal').classList.add('hidden')"
                        class="px-5 py-2.5 rounded-lg border border-gray-300 bg-white text-gray-700 font-bold hover:bg-gray-50 transition-colors">
                        返回修改
                    </button>
                    <button onclick="testDownloadImage()"
                        class="px-5 py-2.5 rounded-lg border border-purple-300 bg-purple-50 text-purple-700 font-bold hover:bg-purple-100 transition-colors"><i
                            class="fa-solid fa-image mr-1"></i> 測試圖檔</button>
                    <button onclick="executeSubmission()"
                        class="px-5 py-2.5 rounded-lg bg-emerald-600 text-white font-bold shadow hover:bg-emerald-700 transition-colors flex items-center gap-2">
                        <i class="fa-solid fa-check"></i> 確認上傳
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Datalists -->
    <datalist id="vendor-list"></datalist>
    <datalist id="sales-list"></datalist>

    <script>
        const LIFF_ID = '2008974069-Ecojk6W1';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxrXo9AcczzlIazBPTqxZij7CVAcqcXtbbpGJMKQ4RoEFRp8JsTtjLZw1R6xZwwvnnt/exec';
        let salesPersons = [];
        let vendors = [];
        let projectList = [];
        let costList = [];
        let lineUser = null;

        window.onload = function () {
            initializeLiff();
            fetchConfig();
        };

        async function initializeLiff() {
            if (LIFF_ID === 'YOUR_LIFF_ID') return;
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    lineUser = profile;
                    document.getElementById('liff-profile').classList.remove('hidden');
                    document.getElementById('liff-profile').classList.add('flex');
                    document.getElementById('liff-picture').src = profile.pictureUrl;
                    document.getElementById('liff-name').innerText = profile.displayName;
                } else {
                    liff.login();
                }
            } catch (e) {
                console.error('LIFF Init Error', e);
            }
        }

        function fetchConfig() {
            fetch(GAS_URL)
                .then(res => res.json())
                .then(data => {
                    salesPersons = data.sales || [];
                    vendors = data.vendors || [];
                    projectList = data.projects || [];
                    costList = data.costs || [];

                    fillProjectSelect();
                    renderVendorList();
                    renderSalesList();

                    if (document.querySelectorAll('.vendor-block').length === 0) {
                        addVendorBlock();
                    }
                    // Hide Loading
                    const overlay = document.getElementById('loading-overlay');
                    if (overlay) {
                        overlay.style.opacity = '0';
                        setTimeout(() => overlay.remove(), 500);
                    }
                })
                .catch(err => {
                    console.error("GAS Error", err);
                    // Fallback for UI testing if GAS fails
                    addVendorBlock();
                    // Hide Loading even on error
                    const overlay = document.getElementById('loading-overlay');
                    if (overlay) {
                        overlay.style.opacity = '0';
                        setTimeout(() => overlay.remove(), 500);
                    }
                });
        }

        function fillProjectSelect() {
            const sel = document.getElementById('projectSelect');
            const activeProjects = projectList.filter(p => p.status === 'closed' || p.status === '已成交');

            if (activeProjects.length === 0 && projectList.length > 0) {
                sel.innerHTML = '<option value="">-- 無已成交專案 --</option>';
                return;
            }

            sel.innerHTML = '<option value="">-- 請選擇來源專案 --</option>' +
                activeProjects.map(p => {
                    const label = `${p.date} ${p.customer} (${p.project})`;
                    return `<option value="${p.id}">${label}</option>`;
                }).join('');
        }

        function renderVendorList() {
            const list = document.getElementById('vendor-list');
            list.innerHTML = vendors.map(v => `<option value="${v}">`).join('');
        }

        function renderSalesList() {
            const list = document.getElementById('sales-list');
            list.innerHTML = salesPersons.map(s => `<option value="${s}">`).join('');
        }

        function fillProjectInfo(id) {
            const p = projectList.find(x => x.id === id);
            const container = document.getElementById('vendor-items-container');
            const personContainer = document.getElementById('person-container');

            container.innerHTML = '';
            personContainer.innerHTML = '<span class="text-sm text-gray-400 italic w-full text-center" id="person-empty-msg">點擊右上方按鈕新增人員...</span>';

            if (p) {
                document.getElementById('customer').value = p.customer;
                document.getElementById('projectName').value = p.project;
                document.getElementById('costSalesPerson').value = p.sales || "";
                if (p.salesMobile) document.getElementById('costSalesPerson').dataset.mobile = p.salesMobile;

                const existing = costList.filter(c => c.project === p.project);
                if (existing.length > 0) {
                    const latestId = existing[0].id; // costList reversed in GAS usually
                    const batch = existing.filter(c => c.id === latestId);

                    batch.forEach(item => {
                        let details = {};
                        try { details = JSON.parse(item.json); } catch (e) { }
                        addVendorBlock(details);
                    });

                    // Restore Persons
                    const first = batch[0] || {};
                    let firstJson = {};
                    try { firstJson = JSON.parse(first.json); } catch (e) { }

                    if (firstJson.worker) {
                        if (typeof firstJson.worker === 'string') firstJson.worker.split(',').forEach(w => addPerson('worker', w.trim()));
                        else if (Array.isArray(firstJson.worker)) firstJson.worker.forEach(w => addPerson('worker', w));
                    }
                    if (firstJson.buyer) {
                        if (typeof firstJson.buyer === 'string') firstJson.buyer.split(',').forEach(b => addPerson('buyer', b.trim()));
                        else if (Array.isArray(firstJson.buyer)) firstJson.buyer.forEach(b => addPerson('buyer', b));
                    }

                } else {
                    addVendorBlock();
                }
            } else {
                document.getElementById('customer').value = "";
                document.getElementById('projectName').value = "";
                document.getElementById('costSalesPerson').value = "";
                addVendorBlock();
            }
            updateCount();
            calcTotal();
        }

        function addVendorBlock(data = null) {
            const container = document.getElementById('vendor-items-container');
            const id = Date.now() + Math.random().toString(16).slice(2);
            const div = document.createElement('div');

            // New Card Design
            div.className = "vendor-block bg-white p-6 rounded-2xl shadow-sm border border-gray-200 relative group hover:shadow-md transition-shadow duration-300";
            div.id = 'block-' + id;

            // Values
            const vName = data ? (data.vendorName || "") : "";
            const vTaxId = data ? (data.vendorTaxId || "") : "";
            const vSummary = data ? (data.costSummary || data.summary || "") : "";
            const vUntax = data ? (data.subtotalNoTax || "") : "";
            const vTax = data ? (data.taxAmount || "") : "";
            const vInc = data ? (data.grandTotal || "") : "";
            const vInv = data ? (data.invoiceNo || "") : "";

            div.innerHTML = `
                <div class="absolute top-4 right-4 z-10">
                    <button onclick="removeBlock('${id}')" class="text-gray-300 hover:text-red-500 transition-colors p-2 rounded-full hover:bg-red-50" title="刪除此筆">
                        <i class="fa-solid fa-trash-can text-lg"></i>
                    </button>
                </div>

                <div class="space-y-6">
                    <!-- Row 1: Tax ID & Vendor Name -->
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                         <div class="md:col-span-4">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">統一編號 (8碼)</label>
                            <div class="relative">
                                <input type="text" value="${vTaxId}" class="v-tax w-full border border-gray-200 rounded-lg p-2.5 text-sm tracking-widest focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all font-mono" placeholder="12345678" maxlength="8" onchange="lookupBlockVendor(this)">
                                <span class="v-msg hidden absolute right-2 top-3 text-[10px] text-emerald-600 font-bold bg-emerald-50 px-1 rounded animate-pulse">
                                    <i class="fa-solid fa-circle-notch fa-spin mr-1"></i>查詢中
                                </span>
                            </div>
                        </div>
                        <div class="md:col-span-8">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">廠商名稱 / 對象</label>
                            <div class="relative">
                                <span class="absolute left-3 top-3 text-gray-400"><i class="fa-solid fa-store"></i></span>
                                <input type="text" value="${vName}" class="v-name w-full pl-9 border border-gray-200 rounded-lg p-2.5 text-sm font-bold text-gray-800 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all" list="vendor-list" placeholder="輸入或選擇廠商">
                            </div>
                        </div>
                    </div>
                
                    <!-- Row 2: Summary -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">支出摘要 <span class="text-red-500">*</span></label>
                        <input type="text" value="${vSummary}" class="v-summary w-full border border-gray-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all" placeholder="請輸入本筆支出的用途說明...">
                    </div>

                    <!-- Row 3: Amounts -->
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">未稅金額 <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="text-gray-400 font-bold">$</span>
                                    </div>
                                    <input type="number" value="${vUntax}" class="v-untax w-full pl-7 border border-emerald-200 rounded-lg p-2 text-right font-mono text-gray-800 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all" placeholder="0" oninput="calcRow(this)">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">稅金 (5%)</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="text-gray-400 font-bold">$</span>
                                    </div>
                                    <input type="number" value="${vTax}" class="v-tax-amt w-full pl-7 border border-gray-200 bg-gray-100 rounded-lg p-2 text-right font-mono text-gray-500 cursor-not-allowed hidden-arrow" readonly tabindex="-1">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-emerald-600 uppercase mb-1">含稅總計</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="text-emerald-500 font-bold">$</span>
                                    </div>
                                    <input type="number" value="${vInc}" class="v-inc w-full pl-7 border border-emerald-200 bg-emerald-50 rounded-lg p-2 text-right font-mono font-bold text-emerald-700 cursor-not-allowed hidden-arrow" readonly tabindex="-1">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer: Invoice & File -->
                <div class="mt-4 pt-4 border-t border-gray-100 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-xs font-bold text-gray-500 uppercase">發票 / 收據號碼</label>
                            <div class="flex gap-3 text-xs">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="invType-${id}" value="invoice" class="text-emerald-500 focus:ring-emerald-500 v-inv-type" ${!data || data.invoiceType !== 'receipt' ? 'checked' : ''} onchange="toggleInvoiceType(this)">
                                    <span class="ml-1 text-gray-600 font-bold">發票</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="invType-${id}" value="receipt" class="text-emerald-500 focus:ring-emerald-500 v-inv-type" ${data && data.invoiceType === 'receipt' ? 'checked' : ''} onchange="toggleInvoiceType(this)">
                                    <span class="ml-1 text-gray-600 font-bold">收據</span>
                                </label>
                            </div>
                        </div>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-400"><i class="fa-solid fa-receipt"></i></span>
                            <input type="text" value="${vInv}" class="v-inv w-full pl-9 border border-gray-200 rounded-lg p-2 text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all ${data && data.invoiceType === 'receipt' ? 'bg-gray-50' : ''}" placeholder="${data && data.invoiceType === 'receipt' ? '收據免填' : 'EX: AB-12345678'}">
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-xs font-bold text-gray-500 uppercase">單據照片 / 掃描檔 <span class="text-red-500">*</span></label>
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" class="v-error text-red-500 focus:ring-red-500 rounded border-gray-300" ${data && data.isError ? 'checked' : ''}>
                                <span class="ml-1 text-xs font-bold text-red-500">錯誤</span>
                            </label>
                        </div>
                        
                        <div class="file-upload-container">
                            <label class="flex items-center gap-3 px-4 py-2 bg-white border border-dashed border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 hover:border-emerald-400 transition-all group ${data && data.invoiceImage ? 'hidden' : ''}" id="upload-label-${id}">
                                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-emerald-100 transition-colors">
                                    <i class="fa-solid fa-cloud-arrow-up text-gray-500 group-hover:text-emerald-600"></i>
                                </div>
                                <div class="flex-1">
                                    <span class="text-xs text-gray-500 block truncate file-name-display">點擊上傳檔案...</span>
                                </div>
                                <input type="file" class="v-file hidden" onchange="updateFileName(this)">
                            </label>

                             <div class="flex items-center gap-2 ${data && data.invoiceImage ? '' : 'hidden'}" id="file-info-${id}">
                                ${data && data.invoiceImage ?
                    `<a href="${data.invoiceImage}" target="_blank" class="flex-1 flex items-center gap-2 px-3 py-2 bg-emerald-50 rounded-lg text-xs font-bold text-emerald-700 hover:bg-emerald-100 transition-colors">
                                        <i class="fa-solid fa-image"></i>
                                        查看原圖
                                    </a>` :
                    `<span class="flex-1 flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg text-xs font-bold text-gray-700 file-name-text"></span>`
                }
                                <button onclick="removeFile(this)" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="刪除檔案">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                            <input type="hidden" class="v-has-saved-image" value="${data && data.invoiceImage ? 'true' : 'false'}">
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        function removeBlock(id) {
            const block = document.getElementById('block-' + id);
            block.remove();
            updateCount();
            calcTotal();
        }

        function toggleInvoiceType(radio) {
            const block = radio.closest('.vendor-block');
            const invInput = block.querySelector('.v-inv');

            if (radio.value === 'receipt') {
                invInput.placeholder = "收據免填";
                invInput.classList.add('bg-gray-50');
            } else {
                invInput.placeholder = "EX: AB-12345678";
                invInput.classList.remove('bg-gray-50');
            }
        }

        function updateFileName(input) {
            if (input.files && input.files[0]) {
                const container = input.closest('.file-upload-container');
                const uploadLabel = container.querySelector('label');
                const fileInfo = container.querySelector('div[id^="file-info-"]');
                const fileNameText = fileInfo.querySelector('.file-name-text');

                uploadLabel.classList.add('hidden');
                fileInfo.classList.remove('hidden');

                // Re-create the structure for new file if needed (since "View Original" might be there)
                if (!fileNameText) {
                    // If it was a link before, we replace it with text span
                    const link = fileInfo.querySelector('a');
                    if (link) link.remove();

                    const span = document.createElement('span');
                    span.className = "flex-1 flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg text-xs font-bold text-gray-700 file-name-text";
                    fileInfo.insertBefore(span, fileInfo.firstChild);
                    span.textContent = input.files[0].name;
                } else {
                    fileNameText.textContent = input.files[0].name;
                }
            }
        }

        function removeFile(btn) {
            const container = btn.closest('.file-upload-container');
            const input = container.querySelector('.v-file');
            const uploadLabel = container.querySelector('label');
            const fileInfo = container.querySelector('div[id^="file-info-"]');
            const hasSavedInput = container.querySelector('.v-has-saved-image');

            input.value = ''; // Clear file input
            hasSavedInput.value = 'false'; // Mark as no saved image

            fileInfo.classList.add('hidden');
            uploadLabel.classList.remove('hidden');

            // Clean up file info content to reset to empty state
            const fileNameText = fileInfo.querySelector('.file-name-text');
            if (fileNameText) fileNameText.textContent = '';

            // Also remove "View Original" link if present, to be safe, though hiding works too
            const link = fileInfo.querySelector('a');
            if (link) {
                link.remove();
                // Add back empty span for next time
                const span = document.createElement('span');
                span.className = "flex-1 flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg text-xs font-bold text-gray-700 file-name-text";
                fileInfo.insertBefore(span, fileInfo.firstChild);
            }
        }

        function updateCount() {
            document.getElementById('item-count').innerText = document.querySelectorAll('.vendor-block').length;
        }

        function calcRow(input) {
            const block = input.closest('.vendor-block');
            const unTax = parseFloat(input.value) || 0;
            const tax = Math.round(unTax * 0.05);
            const inc = unTax + tax;

            block.querySelector('.v-tax-amt').value = tax;
            block.querySelector('.v-inc').value = inc;
            calcTotal();
        }

        function calcTotal() {
            let totalUnTax = 0;
            let totalTax = 0;
            let totalInc = 0;

            document.querySelectorAll('.vendor-block').forEach(b => {
                totalUnTax += parseFloat(b.querySelector('.v-untax').value) || 0;
                totalTax += parseFloat(b.querySelector('.v-tax-amt').value) || 0;
                totalInc += parseFloat(b.querySelector('.v-inc').value) || 0;
            });

            document.getElementById('total-untax').innerText = "$ " + totalUnTax.toLocaleString();
            document.getElementById('total-tax').innerText = "$ " + totalTax.toLocaleString();
            document.getElementById('total-inc').innerText = "$ " + totalInc.toLocaleString();
        }

        async function lookupBlockVendor(input) {
            const val = input.value.trim();
            if (val.length !== 8) return;

            const block = input.closest('.vendor-block');
            const msg = block.querySelector('.v-msg');
            const nameInput = block.querySelector('.v-name');

            msg.classList.remove('hidden');

            try {
                const res = await fetch(`${GAS_URL}?action=lookup&taxId=${val}`);
                const data = await res.json();
                if (data.name) {
                    nameInput.value = data.name;
                    if (!vendors.includes(data.name)) vendors.push(data.name);
                } else {
                    // Optional: Toast or small alert
                }
            } catch (e) { console.error(e); }

            msg.classList.add('hidden');
        }

        function addPerson(type, content = "") {
            const container = document.getElementById('person-container');
            const emptyMsg = document.getElementById('person-empty-msg');
            if (emptyMsg) emptyMsg.style.display = 'none';

            const div = document.createElement('div');
            // Tag Style
            const isWorker = type === 'worker';
            const colorClass = isWorker ? 'bg-yellow-100 text-yellow-800 border-yellow-200' : 'bg-blue-100 text-blue-800 border-blue-200';
            const icon = isWorker ? 'fa-hard-hat' : 'fa-cart-shopping';

            const options = ['<option value="">請選擇</option>', ...salesPersons.map(s => {
                const selected = (s === content) ? 'selected' : '';
                return `<option value="${s}" ${selected}>${s}</option>`;
            })].join('');

            div.className = `flex items-center gap-2 px-3 py-1.5 rounded-full border shadow-sm person-row ${colorClass} animate-fade-in`;
            div.dataset.type = type;

            div.innerHTML = `
                <i class="fa-solid ${icon} text-xs opacity-70"></i>
                <select class="bg-transparent border-none text-sm font-bold focus:ring-0 p-0 pr-6 mr-1 cursor-pointer outline-none w-24">
                    ${options}
                </select>
                <button onclick="removePerson(this)" class="w-5 h-5 rounded-full bg-white/50 hover:bg-red-500 hover:text-white flex items-center justify-center transition-colors">
                    <i class="fa-solid fa-times text-[10px]"></i>
                </button>
            `;
            container.appendChild(div);
        }

        function removePerson(btn) {
            const row = btn.closest('.person-row');
            const container = row.parentNode;
            row.remove();
            if (container.children.length === 0 || (container.children.length === 1 && container.children[0].id === 'person-empty-msg')) {
                const emptyMsg = document.getElementById('person-empty-msg');
                if (emptyMsg) emptyMsg.style.display = 'inline';
            }
        }

        function getPersons(type) {
            const inputs = document.querySelectorAll(`.person-row[data-type="${type}"] select`);
            const vals = [];
            inputs.forEach(inp => {
                if (inp.value) vals.push(inp.value.trim());
            });
            return [...new Set(vals)].join(', ');
        }

        function validatePersonnel() {
            const groups = [];
            const s = document.getElementById('costSalesPerson').value.trim();
            if (s) groups.push({ name: s, role: '業務人員' });

            document.querySelectorAll('.person-row[data-type="worker"] select').forEach(inp => {
                if (inp.value) groups.push({ name: inp.value.trim(), role: '工務人員' });
            });
            document.querySelectorAll('.person-row[data-type="buyer"] select').forEach(inp => {
                if (inp.value) groups.push({ name: inp.value.trim(), role: '採購人員' });
            });

            const seen = {};
            for (let i = 0; i < groups.length; i++) {
                const item = groups[i];
                if (seen[item.name]) {
                    alert(`人員重複錯誤：${item.name} 同時出現在「${seen[item.name]}」與「${item.role}」。`);
                    return false;
                }
                seen[item.name] = item.role;
            }
            return true;
        }

        function generatePreview() {
            if (!validatePersonnel()) return;

            const projectId = document.getElementById('projectSelect').value;
            if (!projectId) return alert("請選擇來源專案");

            const blocks = document.querySelectorAll('.vendor-block');
            if (blocks.length === 0) return alert("請至少新增一筆支出");

            let isValid = true;
            blocks.forEach(b => {
                const summary = b.querySelector('.v-summary').value.trim();
                const amt = b.querySelector('.v-untax').value;
                if (!summary || !amt || parseFloat(amt) <= 0) isValid = false;
            });
            if (!isValid) return alert("請檢查「支出摘要」與「未稅金額」是否填寫正確");

            // Build Canvas Content
            const canvas = document.getElementById('cost-canvas');
            const dateStr = new Date().toLocaleDateString('zh-TW');
            const pName = document.getElementById('projectName').value;
            const pCust = document.getElementById('customer').value;
            const pSales = document.getElementById('costSalesPerson').value;
            const workers = getPersons('worker');
            const buyers = getPersons('buyer');

            let tableRows = '';
            blocks.forEach((b, idx) => {
                const vendor = b.querySelector('.v-name').value;
                const summary = b.querySelector('.v-summary').value;
                const grand = parseFloat(b.querySelector('.v-inc').value).toLocaleString();
                const inv = b.querySelector('.v-inv').value;

                tableRows += `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="py-3 px-2 text-center text-gray-500 font-mono">${idx + 1}</td>
                        <td class="py-3 px-2 font-bold text-gray-700">${vendor}<br><span class="text-[10px] text-gray-400 font-normal">${inv}</span></td>
                        <td class="py-3 px-2 text-gray-700">${summary}</td>
                        <td class="py-3 px-2 text-right font-mono font-bold text-gray-800">$ ${grand}</td>
                    </tr>
                `;
            });

            const totalStr = document.getElementById('total-inc').innerText;

            canvas.innerHTML = `
                <div class="text-center mb-8 relative">
                     <h2 class="text-3xl font-serif font-bold text-gray-800 mb-2">工程成本分析表</h2>
                     <div class="h-1 w-24 bg-emerald-600 mx-auto rounded-full mb-2"></div>
                     <p class="text-sm text-gray-500">列表日期: ${dateStr}</p>
                </div>
                
                <div class="flex justify-between mb-8 bg-gray-50 p-6 rounded-xl border border-gray-100">
                    <div class="space-y-1">
                        <p><span class="inline-block w-20 text-gray-500 font-bold text-sm">專案名稱</span> <span class="text-gray-800 font-bold border-b border-gray-300 pb-0.5">${pName}</span></p>
                        <p><span class="inline-block w-20 text-gray-500 font-bold text-sm">客戶名稱</span> <span class="text-gray-800">${pCust}</span></p>
                    </div>
                    <div class="text-right space-y-1">
                        <p><span class="text-gray-500 font-bold text-sm mr-2">業務人員</span> ${pSales}</p>
                        <p><span class="text-gray-500 font-bold text-sm mr-2">工務人員</span> ${workers || '-'}</p>
                        <p><span class="text-gray-500 font-bold text-sm mr-2">採購人員</span> ${buyers || '-'}</p>
                    </div>
                </div>
                
                <table class="w-full mb-8 text-sm">
                    <thead>
                        <tr class="bg-gray-800 text-white rounded-lg overflow-hidden">
                            <th class="py-2 px-2 w-12 rounded-tl-lg">No.</th>
                            <th class="py-2 px-2 text-left">廠商/收據</th>
                            <th class="py-2 px-2 text-left">支出摘要</th>
                            <th class="py-2 px-2 text-right rounded-tr-lg">含稅金額</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm">${tableRows}</tbody>
                </table>
                
                <div class="flex justify-end mb-8">
                    <div class="text-right bg-emerald-50 px-6 py-3 rounded-lg border border-emerald-100">
                        <span class="text-emerald-700 font-bold mr-4 text-sm uppercase">總支出金額</span>
                        <span class="text-3xl font-bold text-emerald-800 font-mono">${totalStr}</span>
                    </div>
                </div>
                
                <div class="text-[10px] text-gray-300 text-center mt-auto border-t border-gray-100 pt-4">
                    <p>Generated by 健益工程 ERP System</p>
                </div>
            `;

            document.getElementById('preview-modal').classList.remove('hidden');
        }



        async function testDownloadImage() {
            const btn = event.target.closest('button');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 處理中...';
            btn.disabled = true;

            const canvasBlock = document.getElementById('cost-canvas');
            try {
                const canvas = await html2canvas(canvasBlock, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                const summaryBase64 = canvas.toDataURL('image/jpeg', 0.8);

                const dDate = new Date().toISOString().split('T')[0];
                const dName = document.getElementById('projectName').value || "工程成本分析";

                const dLink = document.createElement('a');
                dLink.href = summaryBase64;
                dLink.download = `[測試]_${dDate}_${dName}_成本表.jpg`;
                document.body.appendChild(dLink);
                dLink.click();
                document.body.removeChild(dLink);
            } catch (e) {
                console.error("Canvas Error", e);
                alert("產生失敗: " + e);
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        async function executeSubmission() {
            const btn = document.querySelector('#preview-modal button:last-child');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 處理中...';
            btn.disabled = true;

            // Generate Image
            const canvasBlock = document.getElementById('cost-canvas');
            let summaryBase64 = "";
            try {
                const canvas = await html2canvas(canvasBlock, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                summaryBase64 = canvas.toDataURL('image/jpeg', 0.8);

                // [New] Auto Download Image
                const dDate = new Date().toISOString().split('T')[0];
                const dName = document.getElementById('projectName').value || "工程成本分析";
                const dLink = document.createElement('a');
                dLink.href = summaryBase64;
                dLink.download = `${dDate}_${dName}_成本表.jpg`;
                document.body.appendChild(dLink);
                dLink.click();
                document.body.removeChild(dLink);
            } catch (e) {
                console.error("Canvas Error", e);
            }

            // Prepare Data
            const blocks = document.querySelectorAll('.vendor-block');

            const filePromises = Array.from(blocks).map(block => {
                return new Promise((resolve, reject) => {
                    const fileInput = block.querySelector('.v-file');
                    const file = fileInput.files[0];
                    const invType = block.querySelector('.v-inv-type:checked').value;
                    const isError = block.querySelector('.v-error').checked;
                    const hasSavedImage = block.querySelector('.v-has-saved-image').value === 'true';
                    const invNo = block.querySelector('.v-inv').value;

                    // Validation
                    if (invType === 'invoice' && !invNo.trim()) {
                        reject("請輸入發票號碼！(若無發票請選擇'收據')");
                        return;
                    }

                    if (!file && !hasSavedImage) {
                        reject("每一筆支出都必須上傳單據照片！");
                        return;
                    }

                    const itemData = {
                        vendorTaxId: block.querySelector('.v-tax').value,
                        vendorName: block.querySelector('.v-name').value,
                        costSummary: block.querySelector('.v-summary').value,
                        subtotalNoTax: block.querySelector('.v-untax').value,
                        taxAmount: block.querySelector('.v-tax-amt').value,
                        grandTotal: block.querySelector('.v-inc').value,
                        invoiceNo: invNo,
                        invoiceType: invType,
                        isError: isError
                        // invoiceImage will be handled below
                    };

                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function () {
                            itemData.invoiceImage = reader.result.split(',')[1];
                            // If user uploaded new file, we send the base64. 
                            // Backend should treat this as a new file upload.
                            resolve(itemData);
                        };
                        reader.readAsDataURL(file);
                    } else {
                        // If no new file but has saved image, we don't send invoiceImage (or send a flag?)
                        // Current backend logic likely expects 'invoiceImage' to save file.
                        // If we don't send it, backend won't overwrite.
                        // However, we need to make sure backend doesn't require it if it's an update.
                        // For simplicity in this logic: if we don't send invoiceImage, backend keeps old one.
                        // BUT, if user checked "Error", we might need to rename the old file? 
                        // Renaming old file on Drive via GAS is possible but might be complex if we only have the URL.
                        // Let's assume for now: if no new file, we just send metadata. 
                        // If "Error" flag changed, we might want to update filename but that requires file ID.
                        // We likely don't have file ID here, only URL. 
                        // So for "Error" flag to affect filename, it works best when uploading. 
                        // If just updating metadata, we might accept that filename doesn't change, OR we implement renaming.
                        // User request: "若勾選錯誤選項時在該檔檔名增加'錯誤'文字"
                        // If it's an existing file, we can't easily rename it without the ID.
                        // We will just pass the flag. Backend needs to handle this.
                        // Actually, if we are compliant with "File required", we are good.

                        // Wait, if it's existing file, we resolve immediately.
                        resolve(itemData);
                    }
                });
            });

            let loadedItems;
            try {
                loadedItems = await Promise.all(filePromises);
            } catch (err) {
                alert(err);
                btn.innerHTML = originalContent;
                btn.disabled = false;
                return; // Stop submission
            }

            const payload = {
                type: 'cost',
                projectId: document.getElementById('projectSelect').value,
                customer: document.getElementById('customer').value,
                projectName: document.getElementById('projectName').value,
                salesPerson: document.getElementById('costSalesPerson').value,
                salesMobile: document.getElementById('costSalesPerson').dataset.mobile || "",
                worker: getPersons('worker'),
                buyer: getPersons('buyer'),
                date: new Date().toISOString().split('T')[0],
                image: summaryBase64,
                items: loadedItems,
                grandTotal: document.getElementById('total-inc').innerText.replace('$', '').trim().replace(/,/g, ''),
                lineUser: lineUser
            };

            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                alert("儲存成功！");
                location.reload();
            } catch (e) {
                alert("上傳失敗: " + e);
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>