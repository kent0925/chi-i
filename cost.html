<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工程管理 - 成本系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }

        .vendor-block {
            transition: all 0.3s ease;
        }

        .vendor-block:hover {
            border-color: #10b981;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-100 to-gray-200 min-h-screen p-4 md:p-8 font-sans text-gray-700 pb-20">
    <div
        class="max-w-5xl mx-auto bg-white/90 backdrop-blur-md rounded-2xl shadow-2xl overflow-hidden border border-white/50">
        <div
            class="bg-gradient-to-r from-green-900 to-emerald-800 p-6 text-white flex justify-between items-center shadow-md relative overflow-hidden">
            <div
                class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10 pointer-events-none">
            </div>
            <div class="flex items-center gap-4 relative z-10">
                <div class="bg-white/10 p-2 rounded-lg backdrop-blur-sm">
                    <i class="fa-solid fa-calculator text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold tracking-wide">工程成本分析系統</h1>
                    <p class="text-xs text-green-200">工料支出與廠商管理</p>
                </div>
            </div>

            <div class="flex items-center gap-3 relative z-10">
                <!-- LIFF Profile -->
                <div id="liff-profile"
                    class="hidden flex items-center gap-2 bg-white/10 p-1.5 pr-3 rounded-full backdrop-blur-sm border border-white/20">
                    <img id="liff-picture" src="" alt="Profile" class="w-8 h-8 rounded-full border border-white/50">
                    <div class="flex flex-col">
                        <span id="liff-name" class="text-xs font-bold text-white">Loading</span>
                    </div>
                </div>

                <button onclick="location.href='index.html'"
                    class="text-sm bg-white/10 border border-white/20 px-4 py-2 rounded-full hover:bg-white/20 transition-all flex items-center gap-2 backdrop-blur-sm shadow-sm group">
                    <i class="fa-solid fa-arrow-left group-hover:-translate-x-1 transition-transform"></i>
                    返回主選單
                </button>
            </div>
        </div>

        <div class="p-6">
            <!-- 來源專案選擇 -->
            <div class="mb-4 bg-green-50 p-3 rounded border border-green-200">
                <label class="font-bold text-green-900 text-sm block mb-1">1. 選擇來源專案 (報價單)：</label>
                <select id="projectSelect" onchange="fillProjectInfo(this.value)"
                    class="w-full border border-green-300 rounded p-2 text-sm">
                    <option value="">-- 請選擇專案 --</option>
                </select>
            </div>

            <!-- 專案基本資料 (唯讀) -->
            <div class="bg-gray-100 p-3 rounded-md border border-gray-200 mb-6">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs text-gray-500 mb-1">客戶名稱</label><input type="text" id="customer"
                            class="w-full bg-gray-200 border border-gray-300 rounded p-1 text-sm" readonly></div>
                    <div><label class="block text-xs text-gray-500 mb-1">專案名稱</label><input type="text" id="projectName"
                            class="w-full bg-gray-200 border border-gray-300 rounded p-1 text-sm" readonly></div>
                    <div><label class="block text-xs text-gray-500 mb-1">業務人員 (鎖定)</label><input type="text"
                            id="costSalesPerson" class="w-full border p-1 text-sm rounded bg-gray-200" readonly></div>
                    <div><label class="block text-xs text-gray-500 mb-1">業務人員 (鎖定)</label><input type="text"
                            id="costSalesPerson" class="w-full border p-1 text-sm rounded bg-gray-200" readonly></div>
                </div>
            </div>

            <!-- 人員設定 -->
            <div class="grid grid-cols-2 gap-4 bg-yellow-50 p-3 rounded border border-yellow-200 mb-6 font-bold">
                <div>
                    <label class="block text-xs text-yellow-800">工務人員</label>
                    <select id="workerPerson" class="w-full border border-yellow-300 p-1 text-sm rounded bg-white">
                        <option value="">請選擇</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-yellow-800">採購人員</label>
                    <select id="buyerPerson" class="w-full border border-yellow-300 p-1 text-sm rounded bg-white">
                        <option value="">請選擇</option>
                    </select>
                </div>
            </div>

            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-700"><i
                        class="fa-solid fa-truck-field mr-2 text-green-600"></i>支出明細</h3>
                <button onclick="addVendorBlock()"
                    class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-green-700 transition">
                    <i class="fa-solid fa-plus mr-1"></i> 增加廠商支出
                </button>
            </div>

            <!-- 多廠商明細容器 -->
            <div id="vendor-items-container" class="space-y-6"></div>

            <!-- 底部總計區 -->
            <div class="mt-8 pt-6 border-t-4 double border-gray-200 bg-gray-50 p-4 rounded-xl">
                <div class="flex flex-col items-end gap-1 text-gray-700">
                    <div class="text-sm">明細筆數：<span id="item-count" class="font-bold">0</span> 筆</div>
                    <div class="w-64 border-t border-gray-300 my-2"></div>
                    <div class="flex justify-between w-64 text-sm">
                        <span>未稅金額：</span>
                        <span id="total-untax" class="font-bold">$ 0</span>
                    </div>
                    <div class="flex justify-between w-64 text-sm">
                        <span>稅額 (5%)：</span>
                        <span id="total-tax" class="font-bold">$ 0</span>
                    </div>
                    <div
                        class="flex justify-between w-64 text-xl text-green-800 mt-2 font-bold border-t border-green-200 pt-2">
                        <span>含稅總計：</span>
                        <span id="total-inc">$ 0</span>
                    </div>
                </div>
            </div>

            <div class="mt-8">
                <button onclick="submitCostData()" id="btn-submit"
                    class="w-full bg-green-700 text-white font-bold py-4 rounded-xl shadow-xl hover:bg-green-800 transition text-lg">
                    確認並儲存所有明細
                </button>
            </div>
        </div>
    </div>

    <!-- Datalists -->
    <datalist id="vendor-list"></datalist>

    <script>
        const LIFF_ID = '2008974069-Ecojk6W1';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxrXo9AcczzlIazBPTqxZij7CVAcqcXtbbpGJMKQ4RoEFRp8JsTtjLZw1R6xZwwvnnt/exec';
        let salesPersons = [];
        let vendors = [];
        let projectList = [];
        let lineUser = null;

        window.onload = function () {
            initializeLiff();
            // document.getElementById('costDate').value = new Date().toISOString().split('T')[0]; // Remove Date
            fetchConfig();
            addVendorBlock(); // 預設增加一個
        };

        async function initializeLiff() {
            if (LIFF_ID === 'YOUR_LIFF_ID') return console.warn('LIFF ID 未設定');
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    lineUser = profile;
                    document.getElementById('liff-profile').classList.remove('hidden');
                    document.getElementById('liff-picture').src = profile.pictureUrl;
                    document.getElementById('liff-name').innerText = profile.displayName;
                } else {
                    liff.login();
                }
            } catch (e) {
                console.error('LIFF Init Error', e);
            }
        }

        function fetchConfig() {
            if (GAS_URL.includes('your-gas-id') || GAS_URL.includes('L1L1L1')) return;
            fetch(GAS_URL)
                .then(res => res.json())
                .then(data => {
                    salesPersons = data.sales || [];
                    vendors = data.vendors || [];
                    projectList = data.projects || [];

                    fillSelect('workerPerson', salesPersons);
                    fillSelect('buyerPerson', salesPersons);
                    fillProjectSelect();
                    renderVendorList();
                })
                .catch(err => console.error("GAS Error", err));
        }

        function fillSelect(id, list) {
            const sel = document.getElementById(id);
            if (!sel) return;
            sel.innerHTML = '<option value="">請選擇</option>' + list.map(s => `<option value="${s}">${s}</option>`).join('');
        }

        function fillProjectSelect() {
            const sel = document.getElementById('projectSelect');
            sel.innerHTML = '<option value="">-- 請選擇專案 --</option>' +
                projectList.map(p => {
                    const label = `${p.date} ${p.customer} (${p.project})`;
                    return `<option value="${p.id}">${label}</option>`;
                }).join('');
        }

        function renderVendorList() {
            const list = document.getElementById('vendor-list');
            list.innerHTML = vendors.map(v => `<option value="${v}">`).join('');
        }

        function fillProjectInfo(id) {
            const p = projectList.find(x => x.id === id);
            if (p) {
                document.getElementById('customer').value = p.customer;
                document.getElementById('projectName').value = p.project;
                document.getElementById('costSalesPerson').value = p.sales;
            } else {
                document.getElementById('customer').value = "";
                document.getElementById('projectName').value = "";
                document.getElementById('costSalesPerson').value = "";
            }
        }

        function addVendorBlock() {
            const container = document.getElementById('vendor-items-container');
            const id = Date.now();
            const div = document.createElement('div');
            div.className = "vendor-block bg-white p-4 rounded-xl shadow border-l-4 border-green-500 relative";
            div.id = 'block-' + id;
            div.innerHTML = `
                <button onclick="removeBlock('${id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-500">
                    <i class="fa-solid fa-trash-can text-lg"></i>
                </button>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 pr-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">廠商名稱 / 對象</label>
                        <div class="flex gap-2">
                             <div class="w-1/3 relative">
                                <input type="text" class="v-tax w-full border border-gray-300 rounded p-2 text-sm" placeholder="輸入統編" onchange="lookupBlockVendor(this)">
                                <span class="v-msg hidden absolute top-full left-0 text-[10px] text-orange-500">查詢中... (需等待 3-5 秒)</span>
                             </div>
                             <input type="text" class="v-name flex-1 border border-gray-300 rounded p-2 text-sm font-bold" list="vendor-list" placeholder="輸入或選擇廠商">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 mb-1">支出摘要 (必填)</label>
                        <input type="text" class="v-summary w-full border border-gray-300 rounded p-2 text-sm" placeholder="例如：材料費、工資...">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 bg-green-50/50 p-2 rounded">
                    <div>
                        <label class="block text-xs font-bold text-green-800 mb-1">未稅金額</label>
                        <input type="number" class="v-untax w-full border border-green-300 rounded p-2 text-sm text-right font-mono" placeholder="0" oninput="calcRow(this)">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-green-800 mb-1">稅金 (5%)</label>
                        <input type="number" class="v-tax-amt w-full border border-green-300 rounded p-2 text-sm text-right font-mono bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-green-800 mb-1">含稅總額</label>
                        <input type="number" class="v-inc w-full border border-green-300 rounded p-2 text-sm text-right font-mono font-bold bg-green-100" readonly>
                    </div>
                </div>

                <div class="flex gap-4 items-center">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-500 mb-1">發票/收據號碼</label>
                        <input type="text" class="v-inv w-full border border-gray-300 rounded p-1 text-sm" placeholder="輸入號碼">
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-500 mb-1">上傳單據 (圖片/PDF)</label>
                        <input type="file" class="v-file w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                    </div>
                </div>
            `;
            container.appendChild(div);
            updateCount();
            calcTotal();
        }

        function removeBlock(id) {
            document.getElementById('block-' + id).remove();
            updateCount();
            calcTotal();
        }

        function updateCount() {
            document.getElementById('item-count').innerText = document.querySelectorAll('.vendor-block').length;
        }

        function calcRow(input) {
            const block = input.closest('.vendor-block');
            const unTax = parseFloat(input.value) || 0;
            const tax = Math.round(unTax * 0.05);
            const inc = unTax + tax;

            block.querySelector('.v-tax-amt').value = tax;
            block.querySelector('.v-inc').value = inc;
            calcTotal();
        }

        function calcTotal() {
            let totalUnTax = 0;
            let totalTax = 0;
            let totalInc = 0;

            document.querySelectorAll('.vendor-block').forEach(b => {
                totalUnTax += parseFloat(b.querySelector('.v-untax').value) || 0;
                totalTax += parseFloat(b.querySelector('.v-tax-amt').value) || 0;
                totalInc += parseFloat(b.querySelector('.v-inc').value) || 0;
            });

            document.getElementById('total-untax').innerText = "$ " + totalUnTax.toLocaleString();
            document.getElementById('total-tax').innerText = "$ " + totalTax.toLocaleString();
            document.getElementById('total-inc').innerText = "$ " + totalInc.toLocaleString();
        }

        async function lookupBlockVendor(input) {
            const val = input.value;
            if (val.length !== 8) return;

            const block = input.closest('.vendor-block');
            const msg = block.querySelector('.v-msg');
            const nameInput = block.querySelector('.v-name');

            msg.classList.remove('hidden'); // 顯示等待提示
            nameInput.placeholder = "查詢中...";

            try {
                const res = await fetch(`${GAS_URL}?action=lookup&taxId=${val}`);
                const data = await res.json();
                if (data.name) {
                    nameInput.value = data.name;
                    // 同步儲存到 vendors (optimistic)
                    if (!vendors.includes(data.name)) vendors.push(data.name);
                } else {
                    alert('查無資料');
                }
            } catch (e) { console.error(e); }

            msg.classList.add('hidden'); // 隱藏提示
            nameInput.placeholder = "輸入或選擇廠商";
        }

        async function submitCostData() {
            const projectId = document.getElementById('projectSelect').value;
            if (!projectId) return alert("請選擇來源專案");

            const blocks = document.querySelectorAll('.vendor-block');
            if (blocks.length === 0) return alert("請至少新增一筆支出");

            // 檢查必填
            let isValid = true;
            blocks.forEach(b => {
                const summary = b.querySelector('.v-summary').value.trim();
                const amt = b.querySelector('.v-untax').value;
                if (!summary) {
                    b.querySelector('.v-summary').classList.add('border-red-500');
                    isValid = false;
                } else {
                    b.querySelector('.v-summary').classList.remove('border-red-500');
                }
                if (!amt || parseFloat(amt) <= 0) {
                    b.querySelector('.v-untax').classList.add('border-red-500');
                    isValid = false;
                } else {
                    b.querySelector('.v-untax').classList.remove('border-red-500');
                }
            });

            if (!isValid) return alert("請檢查「支出摘要」與「未稅金額」是否皆已填寫且大於 0。");

            // 按鈕 Loading
            const btn = document.getElementById('btn-submit');
            const originalText = btn.innerText;
            btn.innerText = "資料處理中...請勿關閉視窗";
            btn.disabled = true;

            const tasks = [];

            blocks.forEach(block => {
                const fileInput = block.querySelector('.v-file');
                const file = fileInput.files[0];

                const p = new Promise(async (resolve, reject) => {
                    let fileUrl = "";
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = async function () {
                            const base64 = reader.result.split(',')[1];
                            try {
                                const upRes = await fetch(GAS_URL, {
                                    method: 'POST',
                                    body: JSON.stringify({
                                        type: 'upload', // 呼叫 GAS upload 邏輯
                                        fileName: file.name,
                                        mimeType: file.type,
                                        fileData: base64
                                    })
                                });
                                const upData = await upRes.json();
                                fileUrl = upData.url;
                                resolve(buildPayload(block, fileUrl));
                            } catch (e) {
                                console.error('Upload failed', e);
                                resolve(buildPayload(block, "Upload Failed"));
                            }
                        };
                        reader.readAsDataURL(file);
                    } else {
                        resolve(buildPayload(block, ""));
                    }
                });
                tasks.push(p);
            });

            Promise.all(tasks).then(async (payloads) => {
                try {
                    for (const data of payloads) {
                        await fetch(GAS_URL, {
                            method: 'POST',
                            body: JSON.stringify(data),
                            mode: 'no-cors'
                        });
                    }
                    alert("所有明細已儲存完畢！");
                    location.reload();
                } catch (e) {
                    alert("儲存過程發生錯誤：" + e);
                } finally {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            });
        }

        function buildPayload(block, fileUrl) {
            return {
                type: 'cost',
                projectId: document.getElementById('projectSelect').value,
                customer: document.getElementById('customer').value,
                projectName: document.getElementById('projectName').value,
                salesPerson: document.getElementById('costSalesPerson').value,
                // date: removed
                worker: document.getElementById('workerPerson').value,
                buyer: document.getElementById('buyerPerson').value,

                vendorTaxId: block.querySelector('.v-tax').value,
                vendorName: block.querySelector('.v-name').value,
                summary: block.querySelector('.v-summary').value,

                amount: block.querySelector('.v-inc').value, // 存含稅總額
                note: `未稅:${block.querySelector('.v-untax').value}, 稅:${block.querySelector('.v-tax-amt').value}, 發票:${block.querySelector('.v-inv').value}`,
                invoiceNo: block.querySelector('.v-inv').value,

                fileData: "",
                fileUrl: fileUrl,
                lineUser: lineUser
            };
        }
    </script>
</body>

</html>