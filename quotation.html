<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工程管理 - 報價系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        blue: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                        slate: {
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                        serif: ['Noto Serif TC', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }

        .preview-canvas {
            font-family: 'DFKai-SB', 'BiauKai', '標楷體', 'Noto Serif TC', serif;
            background-color: white;
            color: black;
            line-height: 1.3;
        }

        .company-title {
            font-size: 20pt;
            font-weight: bold;
            text-align: center;
        }

        .preview-canvas>div.flex-1.text-center {
            text-align: center !important;
        }

        .doc-title {
            font-size: 16pt;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        .info-table,
        .items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12pt;
        }

        .info-table td,
        .items-table th,
        .items-table td {
            border: 1px solid #000;
            padding: 4px 8px;
        }

        .summary-row {
            display: flex;
            justify-content: flex-end;
            font-size: 12pt;
            padding: 2px 0;
        }

        .summary-label {
            text-align: right;
            padding-right: 10px;
            width: 150px;
        }

        .summary-value {
            text-align: right;
            width: 120px;
            padding-right: 4px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Mobile Optimization: Prevent iOS Zoom */
        @media (max-width: 768px) {

            input,
            select,
            textarea {
                font-size: 16px !important;
            }
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen pb-32">
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="text-center">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-600 mb-4"></i>
            <p class="text-blue-800 font-bold tracking-widest animate-pulse">資料載入中...</p>
        </div>
    </div>

    <!-- Header Background -->
    <div class="fixed top-0 left-0 w-full h-64 bg-gradient-to-br from-blue-900 via-slate-800 to-gray-900 -z-10"></div>

    <div class="max-w-6xl mx-auto px-4 pt-6">

        <!-- Header Card -->
        <div
            class="bg-white/10 backdrop-blur-md rounded-2xl p-6 text-white shadow-xl border border-white/20 mb-8 flex flex-col md:flex-row justify-between items-center gap-4 relative overflow-hidden">
            <!-- Decorative Pattern -->
            <div class="absolute -top-10 -right-10 w-64 h-64 bg-blue-500/20 rounded-full blur-3xl pointer-events-none">
            </div>

            <div class="flex items-center gap-5 z-10">
                <div class="bg-white/20 p-4 rounded-2xl shadow-inner backdrop-blur-md border border-white/10">
                    <i class="fa-solid fa-file-invoice-dollar text-3xl text-blue-100"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-bold tracking-wide text-white drop-shadow-sm">工程報價系統</h1>
                    <p class="text-blue-100/80 text-sm font-medium mt-1">Quotation Management System</p>
                </div>
            </div>

            <div class="flex items-center gap-3 z-10">
                <!-- LIFF Profile -->
                <div id="liff-profile"
                    class="hidden flex items-center gap-3 bg-black/20 py-2 px-4 rounded-full border border-white/10 backdrop-blur-sm">
                    <img id="liff-picture" src="" alt="Profile"
                        class="w-8 h-8 rounded-full border-2 border-white/30 shadow-sm">
                    <span id="liff-name" class="text-sm font-bold text-white tracking-wide">User</span>
                </div>

                <button onclick="location.href='index.html'"
                    class="group bg-white/10 hover:bg-white/20 text-white text-sm py-2 px-5 rounded-full border border-white/30 transition-all duration-300 flex items-center gap-2 shadow-lg hover:shadow-xl hover:-translate-y-0.5">
                    <i class="fa-solid fa-arrow-left group-hover:-translate-x-1 transition-transform"></i>
                    <span>返回主選單</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-100 mb-8">

            <!-- Control Bar (History & Status) -->
            <div
                class="p-6 border-b border-gray-100 bg-blue-50/30 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <div class="relative flex-1 md:flex-none md:w-80">
                        <span class="absolute left-3 top-2.5 text-blue-800"><i
                                class="fa-solid fa-clock-rotate-left"></i></span>
                        <select id="historySelect" onchange="loadQuoteForEdit(this.value)"
                            class="w-full pl-9 bg-white border border-blue-200 rounded-xl py-2 text-sm text-blue-900 shadow-sm focus:ring-2 focus:ring-blue-500 font-bold cursor-pointer">
                            <option value="">-- 建立新單據 --</option>
                        </select>
                    </div>
                    <span id="edit-mode-badge"
                        class="hidden bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold border border-red-200 animate-pulse">
                        <i class="fa-solid fa-pen-to-square mr-1"></i> 修改模式
                    </span>
                </div>

                <div class="flex items-center gap-4">
                    <!-- Addition Checkbox -->
                    <label
                        class="group flex items-center gap-2 cursor-pointer bg-purple-50 hover:bg-purple-100 px-4 py-2 rounded-lg border border-purple-200 transition-colors"
                        title="僅限載入已成交之原始報價單後使用">
                        <div class="relative flex items-center">
                            <input type="checkbox" id="isAddition" class="peer sr-only">
                            <div
                                class="w-5 h-5 bg-white border-2 border-purple-300 rounded peer-checked:bg-purple-600 peer-checked:border-purple-600 transition-all">
                            </div>
                            <i
                                class="fa-solid fa-check text-white text-[10px] absolute left-1 top-1 opacity-0 peer-checked:opacity-100 transition-opacity"></i>
                        </div>
                        <span class="text-sm font-bold text-purple-700 select-none"><i
                                class="fa-solid fa-plus-circle mr-1"></i> 追加單</span>
                    </label>

                    <!-- Deal Closed Checkbox -->
                    <label
                        class="group flex items-center gap-2 cursor-pointer bg-red-50 hover:bg-red-100 px-4 py-2 rounded-lg border border-red-200 transition-colors">
                        <div class="relative flex items-center">
                            <input type="checkbox" id="dealClosed" onchange="updateAdditionState()"
                                class="peer sr-only">
                            <div
                                class="w-5 h-5 bg-white border-2 border-red-300 rounded peer-checked:bg-red-600 peer-checked:border-red-600 transition-all">
                            </div>
                            <i
                                class="fa-solid fa-check text-white text-[10px] absolute left-1 top-1 opacity-0 peer-checked:opacity-100 transition-opacity"></i>
                        </div>
                        <span class="text-sm font-bold text-red-700 select-none"><i
                                class="fa-solid fa-handshake mr-1"></i> 已成交</span>
                    </label>
                </div>
            </div>

            <div class="p-8">
                <!-- Internal Info Grid -->
                <div class="bg-gray-50 rounded-2xl p-5 mb-8 border border-gray-100">
                    <h3
                        class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 border-b border-gray-200 pb-2">
                        業務與內控資訊</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">專案 ID</label>
                            <input type="text" id="internalProjectId"
                                class="w-full bg-gray-100 border border-gray-200 rounded-lg p-2.5 text-sm text-gray-400 font-mono italic"
                                value="(存檔後自動產生)" readonly>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-blue-800 mb-1">業務人員</label>
                            <select id="salesPerson"
                                class="w-full border border-gray-200 rounded-lg p-2.5 text-sm font-bold text-blue-900 focus:ring-2 focus:ring-blue-500 bg-white"
                                onchange="saveConfig('sales', this.value)">
                                <option value="">-- 請選擇 --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-blue-800 mb-1">業務手機</label>
                            <input type="text" id="salesMobile"
                                class="w-full border border-gray-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500"
                                placeholder="09xx-xxx-xxx">
                        </div>
                    </div>
                </div>

                <!-- Customer Info -->
                <div class="mb-8">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span class="w-1 h-6 bg-blue-500 rounded-full"></span>
                        客戶與專案資料
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Left Column -->
                        <div class="space-y-4">
                            <div>
                                <label class="flex justify-between text-xs font-bold text-gray-500 mb-1">
                                    <span>客戶名稱</span>
                                    <span class="text-blue-500 font-normal">可輸入統編8碼</span>
                                </label>
                                <div class="flex gap-2">
                                    <div class="w-32 relative">
                                        <input type="text" id="taxId"
                                            class="w-full border border-gray-300 rounded-lg p-2.5 text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 transition-all font-mono"
                                            placeholder="統編" oninput="checkTaxId(this)" maxlength="8">
                                        <span id="tax-warning"
                                            class="hidden absolute -bottom-4 left-0 text-[10px] text-red-500 font-bold whitespace-nowrap">需為8碼數字</span>
                                    </div>
                                    <div class="flex-1 relative">
                                        <input type="text" id="customer"
                                            class="w-full border border-gray-300 rounded-lg p-2.5 text-sm font-bold text-gray-800 focus:ring-2 focus:ring-blue-500 pl-2"
                                            placeholder="輸入客戶名稱">
                                        <button onclick="lookupCompany()"
                                            class="absolute right-1 top-1 bottom-1 px-3 bg-blue-100 hover:bg-blue-200 text-blue-700 text-xs font-bold rounded-md transition-colors">查詢</button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">工程/專案名稱</label>
                                <input type="text" id="projectName"
                                    class="w-full border border-gray-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500 font-bold"
                                    placeholder="例如：辦公室裝修工程">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">報價單日期</label>
                                <input type="date" id="quoteDate"
                                    class="w-full border border-gray-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500 cursor-pointer">
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">客戶聯絡人</label>
                                <input type="text" id="contactPerson"
                                    class="w-full border border-gray-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500"
                                    placeholder="聯絡窗口姓名">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">客戶手機</label>
                                    <input type="text" id="contactPhone"
                                        class="w-full border border-gray-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500"
                                        oninput="formatPhone(this)" placeholder="09xx-xxx-xxx">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">客戶市話</label>
                                    <input type="text" id="customerTel"
                                        class="w-full border border-gray-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500"
                                        oninput="formatPhone(this)" placeholder="02-xxxxxxx">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">客戶傳真</label>
                                <input type="text" id="customerFax" oninput="formatPhone(this)"
                                    class="w-full border border-gray-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-blue-500"
                                    placeholder="傳真號碼">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Items Section -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <span
                                class="bg-blue-100 text-blue-700 w-8 h-8 rounded-full flex items-center justify-center text-sm shadow-sm"><i
                                    class="fa-solid fa-list-ol"></i></span>
                            報價明細
                        </h3>
                    </div>

                    <div id="items-container" class="space-y-3 mb-6">
                        <!-- Items Loaded Here -->
                    </div>

                    <div class="flex gap-4">
                        <button onclick="addRow('category')"
                            class="flex-1 py-3 px-4 rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 text-gray-600 font-bold hover:bg-white hover:border-gray-400 hover:shadow-sm transition-all flex justify-center items-center gap-2">
                            <i class="fa-solid fa-folder-tree"></i> 新增大項次
                        </button>
                        <button onclick="addRow('item')"
                            class="flex-1 py-3 px-4 rounded-xl border-2 border-dashed border-blue-200 bg-blue-50 text-blue-700 font-bold hover:bg-white hover:border-blue-400 hover:shadow-sm transition-all flex justify-center items-center gap-2">
                            <i class="fa-solid fa-plus"></i> 新增細項
                        </button>
                    </div>
                </div>

                <!-- Footer Two columns -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Note -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2">備註說明</label>
                        <textarea id="footerNote"
                            class="w-full border border-gray-200 rounded-xl p-4 text-sm h-32 focus:ring-2 focus:ring-blue-500 bg-gray-50 focus:bg-white transition-colors resize-none"
                            placeholder="請輸入報價備註事項..."></textarea>
                    </div>

                    <!-- Fees -->
                    <div class="bg-yellow-50/50 p-6 rounded-2xl border border-yellow-100">
                        <div class="flex justify-between items-center mb-4">
                            <label class="text-sm font-bold text-yellow-800"><i class="fa-solid fa-coins mr-1"></i>
                                額外費用</label>
                            <button onclick="addFeeRow()"
                                class="text-xs bg-white border border-yellow-300 text-yellow-700 px-3 py-1.5 rounded-lg hover:bg-yellow-50 font-bold shadow-sm">
                                <i class="fa-solid fa-plus"></i> 新增
                            </button>
                        </div>
                        <div id="fees-container" class="space-y-3 mb-2"></div>
                        <div class="text-xs text-yellow-600/60 text-right mt-2">* 總金額將自動於預覽頁面計算 *</div>
                    </div>
                </div>

                <div class="h-20"></div> <!-- Spacer -->

            </div>
        </div>
    </div>


    <!-- Sticky Footer -->
    <div
        class="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-xl border-t border-gray-200 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] z-40">
        <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-gray-500 text-xs hidden md:block">
                * 點擊右側預覽按鈕確認最終報價單內容
            </div>
            <button onclick="generatePreview('工程報價單')"
                class="w-full md:w-auto bg-blue-700 hover:bg-blue-800 text-white px-8 py-3 rounded-xl font-bold text-sm shadow-xl hover:shadow-2xl transition-all transform hover:-translate-y-1 flex items-center justify-center gap-2">
                <span>預覽報價單</span>
                <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>


    <!-- Preview Modal -->
    <div id="preview-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="fixed inset-0 bg-gray-900/75 backdrop-blur-sm transition-opacity"
            onclick="document.getElementById('preview-modal').classList.add('hidden')"></div>
        <div class="flex min-h-screen items-center justify-center p-4 text-center sm:p-0">
            <div
                class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 w-full max-w-[240mm] flex flex-col max-h-[90vh]">
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-gray-900"><i
                            class="fa-solid fa-file-contract mr-2 text-blue-600"></i>報價單預覽</h3>
                    <button onclick="document.getElementById('preview-modal').classList.add('hidden')"
                        class="text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                <div class="flex-1 overflow-auto bg-gray-500 p-6 flex justify-center items-start">
                    <div id="quotation-canvas"
                        class="preview-canvas bg-white p-12 shadow-lg relative shrink-0 flex flex-col justify-between"
                        style="width: 210mm; min-height: 297mm; font-family: 'Microsoft JhengHei', '微軟正黑體', sans-serif;">
                    </div>
                </div>
                <div class="bg-white px-6 py-4 border-t border-gray-200 flex gap-3 justify-end">
                    <button onclick="document.getElementById('preview-modal').classList.add('hidden')"
                        class="px-5 py-2.5 rounded-lg border border-gray-300 bg-white text-gray-700 font-bold hover:bg-gray-50">返回修改</button>
                    <button onclick="testDownloadImage()"
                        class="px-5 py-2.5 rounded-lg border border-purple-300 bg-purple-50 text-purple-700 font-bold hover:bg-purple-100"><i
                            class="fa-solid fa-image mr-1"></i> 測試圖檔</button>
                    <button onclick="submitData()"
                        class="px-5 py-2.5 rounded-lg bg-blue-600 text-white font-bold shadow hover:bg-blue-700 flex items-center gap-2"><i
                            class="fa-solid fa-cloud-arrow-up"></i> 確認儲存並產生圖檔</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Datalists -->
    <datalist id="sales-list"></datalist>
    <datalist id="unit-list"></datalist>

    <script>
        const LIFF_ID = '2008974069-Ecojk6W1';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxrXo9AcczzlIazBPTqxZij7CVAcqcXtbbpGJMKQ4RoEFRp8JsTtjLZw1R6xZwwvnnt/exec';
        const LOGO_URL = 'https://kent0925.github.io/chi-i/unnamed.png';

        let salesPersons = [];
        let unitOptions = [];
        let projectList = [];
        let currentOriginId = null;
        let lineUser = null;

        window.onload = function () {
            initializeLiff();
            const dateInput = document.getElementById('quoteDate');
            if (dateInput) dateInput.value = new Date().toISOString().split('T')[0];
            fetchConfig();

            const sm = document.getElementById('salesMobile');
            if (sm) sm.addEventListener('input', function () { formatPhone(this); });

            if (document.querySelectorAll('.item-row').length === 0) {
                addRow('category');
                addRow('item');
            }
        };

        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    lineUser = profile;
                    const pBlock = document.getElementById('liff-profile');
                    if (pBlock) {
                        pBlock.classList.remove('hidden');
                        pBlock.classList.add('flex');
                        document.getElementById('liff-picture').src = profile.pictureUrl;
                        document.getElementById('liff-name').innerText = profile.displayName;
                    }
                } else {
                    liff.login();
                }
            } catch (e) {
                console.error('LIFF Init Error', e);
            }
        }

        function fetchConfig() {
            fetch(GAS_URL)
                .then(res => res.json())
                .then(data => {
                    salesPersons = data.sales || [];
                    unitOptions = data.units || [];
                    projectList = data.projects || [];
                    renderLists();
                    populateHistory();

                    // Hide Loading
                    const overlay = document.getElementById('loading-overlay');
                    if (overlay) {
                        overlay.style.opacity = '0';
                        setTimeout(() => overlay.remove(), 500);
                    }
                })
                .catch(err => {
                    console.error("GAS Error:", err);
                    // Hide Loading even on error
                    const overlay = document.getElementById('loading-overlay');
                    if (overlay) {
                        overlay.style.opacity = '0';
                        setTimeout(() => overlay.remove(), 500);
                    }
                });
        }

        function renderLists() {
            const sList = document.getElementById('sales-list');
            if (sList) sList.innerHTML = salesPersons.map(s => `<option value="${s}">`).join('');

            const sSelect = document.getElementById('salesPerson');
            if (sSelect) {
                const cur = sSelect.value;
                sSelect.innerHTML = '<option value="">-- 請選擇 --</option>' +
                    salesPersons.map(s => `<option value="${s}">${s}</option>`).join('');
                if (cur) sSelect.value = cur;
            }

            const uList = document.getElementById('unit-list');
            if (uList) uList.innerHTML = unitOptions.map(u => `<option value="${u}">`).join('');

            document.querySelectorAll('.input-unit-select').forEach(sel => {
                const cur = sel.value;
                const isCustom = (cur === 'custom');

                sel.innerHTML = `<option value="">單位</option>` +
                    unitOptions.map(u => `<option value="${u}">${u}</option>`).join('') +
                    `<option value="custom">+ 其他</option>`;

                if (unitOptions.includes(cur)) {
                    sel.value = cur;
                } else if (isCustom) {
                    sel.value = 'custom';
                }
            });
        }

        function populateHistory() {
            const hSel = document.getElementById('historySelect');
            if (hSel) {
                hSel.innerHTML = '<option value="">-- 建立新單據 --</option>' + projectList.map(p => {
                    const label = `${p.date} ${p.customer} (${p.project})`;
                    return `<option value="${p.id}">${label}</option>`;
                }).join('');
            }
        }

        function addRow(type) {
            const container = document.getElementById('items-container');
            const lastRow = container.querySelector('.item-row:last-child');
            if (lastRow && lastRow.dataset.type === 'item') {
                const nameVal = lastRow.querySelector('.input-name').value;
                if (!nameVal.trim()) {
                    alert("請先完成上方細項內容後再新增！");
                    return;
                }
            }

            const id = Date.now() + Math.random().toString(36).substr(2, 5);
            const div = document.createElement('div');
            const isCat = (type === 'category');

            div.className = "flex gap-2 items-center item-row p-3 rounded-xl shadow-sm transition-all " +
                (isCat ? "bg-slate-100 border-l-4 border-slate-500 mb-2 mt-4" : "bg-white border border-gray-100 hover:shadow-md");

            div.id = 'row-' + id;
            div.dataset.type = type;

            if (isCat) {
                div.innerHTML = `
                    <div class="text-slate-400 px-2"><i class="fa-solid fa-layer-group"></i></div>
                    <input type="text" class="input-category flex-1 bg-transparent p-2 font-bold text-slate-800 outline-none border-b-2 border-transparent focus:border-slate-300 transition-colors placeholder-slate-400"
                        placeholder="請輸入大項次名稱 (例如: 一、拆除工程)">
                    <button onclick="this.parentElement.remove()" class="w-8 h-8 rounded-full hover:bg-red-100 text-gray-300 hover:text-red-500 flex items-center justify-center transition-colors">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
    `;
            } else {
                div.innerHTML = `
    <div class="w-8 text-center text-xs text-gray-300 font-bold item-seq"></div>
    <div class="flex-1 grid grid-cols-1 md:grid-cols-12 gap-2">
        <div class="md:col-span-5">
             <input type="text" class="input-name w-full border border-gray-200 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="細項描述">
        </div>
        <div class="md:col-span-4 grid grid-cols-3 gap-2">
            <input type="number" class="input-qty border border-gray-200 rounded-lg p-2 text-sm text-center focus:ring-2 focus:ring-blue-500 outline-none" placeholder="數量" value="1">
            <div class="relative">
                <select onchange="handleUnitChange(this)"
                    class="input-unit-select w-full border border-gray-200 rounded-lg p-2 text-xs focus:ring-2 focus:ring-blue-500 outline-none appearance-none bg-white">
                    <option value="">單位</option>
                    ${unitOptions.map(u => `<option value="${u}">${u}</option>`).join('')}
                    <option value="custom text-blue-600 font-bold">+ 自訂</option>
                </select>
                <input type="text" onblur="checkNewUnit(this)"
                    class="input-unit-custom hidden w-full border border-blue-300 rounded-lg p-2 text-xs bg-blue-50 focus:bg-white transition-all" placeholder="新單位">
            </div>
            <input type="number" onchange="checkPrice(this)"
                 class="input-price border border-gray-200 rounded-lg p-2 text-sm text-right focus:ring-2 focus:ring-blue-500 outline-none font-mono" placeholder="單價">
        </div>
        <div class="md:col-span-3">
             <input type="text" class="input-remark w-full border border-gray-200 rounded-lg p-2 text-xs text-gray-500 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="備註">
        </div>
    </div>
    <button onclick="this.parentElement.remove(); reindexItems();" class="w-10 h-10 md:w-8 md:h-8 rounded-full hover:bg-red-100 text-gray-300 hover:text-red-500 flex items-center justify-center transition-colors ml-1 md:ml-2 flex-shrink-0">
        <i class="fa-solid fa-trash-can"></i>
    </button>
    `;
            }
            container.appendChild(div);
            if (!isCat) reindexItems();
        }

        function reindexItems() {
            const rows = document.querySelectorAll('.item-row');
            let seq = 1;
            rows.forEach(row => {
                if (row.dataset.type === 'item') {
                    row.querySelector('.item-seq').innerText = seq++;
                }
            });
        }

        function handleUnitChange(sel) {
            const custom = sel.nextElementSibling;
            if (sel.value === 'custom') {
                sel.classList.add('hidden');
                custom.classList.remove('hidden');
                custom.focus();
            }
        }

        function checkNewUnit(input) {
            const val = input.value.trim();
            if (val && !unitOptions.includes(val)) {
                if (confirm(`是否將新單位「${val}」加入常用清單？`)) {
                    saveToBackend('unit', val);
                }
            }
        }

        function checkPrice(input) {
            const val = parseFloat(input.value);
            if (val < 0) {
                if (confirm("金額為負數，是否設為折抵項目？（將自動於備註加入'折抵'）")) {
                    const row = input.closest('.item-row');
                    const remarkInput = row.querySelector('.input-remark');
                    if (remarkInput.value.indexOf('折抵') === -1) {
                        remarkInput.value = (remarkInput.value + " (折抵)").trim();
                    }
                }
            }
        }

        function addFeeRow() {
            const container = document.getElementById('fees-container');
            const div = document.createElement('div');
            div.className = "flex gap-2 fee-row items-center bg-white p-2 rounded-lg border border-yellow-200";
            div.innerHTML = `
                <span class="text-yellow-600 px-2"><i class="fa-solid fa-tag"></i></span>
                <input type="text" class="fee-name flex-1 border-none bg-transparent p-1 text-sm focus:ring-0 font-bold text-gray-700 placeholder-gray-300" placeholder="項目名稱">
                <select class="fee-type border border-gray-200 bg-gray-50 rounded-md p-1 text-xs focus:ring-0">
                    <option value="fixed">固定金額($)</option>
                    <option value="percent">百分比(%)</option>
                </select>
                <input type="number" class="fee-value w-20 border border-gray-200 rounded-md p-1 text-sm text-right focus:ring-1 focus:ring-yellow-400" placeholder="0" min="0">
                <button onclick="this.parentElement.remove()" class="w-6 h-6 rounded-full hover:bg-red-100 text-gray-300 hover:text-red-500 flex items-center justify-center transition-colors">
                    <i class="fa-solid fa-times"></i>
                </button>
            `;
            container.appendChild(div);
        }

        async function lookupCompany() {
            const taxId = document.getElementById('taxId').value;
            if (taxId.length !== 8) return alert("請輸入8碼統編");
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "查詢中";
            btn.disabled = true;
            try {
                const res = await fetch(`${GAS_URL}?action=lookup&taxId=${taxId}`);
                const data = await res.json();
                if (data.name) {
                    document.getElementById('customer').value = data.name;
                } else {
                    alert(data.error || "查無此統編資料");
                }
            } catch (e) {
                alert("連線失敗或超過查詢量限制。");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function saveConfig(type, val) {
            if (val) saveToBackend(type, val);
        }

        function saveToBackend(type, val) {
            if (type === 'sales' && !salesPersons.includes(val)) salesPersons.push(val);
            if (type === 'unit' && !unitOptions.includes(val)) unitOptions.push(val);
            renderLists();

            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'save_config', configType: type, value: val }),
                mode: 'no-cors'
            });
        }

        function checkTaxId(input) {
            input.value = input.value.replace(/\D/g, '');
            const warn = document.getElementById('tax-warning');
            if (input.value.length > 0 && input.value.length !== 8) warn.classList.remove('hidden');
            else warn.classList.add('hidden');
        }


        function generatePreview() {
            const data = collectData();
            const title = data.isAddition ? "追加報價單" : "報價單";
            if (!data.customer || !data.project) return alert("客戶與專案名稱為必填");

            const canvas = document.getElementById('quotation-canvas');
            let itemsHtml = '';
            let subtotal = 0;

            let currentCategoryName = '';
            let currentCategoryTotal = 0;
            let currentCategoryItems = [];
            let catIndex = 1;

            const renderCategoryRow = (name, total) => {
                const displayName = toChineseIndex(catIndex++) + "、" + name;
                return `<tr class="bg-gray-100 border-t-2 border-gray-600 border-b border-gray-400 text-gray-800">
            <td colspan="5" class="font-bold text-left pl-4 py-2 align-middle text-sm">${displayName}</td>
            <td class="font-bold text-right pr-2 py-2 align-middle text-sm">小計：${total.toLocaleString()}</td>
            <td class="align-middle"></td>
        </tr>`;
            };

            const renderItemRow = (item, idx) => {
                const total = item.qty * item.price;
                return `<tr class="border-b border-gray-200">
            <td class="text-center py-2 align-middle">${idx}</td>
            <td class="py-2 pl-2 align-middle font-medium">${item.name}</td>
            <td class="text-center py-2 align-middle">${item.unit}</td>
            <td class="text-center py-2 align-middle">${item.qty}</td>
            <td class="text-right py-2 pr-2 align-middle font-mono">${item.price.toLocaleString()}</td>
            <td class="text-right py-2 pr-2 align-middle font-mono">${total.toLocaleString()}</td>
            <td class="text-xs text-gray-500 py-2 pl-1 align-middle">${item.remark || ''}</td>
        </tr>`;
            };

            let globalIdx = 1;

            data.items.forEach((item) => {
                if (item.type === 'category') {
                    if (currentCategoryName) {
                        itemsHtml += renderCategoryRow(currentCategoryName, currentCategoryTotal);
                        currentCategoryItems.forEach(i => itemsHtml += i);
                    }
                    currentCategoryName = item.category;
                    currentCategoryTotal = 0;
                    currentCategoryItems = [];
                } else {
                    const itemTotal = item.qty * item.price;
                    currentCategoryTotal += itemTotal;
                    subtotal += itemTotal;
                    currentCategoryItems.push(renderItemRow(item, globalIdx++));
                }
            });

            if (currentCategoryName) {
                itemsHtml += renderCategoryRow(currentCategoryName, currentCategoryTotal);
                currentCategoryItems.forEach(i => itemsHtml += i);
            } else {
                currentCategoryItems.forEach(i => itemsHtml += i);
            }

            // [New] Append "Below Blank" row
            itemsHtml += `<tr>
                <td colspan="7" class="text-center text-gray-400 py-8 tracking-[0.5em] text-xs">*** 以 下 空 白 ***</td>
            </tr>`;

            let feesHtml = '';
            let feesTotal = 0;
            data.fees.forEach(fee => {
                const amt = fee.type === 'percent' ? Math.round(subtotal * fee.val / 100) : fee.val;
                feesTotal += amt;
                feesHtml += `<div class="summary-row">
            <div class="summary-label">${fee.name}:</div>
            <div class="summary-value font-mono">${amt.toLocaleString()}</div>
        </div>`;
            });

            const untaxedTotal = subtotal + feesTotal;
            const taxAmt = Math.round(untaxedTotal * 0.05);
            const grandTotal = untaxedTotal + taxAmt;

            const clientDisplay = data.customer + (data.taxId ? ` (${data.taxId})` : '');

            canvas.innerHTML = `
        <div class="flex-none">
            <div class="flex justify-between items-center mb-6">
                <div class="w-1/3">
                    <img src="${LOGO_URL}" style="max-height: 100px; max-width: 100%; object-fit: contain;">
                </div>
                <div class="flex-1 text-center relative">
                    <div class="company-title text-3xl mb-1 text-blue-900 font-bold tracking-wide">健益工程有限公司</div>
                    <div class="doc-title text-xl text-gray-600 font-bold tracking-[0.5em] border-b-2 border-gray-400 inline-block px-6 pb-1">
                        ${title}</div>
                </div>
                <div class="w-1/3 text-right">
                     <div class="text-sm text-gray-500 font-mono">日期：${data.date}</div>
                </div>
            </div>
            
            <table class="info-table mb-4 w-full text-base border-collapse">
                <tr>
                    <td class="w-24 bg-gray-100 font-bold text-center border border-gray-300 p-2 align-middle text-gray-700">客戶名稱</td>
                    <td class="w-[40%] border border-gray-300 p-2 font-bold align-middle text-lg">${clientDisplay}</td>
                    <td class="w-24 bg-gray-100 font-bold text-center border border-gray-300 p-2 align-middle text-gray-700">聯絡人</td>
                    <td class="border border-gray-300 p-2 align-middle">${data.contactPerson}</td>
                </tr>
                <tr>
                    <td class="bg-gray-100 font-bold text-center border border-gray-300 p-2 align-middle text-gray-700">工程名稱</td>
                    <td class="border border-gray-300 p-2 font-bold align-middle text-lg">${data.projectName}</td>
                    <td class="bg-gray-100 font-bold text-center border border-gray-300 p-2 align-middle text-gray-700">聯絡電話</td>
                    <td class="border border-gray-300 p-2 align-middle">
                        <div class="flex gap-4 items-center">
                            <span>手機：${data.contactPhone}</span>
                            ${data.tel ? `<span>市話：${data.tel}</span>` : ''}
                        </div>
                    </td>
                </tr>
            </table>

            <style>
                .items-table th, .items-table td { vertical-align: middle; }
            </style>

            <table class="items-table w-full text-sm border-collapse border-b-2 border-blue-900">
                <thead class="bg-blue-900 text-white">
                    <tr>
                        <th class="w-12 border border-blue-800 p-2 text-center align-middle">項次</th>
                        <th class="border border-blue-800 p-2 text-left align-middle">項目名稱</th>
                        <th class="w-16 border border-blue-800 p-2 text-center align-middle">單位</th>
                        <th class="w-16 border border-blue-800 p-2 text-center align-middle">數量</th>
                        <th class="w-28 border border-blue-800 p-2 text-right align-middle">單價</th>
                        <th class="w-28 border border-blue-800 p-2 text-right align-middle">複價</th>
                        <th class="w-40 border border-blue-800 p-2 text-left align-middle">備註</th>
                    </tr>
                </thead>
                <tbody>${itemsHtml}</tbody>
            </table>
        </div>

        <div class="flex-1"></div>

        <div class="flex-none mt-4">
            <div class="flex justify-end mb-4">
                <div class="w-1/3 min-w-[260px] space-y-1">
                    <div class="flex justify-between text-base">
                        <div class="font-bold text-gray-600">未稅合計:</div>
                        <div class="font-bold font-mono tracking-wide">${untaxedTotal.toLocaleString()}</div>
                    </div>
                    ${feesHtml}
                    <div class="flex justify-between text-base">
                         <div class="font-bold text-gray-600">稅金金額 (5%):</div>
                         <div class="font-bold font-mono tracking-wide">${taxAmt.toLocaleString()}</div>
                    </div>
                    <div class="flex justify-between border-t-2 border-black font-bold text-xl pt-1">
                        <div class="text-blue-900">總計金額:</div>
                        <div class="text-blue-900 font-mono tracking-wide text-2xl">$ ${grandTotal.toLocaleString()}</div>
                    </div>
                     <div class="mt-1 text-right text-sm text-gray-500">
                        新台幣：<span class="font-bold underline text-base text-black px-1">${toChineseAmt(grandTotal)}</span>
                    </div>
                </div>
            </div>

            <div class="mb-4 text-sm">
                <div class="border border-black rounded p-3 relative bg-gray-50/50">
                    <div class="font-bold mb-1 text-gray-800">備註事項：</div>
                    <div class="pl-2 whitespace-pre-wrap font-mono text-gray-700 leading-relaxed tracking-wide">${data.note || "無"}</div>
                </div>
            </div>
            
            <div class="flex justify-between items-center text-sm font-bold text-gray-800 border-t-2 border-gray-300 pt-3">
                <div class="flex gap-8">
                    <div class="flex items-center gap-2">業務專員：<span class="text-black border-b border-black text-lg px-2 pb-0.5 min-w-[80px] text-center">${data.salesPerson || '-'}</span></div>
                    <div class="flex items-center gap-2">聯絡電話：<span class="text-black border-b border-black text-lg px-2 pb-0.5 min-w-[120px] text-center">${data.salesMobile || '-'}</span></div>
                </div>
                <div class="text-xs text-gray-500 font-normal">本報價單有效期限為 15 天，逾期請重新詢價。</div>
            </div>
        </div>
        `;

            document.getElementById('preview-modal').classList.remove('hidden');
        }


        function collectData() {
            const rows = document.querySelectorAll('.item-row');
            const items = Array.from(rows).map(row => {
                if (row.dataset.type === 'category') {
                    return { type: 'category', category: row.querySelector('.input-category').value };
                } else {
                    const uSel = row.querySelector('.input-unit-select');
                    const uCustom = row.querySelector('.input-unit-custom');
                    return {
                        type: 'item',
                        name: row.querySelector('.input-name').value,
                        qty: parseFloat(row.querySelector('.input-qty').value) || 0,
                        unit: uSel.classList.contains('hidden') ? uCustom.value : uSel.value,
                        price: parseFloat(row.querySelector('.input-price').value) || 0,
                        remark: row.querySelector('.input-remark').value
                    };
                }
            });

            const fees = Array.from(document.querySelectorAll('.fee-row')).map(row => ({
                name: row.querySelector('.fee-name').value,
                type: row.querySelector('.fee-type').value,
                val: parseFloat(row.querySelector('.fee-value').value) || 0
            }));

            let subtotal = 0;
            items.forEach(item => {
                if (item.type !== 'category') subtotal += (item.qty * item.price);
            });

            let feesTotal = 0;
            fees.forEach(fee => {
                feesTotal += fee.type === 'percent' ? Math.round(subtotal * fee.val / 100) : fee.val;
            });

            const grandTotal = subtotal + feesTotal;

            return {
                type: 'quotation',
                customer: document.getElementById('customer').value,
                taxId: document.getElementById('taxId').value,
                contactPerson: document.getElementById('contactPerson').value,
                contactPhone: document.getElementById('contactPhone').value,
                project: document.getElementById('projectName').value,
                projectName: document.getElementById('projectName').value,
                date: document.getElementById('quoteDate').value,
                salesPerson: document.getElementById('salesPerson').value,
                salesMobile: document.getElementById('salesMobile').value,
                originId: currentOriginId,
                lineUser: lineUser,
                fax: document.getElementById('customerFax').value,
                tel: document.getElementById('customerTel').value,
                status: document.getElementById('dealClosed').checked ? 'closed' : 'open',
                isAddition: document.getElementById('isAddition').checked,
                items: items,
                fees: fees,
                note: document.getElementById('footerNote').value,
                subtotalNoTax: subtotal,
                taxAmount: 0,
                grandTotal: grandTotal
            };
        }



        async function testDownloadImage() {
            const canvas = document.getElementById('quotation-canvas');
            // Use closest button if event.target is icon
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 產生中...';
            btn.disabled = true;

            try {
                const bitmap = await html2canvas(canvas, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                const dataUrl = bitmap.toDataURL('image/jpeg', 0.8);

                const data = collectData();
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = `[測試]_${data.date}_${data.customer}_${data.project}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (e) {
                alert("圖片產生失敗: " + e);
                console.error(e);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function submitData() {
            const data = collectData();
            const canvas = document.getElementById('quotation-canvas');
            const bitmap = await html2canvas(canvas, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
            data.image = bitmap.toDataURL('image/jpeg', 0.8);

            // [New] Auto Download Image
            const link = document.createElement('a');
            link.href = data.image;
            link.download = `${data.date}_${data.customer}_${data.project}_報價單.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            const btn = document.querySelector('#preview-modal button:last-child');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 上傳中...';
            btn.disabled = true;

            try {
                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.status === 'success') {
                    alert(`儲存成功！\n正式單號：${result.id} \n內控ID：${result.internalId}`);
                    document.getElementById('internalProjectId').value = result.internalId;
                    location.reload();
                } else {
                    alert("儲存失敗: " + result.message);
                }
            } catch (e) {
                alert("儲存失敗 (可能是網路問題): " + e.toString());
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function toChineseAmt(n) {
            if (n < 0) return "負 " + toChineseAmt(Math.abs(n));
            const fraction = ['角', '分'];
            const digit = ['零', '壹', '貳', '參', '肆', '伍', '陸', '柒', '捌', '玖'];
            const unit = [['元', '萬', '億'], ['', '拾', '佰', '仟']];
            let s = '';
            for (let i = 0; i < fraction.length; i++) {
                s += (digit[Math.floor(n * 10 * Math.pow(10, i)) % 10] + fraction[i]).replace(/零./, '');
            }
            s = s || '整';
            n = Math.floor(n);
            for (let i = 0; i < unit[0].length && n > 0; i++) {
                let p = '';
                for (let j = 0; j < unit[1].length && n > 0; j++) {
                    p = digit[n % 10] + unit[1][j] + p;
                    n = Math.floor(n / 10);
                }
                s = p.replace(/(零.)*零$/, '').replace(/^$/, '零') + unit[0][i] + s;
            }
            return s.replace(/(零.)*零元/, '元').replace(/(零.)+/g, '零').replace(/^整$/, '零元整');
        }

        function toChineseIndex(num) {
            const chineseNums = ['零', '一', '二', '三', '四', '五', '六', '七', '八', '九'];
            if (num < 10) return chineseNums[num];
            if (num < 20) {
                const digit = num % 10;
                return '十' + (digit === 0 ? '' : chineseNums[digit]);
            }
            const ten = Math.floor(num / 10);
            const digit = num % 10;
            return chineseNums[ten] + '十' + (digit === 0 ? '' : chineseNums[digit]);
        }

        function loadQuoteForEdit(id) {
            if (!id) {
                location.reload();
                return;
            }
            const p = projectList.find(x => x.id == id);
            if (!p) {
                alert("找不到該單據資料，請稍後再試。");
                return;
            }

            // Populate Fields
            currentOriginId = p.id.split('-').slice(0, 2).join('-');
            document.getElementById('edit-mode-badge').classList.remove('hidden');
            document.getElementById('edit-mode-badge').classList.add('inline-flex');

            document.getElementById('customer').value = p.customer || "";
            document.getElementById('projectName').value = p.project || "";
            document.getElementById('quoteDate').value = p.date || "";
            if (p.sales) document.getElementById('salesPerson').value = p.sales;

            if (p.json) {
                try {
                    const data = JSON.parse(p.json);
                    document.getElementById('contactPerson').value = data.contactPerson || "";
                    document.getElementById('contactPhone').value = data.contactPhone || "";
                    document.getElementById('salesMobile').value = data.salesMobile || "";
                    document.getElementById('footerNote').value = data.note || "";
                    if (data.taxId) document.getElementById('taxId').value = data.taxId;
                    document.getElementById('customerFax').value = data.fax || (p && p.fax) || "";
                    document.getElementById('customerTel').value = data.tel || "";
                    document.getElementById('dealClosed').checked = (data.status === 'closed' || (p && p.status === 'closed'));
                    document.getElementById('internalProjectId').value = p.id;

                    const container = document.getElementById('items-container');
                    container.innerHTML = '';

                    if (data.items && data.items.length > 0) {
                        data.items.forEach(item => {
                            addRow(item.type);
                            const row = container.lastElementChild;
                            if (item.type === 'category') {
                                row.querySelector('.input-category').value = item.category;
                            } else {
                                row.querySelector('.input-name').value = item.name;
                                row.querySelector('.input-qty').value = item.qty;
                                row.querySelector('.input-price').value = item.price;
                                row.querySelector('.input-remark').value = item.remark || "";

                                const safeUnit = item.unit || "";
                                const uSel = row.querySelector('.input-unit-select');
                                const uCustom = row.querySelector('.input-unit-custom');

                                let exists = false;
                                Array.from(uSel.options).forEach(opt => {
                                    if (opt.value === safeUnit) exists = true;
                                });

                                if (exists) {
                                    uSel.value = safeUnit;
                                } else {
                                    uSel.value = 'custom';
                                    handleUnitChange(uSel);
                                    uCustom.value = safeUnit;
                                }
                            }
                        });
                    }

                    const feesContainer = document.getElementById('fees-container');
                    feesContainer.innerHTML = '';
                    if (data.fees && data.fees.length > 0) {
                        data.fees.forEach(fee => {
                            addFeeRow();
                            const row = feesContainer.lastElementChild;
                            row.querySelector('.fee-name').value = fee.name;
                            row.querySelector('.fee-type').value = fee.type;
                            row.querySelector('.fee-value').value = fee.val;
                        });
                    }
                    alert("已載入歷史單據完整內容。");
                } catch (e) {
                    console.error(e);
                    alert("載入細項失敗，JSON格式錯誤: " + e.message);
                }
            } else {
                alert("此單據無詳細紀錄(JSON為空)，僅載入基本資料。");
            }
            updateAdditionState();
        }

        function formatPhone(input) {
            let val = input.value.replace(/\D/g, '');
            if (val.length > 10) val = val.substring(0, 10);

            if (val.length === 10 && val.startsWith('09')) {
                input.value = `${val.substring(0, 4)}-${val.substring(4, 7)}-${val.substring(7)}`;
            } else if (val.length > 0 && val.startsWith('0')) {
                if (val.length === 10 && (val.startsWith('04') || val.startsWith('07') || val.startsWith('02'))) {
                    input.value = `${val.substring(0, 2)}-${val.substring(2)}`;
                } else if (val.length > 3) {
                    // Default simple format, maybe improve later
                    input.value = val;
                }
            } else {
                input.value = val;
            }
        }

        function updateAdditionState() {
            const chk = document.getElementById('isAddition');
            const dealClosed = document.getElementById('dealClosed').checked;

            if (!currentOriginId) {
                chk.disabled = true;
                chk.checked = false;
                chk.parentElement.title = "僅限載入已成交之原始報價單後使用";
                return;
            }

            const hasLetterSuffix = /[A-Z]$/.test(currentOriginId);

            if (!hasLetterSuffix && dealClosed) {
                chk.disabled = false;
                chk.parentElement.title = "可製作此單據之追加單";
            } else {
                chk.disabled = true;
                chk.checked = false;
                if (hasLetterSuffix) chk.parentElement.title = "此單據已是追加單，無法再追加";
                else if (!dealClosed) chk.parentElement.title = "需先將原始單據標記為「已成交」才可製作追加單";
            }
        }
    </script>
</body>

</html>