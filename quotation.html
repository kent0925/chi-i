<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工程管理 - 報價系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }

        .preview-canvas {
            font-family: 'DFKai-SB', 'BiauKai', '標楷體', 'Noto Serif TC', serif;
            background-color: white;
            color: black;
            line-height: 1.3;
        }

        .company-title {
            font-size: 20pt;
            font-weight: bold;
            text-align: center;
        }

        .doc-title {
            font-size: 16pt;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        .info-table,
        .items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12pt;
        }

        .info-table td,
        .items-table th,
        .items-table td {
            border: 1px solid #000;
            padding: 4px 8px;
        }

        .summary-row {
            display: flex;
            justify-content: flex-end;
            font-size: 12pt;
            padding: 2px 0;
        }

        .summary-label {
            text-align: right;
            padding-right: 10px;
            width: 150px;
        }

        .summary-value {
            text-align: right;
            width: 120px;
            padding-right: 4px;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-100 to-gray-200 min-h-screen p-4 md:p-8 font-sans text-gray-700">
    <div
        class="max-w-5xl mx-auto bg-white/90 backdrop-blur-md rounded-2xl shadow-2xl overflow-hidden border border-white/50">
        <div
            class="bg-gradient-to-r from-blue-900 to-slate-800 p-6 text-white flex justify-between items-center shadow-md relative overflow-hidden">
            <div
                class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10 pointer-events-none">
            </div>
            <div class="flex items-center gap-4 relative z-10">
                <div class="bg-white/10 p-2 rounded-lg backdrop-blur-sm">
                    <i class="fa-solid fa-file-invoice-dollar text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold tracking-wide">工程報價系統</h1>
                    <p class="text-xs text-blue-200">建置與管理客戶報價</p>
                </div>
            </div>

            <div class="flex items-center gap-3 relative z-10">
                <!-- LIFF Profile -->
                <div id="liff-profile"
                    class="hidden flex items-center gap-2 bg-white/10 p-1.5 pr-3 rounded-full backdrop-blur-sm border border-white/20">
                    <img id="liff-picture" src="" alt="Profile" class="w-8 h-8 rounded-full border border-white/50">
                    <div class="flex flex-col">
                        <span id="liff-name" class="text-xs font-bold text-white">Loading</span>
                    </div>
                </div>

                <button onclick="location.href='index.html'"
                    class="text-sm bg-white/10 border border-white/20 px-4 py-2 rounded-full hover:bg-white/20 transition-all flex items-center gap-2 backdrop-blur-sm shadow-sm group">
                    <i class="fa-solid fa-arrow-left group-hover:-translate-x-1 transition-transform"></i>
                    返回主選單
                </button>
            </div>
        </div>

        <div class="p-6">
            <!-- 來源資料 (修改模式) -->
            <div class="mb-4 bg-blue-50 p-3 rounded border border-blue-200">
                <label class="font-bold text-blue-900 text-sm mr-2">修改歷史單據：</label>
                <select id="historySelect" onchange="loadQuoteForEdit(this.value)"
                    class="border border-blue-300 rounded p-1 text-sm w-64">
                    <option value="">-- 建立新單據 --</option>
                </select>
                <span id="edit-mode-badge"
                    class="hidden bg-red-500 text-white text-xs px-2 py-1 rounded ml-2">修改模式</span>
            </div>

            <!-- 業務與內部資訊 -->
            <div class="mb-4 bg-gray-100 p-3 rounded border border-gray-300">
                <h3 class="text-xs font-bold text-gray-500 mb-2 border-b pb-1">業務與內控資訊</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">專案ID (內控/臨時碼)</label>
                        <input type="text" id="internalProjectId"
                            class="w-full border border-gray-300 rounded p-1 text-sm bg-gray-100 text-gray-400 italic font-bold"
                            value="(存檔後自動產生)" readonly>
                        <span class="text-[10px] text-gray-400 block mt-0.5">格式：年份+日期+序號</span>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">業務人員</label>
                        <select id="salesPerson" class="w-full border border-gray-300 rounded p-1 text-sm bg-white"
                            onchange="saveConfig('sales', this.value)">
                            <option value="">-- 請選擇 --</option>
                            <option value="NEW"> + 新增...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">業務手機</label>
                        <input type="text" id="salesMobile" class="w-full border border-gray-300 rounded p-1 text-sm"
                            placeholder="09xx-xxx-xxx">
                    </div>
                </div>
            </div>

            <!-- 客戶基本資料 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="md:col-span-2 bg-blue-50 p-3 rounded-md border border-blue-100">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        客戶名稱 <span class="text-xs text-blue-500 font-normal ml-2">(可輸入統編8碼自動帶入)</span>
                    </label>
                    <div class="flex gap-2 mb-2 items-center">
                        <div class="w-1/3 relative">
                            <input type="text" id="taxId" class="w-full border border-gray-300 rounded-md p-2 text-sm"
                                placeholder="統編(選填)" oninput="checkTaxId(this)">
                            <span id="tax-warning"
                                class="hidden absolute top-full left-0 text-[10px] text-red-500 font-bold">請輸入8碼數字</span>
                        </div>
                        <button onclick="lookupCompany()"
                            class="bg-blue-600 text-white px-3 py-1 rounded-md text-xs h-9">查詢</button>
                        <input type="text" id="customer" class="flex-1 border border-gray-300 rounded-md p-2"
                            placeholder="輸入客戶名稱">
                    </div>
                </div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1">客戶聯絡人</label><input type="text"
                        id="contactPerson" class="w-full border border-gray-300 rounded-md p-2 text-sm"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1">客戶聯絡電話</label><input type="text"
                        id="contactPhone" class="w-full border border-gray-300 rounded-md p-2 text-sm"></div>
                <div class="md:col-span-2"><label
                        class="block text-sm font-medium text-gray-700 mb-1">工程/專案名稱</label><input type="text"
                        id="projectName" class="w-full border border-gray-300 rounded-md p-2 text-sm"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1">日期</label><input type="date"
                        id="quoteDate" class="w-full border border-gray-300 rounded-md p-2 text-sm"></div>
            </div>

            <!-- 明細內容 -->
            <h3 class="text-md font-bold text-gray-700 mb-2">明細內容</h3>
            <div id="items-container" class="space-y-3 mb-4"></div>
            <div class="flex gap-3 mb-6">
                <button onclick="addRow('category')"
                    class="flex-1 py-2 px-4 border border-gray-300 bg-gray-50 text-gray-700 font-bold rounded hover:bg-gray-100">+
                    大項次</button>
                <button onclick="addRow('item')"
                    class="flex-1 py-2 px-4 border border-blue-300 bg-blue-50 text-blue-700 font-bold rounded hover:bg-blue-100">+
                    細項</button>
            </div>

            <!-- 額外費用 -->
            <div class="mb-4 bg-yellow-50 p-4 rounded border border-yellow-200">
                <label class="block text-sm font-bold text-gray-700 mb-2">額外費用</label>
                <div id="fees-container" class="space-y-2 mb-3"></div>
                <button onclick="addFeeRow()"
                    class="text-sm bg-white border border-yellow-400 text-yellow-700 px-3 py-1 rounded hover:bg-yellow-100">+
                    新增費用</button>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">備註說明</label>
                <textarea id="footerNote" class="w-full border border-gray-300 rounded-md p-2 text-sm h-20"
                    placeholder="例如：報價有效期、付款條件..."></textarea>
            </div>

            <button onclick="generatePreview('工程報價單')"
                class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-blue-700 transition">
                預覽並確認內容
            </button>
        </div>
    </div>

    <!-- 預覽視窗 -->
    <div id="preview-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50 overflow-y-auto p-4">
        <div class="bg-white rounded shadow-xl max-w-[230mm] w-full overflow-hidden flex flex-col max-h-[95vh]">
            <div class="overflow-y-auto flex-1 bg-gray-500 p-4 flex justify-center">
                <div id="quotation-canvas"
                    class="preview-canvas bg-white p-12 w-full max-w-[210mm] min-h-[297mm] shadow-lg relative">
                    <!-- 預覽內容由 JS 填充 -->
                </div>
            </div>
            <div class="p-4 bg-gray-50 flex gap-4 border-t z-50">
                <button onclick="document.getElementById('preview-modal').classList.add('hidden')"
                    class="flex-1 py-2 bg-gray-200 text-gray-800 rounded font-bold hover:bg-gray-300">返回修改</button>
                <button onclick="submitData()"
                    class="flex-1 py-2 bg-blue-600 text-white rounded font-bold shadow hover:bg-blue-700">確認儲存並產生圖檔</button>
            </div>
        </div>
    </div>

    <!-- 共用 Datalists -->
    <datalist id="sales-list"></datalist>
    <datalist id="unit-list"></datalist>

    <script>
        const LIFF_ID = '2008974069-Ecojk6W1';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxrXo9AcczzlIazBPTqxZij7CVAcqcXtbbpGJMKQ4RoEFRp8JsTtjLZw1R6xZwwvnnt/exec';
        let salesPersons = [];
        let unitOptions = [];
        let projectList = [];
        let currentOriginId = null;
        let lineUser = null;

        // Logo URL (請使用者自行替換為真實 Logo URL，需注意 CORS)
        const LOGO_URL = 'https://kent0925.github.io/chi-i/unnamed.png';

        window.onload = function () {
            initializeLiff();
            const dateInput = document.getElementById('quoteDate');
            if (dateInput) dateInput.value = new Date().toISOString().split('T')[0];
            fetchConfig();
            // 預設不新增行，讓使用者自己點，或維持預設
            if (document.querySelectorAll('.item-row').length === 0) {
                addRow('category');
                addRow('item');
            }
        };

        async function initializeLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    lineUser = profile;
                    const pBlock = document.getElementById('liff-profile');
                    if (pBlock) {
                        pBlock.classList.remove('hidden');
                        document.getElementById('liff-picture').src = profile.pictureUrl;
                        document.getElementById('liff-name').innerText = profile.displayName;
                    }
                } else {
                    liff.login();
                }
            } catch (e) {
                console.error('LIFF Init Error', e);
            }
        }

        function fetchConfig() {
            fetch(GAS_URL)
                .then(res => res.json())
                .then(data => {
                    salesPersons = data.sales || [];
                    unitOptions = data.units || [];
                    projectList = data.projects || [];
                    renderLists();
                    populateHistory();
                })
                .catch(err => console.error("GAS Error:", err));
        }

        function renderLists() {
            const sList = document.getElementById('sales-list');
            if (sList) sList.innerHTML = salesPersons.map(s => `<option value="${s}">`).join('');

            const sSelect = document.getElementById('salesPerson');
            if (sSelect) {
                const cur = sSelect.value;
                sSelect.innerHTML = '<option value="">-- 請選擇 --</option>' +
                    salesPersons.map(s => `<option value="${s}">${s}</option>`).join('') +
                    '<option value="NEW"> + 新增...</option>';
                if (cur) sSelect.value = cur;
            }

            const uList = document.getElementById('unit-list');
            if (uList) uList.innerHTML = unitOptions.map(u => `<option value="${u}">`).join('');
        }

        function populateHistory() {
            const hSel = document.getElementById('historySelect');
            if (hSel) {
                hSel.innerHTML = '<option value="">-- 建立新單據 --</option>' + projectList.map(p => {
                    const label = `${p.date} ${p.customer} (${p.project})`;
                    return `<option value="${p.id}">${label}</option>`;
                }).join('');
            }
        }

        function addRow(type) {
            const container = document.getElementById('items-container');

            // 防呆：檢查最後一項是否已填寫 (僅檢查 item 類型，category 不強制)
            const lastRow = container.querySelector('.item-row:last-child');
            if (lastRow && !lastRow.classList.contains('bg-gray-100')) { // 判斷是否為細項 (Category有 bg-gray-100)
                const nameVal = lastRow.querySelector('.input-name').value;
                if (!nameVal.trim()) {
                    alert("請先完成上方細項內容後再新增！");
                    return;
                }
            }

            const id = Date.now() + Math.random().toString(36).substr(2, 5);
            const div = document.createElement('div');
            // Category: 灰色背景; Item: 白色背景
            const isCat = (type === 'category');
            div.className = "flex gap-2 items-center item-row p-2 rounded " + (isCat ? "bg-gray-100 border-l-4 border-gray-400 params-category" : "bg-white border border-gray-100 shadow-sm params-item");
            div.id = 'row-' + id;
            div.dataset.type = type;

            if (isCat) {
                div.innerHTML = `
    <div class="font-bold text-gray-400 px-2">●</div>
    <input type="text" class="input-category flex-1 border-b border-gray-300 bg-transparent p-1 font-bold outline-none"
        placeholder="大項次名稱 (例如: 一、拆除工程)">
    <button onclick="this.parentElement.remove()" class="text-gray-300 hover:text-red-500 px-2"><i
            class="fa-solid fa-trash-can"></i></button>
    `;
            } else {
                div.innerHTML = `
    <div class="w-8 text-center text-xs text-gray-300 item-seq"></div>
    <input type="text" class="input-name flex-[3] border border-gray-300 rounded p-1 text-sm" placeholder="細項描述">
    <input type="number" class="input-qty w-16 border border-gray-300 rounded p-1 text-sm text-center" placeholder="數量"
        value="1">
    <div class="w-20">
        <select onchange="handleUnitChange(this)"
            class="input-unit-select w-full border border-gray-300 rounded p-1 text-xs">
            <option value="">單位</option>
            ${unitOptions.map(u => `<option value="${u}">${u}</option>`).join('')}
            <option value="custom">+ 其他</option>
        </select>
        <input type="text" onblur="checkNewUnit(this)"
            class="input-unit-custom hidden w-full border border-gray-300 rounded p-1 text-xs" placeholder="新單位">
    </div>
    <input type="number" onchange="checkPrice(this)"
        class="input-price flex-[1.5] border border-gray-300 rounded p-1 text-sm text-right" placeholder="單價">
    <input type="text" class="input-remark flex-[2] border border-gray-300 rounded p-1 text-xs" placeholder="備註">
    <button onclick="this.parentElement.remove(); reindexItems();" class="text-gray-300 hover:text-red-500 px-2"><i
            class="fa-solid fa-trash-can"></i></button>
    `;
            }
            container.appendChild(div);
            if (!isCat) reindexItems();
        }

        function reindexItems() {
            const rows = document.querySelectorAll('.item-row');
            let seq = 1;
            rows.forEach(row => {
                if (row.dataset.type === 'item') {
                    row.querySelector('.item-seq').innerText = seq++;
                }
            });
        }

        function handleUnitChange(sel) {
            const custom = sel.nextElementSibling;
            if (sel.value === 'custom') {
                sel.classList.add('hidden');
                custom.classList.remove('hidden');
                custom.focus();
            }
        }

        // 新增單位檢查
        function checkNewUnit(input) {
            const val = input.value.trim();
            if (val && !unitOptions.includes(val)) {
                if (confirm(`是否將新單位「${val}」加入常用清單？`)) {
                    saveToBackend('unit', val);
                }
            }
        }

        // 負數金額檢查
        function checkPrice(input) {
            const val = parseFloat(input.value);
            if (val < 0) {
                if (confirm("金額為負數，是否設為折抵項目？（將自動於備註加入'折抵'）")) {
                    const row = input.closest('.item-row');
                    const remarkInput = row.querySelector('.input-remark');
                    if (remarkInput.value.indexOf('折抵') === -1) {
                        remarkInput.value = (remarkInput.value + " (折抵)").trim();
                    }
                }
            }
        }

        function addFeeRow() {
            const container = document.getElementById('fees-container');
            const div = document.createElement('div');
            div.className = "flex gap-2 fee-row";
            div.innerHTML = `
                <input type="text" class="fee-name flex-1 border border-gray-300 rounded p-1 text-sm" placeholder="費用項目 (例如：管理費)">
                <select class="fee-type border border-gray-300 rounded p-1 text-sm">
                    <option value="fixed">固定金額($)</option>
                    <option value="percent">百分比(%)</option>
                </select>
                <input type="number" class="fee-value w-24 border border-gray-300 rounded p-1 text-sm" placeholder="數值" min="0" oninput="if(this.value<0)this.value=0">
                <button onclick="this.parentElement.remove()" class="text-red-400 px-2">×</button>
            `;
            container.appendChild(div);
        }

        async function lookupCompany() {
            const taxId = document.getElementById('taxId').value;
            if (taxId.length !== 8) return alert("請輸入8碼統編");
            const btn = event.target;
            btn.innerText = "查詢中...";
            try {
                const res = await fetch(`${GAS_URL}?action=lookup&taxId=${taxId}`);
                const data = await res.json();
                if (data.name) {
                    document.getElementById('customer').value = data.name;
                } else {
                    alert(data.error || "查無此統編資料");
                }
            } catch (e) {
                alert("連線失敗或超過查詢量限制。");
            }
            btn.innerText = "查詢";
        }

        function saveConfig(type, val) {
            if (val === 'NEW') {
                const nv = prompt("請輸入新增項目名稱:");
                if (nv) {
                    saveToBackend(type, nv);
                    if (type === 'sales') {
                        setTimeout(() => {
                            const sel = document.getElementById('salesPerson');
                            if (sel) sel.value = nv;
                        }, 200);
                    }
                } else {
                    document.getElementById('salesPerson').value = "";
                }
                return;
            }
            if (val) saveToBackend(type, val);
        }

        function saveToBackend(type, val) {
            // Optimistic update
            if (type === 'sales' && !salesPersons.includes(val)) salesPersons.push(val);
            if (type === 'unit' && !unitOptions.includes(val)) unitOptions.push(val);
            // Re-render immediately
            renderLists();

            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'save_config', configType: type, value: val }),
                mode: 'no-cors'
            });
        }

        function checkTaxId(input) {
            input.value = input.value.replace(/\D/g, '');
            const warn = document.getElementById('tax-warning');
            if (input.value.length > 0 && input.value.length !== 8) warn.classList.remove('hidden');
            else warn.classList.add('hidden');
        }

        async function generatePreview(title) {
            const data = collectData();
            if (!data.customer || !data.project) return alert("客戶與專案名稱為必填");

            const canvas = document.getElementById('quotation-canvas');
            let itemsHtml = '';
            let subtotal = 0; // 全報價小記 (不含稅費)

            // 先將 items 分群處理大項次小計邏輯
            let currentCategoryName = '';
            let currentCategoryTotal = 0;
            let currentCategoryItems = [];
            let catIndex = 1;

            const renderCategoryRow = (name, total) => {
                const displayName = toChineseIndex(catIndex++) + "、" + name;
                return `<tr class="bg-gray-50 border-t-2 border-gray-400">
            <td colspan="5" class="font-bold text-left pl-4">${displayName}</td>
            <td class="font-bold text-right pr-2">小計：${total.toLocaleString()}</td>
            <td></td>
        </tr>`;
            };

            const renderItemRow = (item, idx) => {
                const total = item.qty * item.price;
                return `<tr>
            <td class="text-center">${idx}</td>
            <td>${item.name}</td>
            <td class="text-center">${item.unit}</td>
            <td class="text-center">${item.qty}</td>
            <td class="text-right">${item.price.toLocaleString()}</td>
            <td class="text-right">${total.toLocaleString()}</td>
            <td class="text-xs text-gray-500">${item.remark || ''}</td>
        </tr>`;
            };

            let globalIdx = 1;

            data.items.forEach((item) => {
                if (item.type === 'category') {
                    if (currentCategoryName) {
                        itemsHtml += renderCategoryRow(currentCategoryName, currentCategoryTotal);
                        currentCategoryItems.forEach(i => itemsHtml += i);
                    }
                    currentCategoryName = item.category;
                    currentCategoryTotal = 0;
                    currentCategoryItems = [];
                } else {
                    const itemTotal = item.qty * item.price;
                    currentCategoryTotal += itemTotal;
                    subtotal += itemTotal;
                    currentCategoryItems.push(renderItemRow(item, globalIdx++));
                }
            });

            if (currentCategoryName) {
                itemsHtml += renderCategoryRow(currentCategoryName, currentCategoryTotal);
                currentCategoryItems.forEach(i => itemsHtml += i);
            } else {
                currentCategoryItems.forEach(i => itemsHtml += i);
            }

            let feesHtml = '';
            let feesTotal = 0;
            data.fees.forEach(fee => {
                const amt = fee.type === 'percent' ? Math.round(subtotal * fee.val / 100) : fee.val;
                feesTotal += amt;
                feesHtml += `<div class="summary-row">
            <div class="summary-label">${fee.name}:</div>
            <div class="summary-value">${amt.toLocaleString()}</div>
        </div>`;
            });

            const grandTotal = subtotal + feesTotal;
            const clientDisplay = data.customer + (data.taxId ? ` <span
            class="text-sm font-normal text-gray-600">(${data.taxId})</span>` : '');

            canvas.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <div class="w-1/4">
                <img src="${LOGO_URL}" style="height: 60px; object-fit: contain;">
            </div>
            <div class="flex-1 text-center">
                <div class="company-title text-3xl mb-1 text-blue-900 font-bold">健益工程有限公司</div>
                <div
                    class="doc-title text-xl text-gray-600 font-bold tracking-widest border-b-2 border-gray-400 inline-block px-4 pb-1 mb-2">
                    ${title}</div>
            </div>
            <div class="w-1/4 text-right">
                <div class="font-bold text-lg text-gray-600">${data.date}</div>
            </div>
        </div>

        <table class="info-table mb-4 w-full text-sm border-collapse">
            <tr>
                <td class="w-24 bg-gray-100 font-bold text-center border p-2">客戶名稱</td>
                <td class="w-[40%] border p-2">${clientDisplay}</td>
                <td class="w-24 bg-gray-100 font-bold text-center border p-2">聯絡人</td>
                <td class="border p-2">${data.contactPerson}</td>
            </tr>
            <tr>
                <td class="bg-gray-100 font-bold text-center border p-2">工程名稱</td>
                <td class="border p-2">${data.projectName}</td>
                <td class="bg-gray-100 font-bold text-center border p-2">聯絡電話</td>
                <td class="border p-2">${data.contactPhone}</td>
            </tr>
        </table>

        <table class="items-table mb-4 w-full text-sm border-collapse">
            <thead class="bg-blue-800 text-white">
                <tr>
                    <th class="w-10 border p-1 text-center">項次</th>
                    <th class="border p-1 text-left">項目名稱</th>
                    <th class="w-16 border p-1 text-center">單位</th>
                    <th class="w-16 border p-1 text-center">數量</th>
                    <th class="w-24 border p-1 text-right">單價</th>
                    <th class="w-24 border p-1 text-right">複價</th>
                    <th class="w-32 border p-1 text-left">備註</th>
                </tr>
            </thead>
            <tbody>${itemsHtml}</tbody>
        </table>

        <div class="flex justify-between items-end p-2 mt-auto">
            <div class="text-sm text-gray-600">
                <div class="mb-1"><i class="fa-solid fa-user-tie mr-1"></i>業務專員：<span
                        class="font-underline font-bold text-black border-b border-black">${data.salesPerson ||
                '-'}</span></div>
                <div><i class="fa-solid fa-mobile-screen mr-1"></i>聯絡電話：<span
                        class="font-underline font-bold text-black border-b border-black">${data.salesMobile ||
                '-'}</span></div>
                <div class="mt-2 text-xs text-gray-400">本報價單有效期限為 15 天，逾期請重新詢價。</div>
            </div>

            <div class="w-1/3">
                <div class="flex justify-between mb-1">
                    <div class="font-bold text-gray-600">合計:</div>
                    <div class="font-bold">${subtotal.toLocaleString()}</div>
                </div>
                ${feesHtml}
                <div class="flex justify-between border-t-2 border-black font-bold text-lg mt-1 pt-1">
                    <div class="text-blue-900">總計:</div>
                    <div class="text-blue-900">${grandTotal.toLocaleString()}</div>
                </div>
                <div class="mt-2 text-right border-t border-gray-300 pt-1 text-sm text-gray-500">
                    新台幣：<span class="font-bold underline text-md text-black">${toChineseAmt(grandTotal)}</span>
                </div>
            </div>
        </div>

        <div class="mt-4 border-t border-gray-200 pt-2 text-xs text-gray-500">
            <div>備註：</div>
            <div class="pl-4 whitespace-pre-wrap font-mono">${data.note}</div>
        </div>
        `;

            document.getElementById('preview-modal').classList.remove('hidden');
        }


        function collectData() {
            const rows = document.querySelectorAll('.item-row');
            const items = Array.from(rows).map(row => {
                if (row.dataset.type === 'category') {
                    return { type: 'category', category: row.querySelector('.input-category').value };
                } else {
                    const uSel = row.querySelector('.input-unit-select');
                    const uCustom = row.querySelector('.input-unit-custom');
                    return {
                        type: 'item',
                        name: row.querySelector('.input-name').value,
                        qty: parseFloat(row.querySelector('.input-qty').value) || 0,
                        unit: uSel.classList.contains('hidden') ? uCustom.value : uSel.value,
                        price: parseFloat(row.querySelector('.input-price').value) || 0,
                        remark: row.querySelector('.input-remark').value
                    };
                }
            });

            const fees = Array.from(document.querySelectorAll('.fee-row')).map(row => ({
                name: row.querySelector('.fee-name').value,
                type: row.querySelector('.fee-type').value,
                val: parseFloat(row.querySelector('.fee-value').value) || 0
            }));

            return {
                type: 'quotation',
                customer: document.getElementById('customer').value,
                taxId: document.getElementById('taxId').value,
                contactPerson: document.getElementById('contactPerson').value,
                contactPhone: document.getElementById('contactPhone').value,
                project: document.getElementById('projectName').value,
                projectName: document.getElementById('projectName').value,
                date: document.getElementById('quoteDate').value,
                salesPerson: document.getElementById('salesPerson').value,
                salesMobile: document.getElementById('salesMobile').value,
                originId: currentOriginId,
                lineUser: lineUser,
                items: items,
                fees: fees,
                note: document.getElementById('footerNote').value
            };
        }

        async function submitData() {
            const data = collectData();
            const canvas = document.getElementById('quotation-canvas');
            const bitmap = await html2canvas(canvas, { scale: 2, useCORS: true });
            data.image = bitmap.toDataURL('image/jpeg', 0.8);

            const btn = document.querySelector('#preview-modal button:last-child');
            const originalText = btn.innerText;
            btn.innerText = "上傳中...";
            btn.disabled = true;

            try {
                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.status === 'success') {
                    alert(`儲存成功！\n正式單號：${result.id} \n內控ID：${result.internalId}`);
                    document.getElementById('internalProjectId').value = result.internalId;
                    location.reload();
                } else {
                    alert("儲存失敗: " + result.message);
                }
            } catch (e) {
                alert("儲存失敗 (可能是網路問題): " + e.toString());
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function toChineseAmt(n) {
            if (n < 0) return "負 " + toChineseAmt(Math.abs(n));
            const fraction = ['角', '分'];
            const digit = ['零', '壹', '貳', '參', '肆', '伍', '陸', '柒', '捌', '玖'];
            const unit = [['元', '萬', '億'], ['', '拾', '佰', '仟']];
            let s = '';
            for (let i = 0; i < fraction.length; i++) {
                s += (digit[Math.floor(n * 10 * Math.pow(10, i)) % 10] + fraction[i]).replace(/零./, '');
            }
            s = s || '整';
            n = Math.floor(n);
            for (let i = 0; i < unit[0].length && n > 0; i++) {
                let p = '';
                for (let j = 0; j < unit[1].length && n > 0; j++) {
                    p = digit[n % 10] + unit[1][j] + p;
                    n = Math.floor(n / 10);
                }
                s = p.replace(/(零.)*零$/, '').replace(/^$/, '零') + unit[0][i] + s;
            }
            return s.replace(/(零.)*零元/, '元').replace(/(零.)+/g, '零').replace(/^整$/, '零元整');
        }

        function toChineseIndex(num) {
            const chineseNums = ['零', '一', '二', '三', '四', '五', '六', '七', '八', '九'];
            if (num < 10) return chineseNums[num];
            if (num < 20) {
                const digit = num % 10;
                return '十' + (digit === 0 ? '' : chineseNums[digit]);
            }
            const ten = Math.floor(num / 10);
            const digit = num % 10;
            return chineseNums[ten] + '十' + (digit === 0 ? '' : chineseNums[digit]);
        }

        function loadQuoteForEdit(id) {
            if (!id) {
                location.reload();
                return;
            }
            const p = projectList.find(x => x.id === id);
            if (!p) return;

            // 載入基本資料
            currentOriginId = p.id.split('-').slice(0, 2).join('-');
            document.getElementById('edit-mode-badge').classList.remove('hidden');
            document.getElementById('customer').value = p.customer || "";
            document.getElementById('projectName').value = p.project || "";
            document.getElementById('quoteDate').value = p.date || "";
            if (p.sales) document.getElementById('salesPerson').value = p.sales;

            // 載入詳細/歷史資料
            if (p.json) {
                try {
                    const data = JSON.parse(p.json);

                    document.getElementById('contactPerson').value = data.contactPerson || "";
                    document.getElementById('contactPhone').value = data.contactPhone || "";
                    document.getElementById('salesMobile').value = data.salesMobile || "";
                    document.getElementById('footerNote').value = data.note || "";
                    if (data.taxId) document.getElementById('taxId').value = data.taxId;

                    // 清空現有項目
                    const container = document.getElementById('items-container');
                    container.innerHTML = '';

                    if (data.items && data.items.length > 0) {
                        data.items.forEach(item => {
                            addRow(item.type);
                            const row = container.lastElementChild;
                            if (item.type === 'category') {
                                row.querySelector('.input-category').value = item.category;
                            } else {
                                row.querySelector('.input-name').value = item.name;
                                row.querySelector('.input-qty').value = item.qty;
                                row.querySelector('.input-price').value = item.price;
                                row.querySelector('.input-remark').value = item.remark || "";

                                // 單位處理
                                const safeUnit = item.unit || "";
                                const uSel = row.querySelector('.input-unit-select');
                                const uCustom = row.querySelector('.input-unit-custom');

                                // 檢查單位是否在清單中
                                let exists = false;
                                Array.from(uSel.options).forEach(opt => {
                                    if (opt.value === safeUnit) exists = true;
                                });

                                if (exists) {
                                    uSel.value = safeUnit;
                                } else {
                                    uSel.value = 'custom';
                                    handleUnitChange(uSel);
                                    uCustom.value = safeUnit;
                                }
                            }
                        });
                    }

                    // 清空並載入費用
                    const feesContainer = document.getElementById('fees-container');
                    feesContainer.innerHTML = '';
                    if (data.fees && data.fees.length > 0) {
                        data.fees.forEach(fee => {
                            addFeeRow();
                            const row = feesContainer.lastElementChild;
                            row.querySelector('.fee-name').value = fee.name;
                            row.querySelector('.fee-type').value = fee.type;
                            row.querySelector('.fee-value').value = fee.val;
                        });
                    }
                    alert("已載入歷史單據完整內容。");
                } catch (e) {
                    console.error(e);
                    alert("載入細項失敗，JSON格式錯誤。");
                }
            } else {
                alert("此單據無詳細紀錄，僅載入基本資料。");
            }
        }
    </script>
</body>

</html>