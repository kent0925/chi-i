<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>建立工程報價單</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* 引入 Google Fonts Noto Serif TC 作為替代，實際優先使用標楷體 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap');

        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 報價單預覽專用樣式 - 仿製上傳範本 */
        #quotation-canvas {
            font-family: 'DFKai-SB', 'BiauKai', '標楷體', 'Noto Serif TC', serif; /* 優先使用標楷體 */
            background-color: white;
            color: black;
            line-height: 1.3;
        }
        
        /* 標題樣式 */
        .company-title {
            font-size: 20pt;
            font-weight: bold;
            text-align: center;
        }
        .doc-title {
            font-size: 16pt;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        /* 表格樣式 */
        .info-table, .items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12pt;
        }
        
        .info-table td {
            border: 1px solid #000;
            padding: 4px 8px;
        }
        
        .items-table th {
            border: 1px solid #000;
            border-bottom: 2px solid #000; /* 標題下方加粗 */
            padding: 4px;
            text-align: center;
            font-weight: normal; /* 標楷體通常不需額外 bold */
        }
        
        .items-table td {
            border: 1px solid #000;
            padding: 4px;
        }

        /* 總計區塊樣式 */
        .summary-row {
            display: flex;
            justify-content: flex-end;
            font-size: 12pt;
            padding: 2px 0;
        }
        .summary-label {
            text-align: right;
            padding-right: 10px;
            width: 150px;
        }
        .summary-value {
            text-align: right;
            width: 120px;
            padding-right: 4px;
        }

        /* 歷史提示文字樣式 */
        .history-hint {
            font-size: 0.75rem;
            color: #d97706;
            margin-top: 2px;
            font-family: 'Noto Sans TC', sans-serif; /* 提示字維持黑體較清晰 */
        }

        /* 隱藏列印時不必要的元素 */
        @media print {
            .no-print { display: none; }
        }
    </style>
</head>
<body class="p-4">

    <!-- 輸入區域 -->
    <div id="input-section" class="max-w-3xl mx-auto bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-bold mb-6 text-gray-800 border-b pb-2">建立工程報價單</h2>

        <!-- 公司基本資料設定 (賣方) -->
        <div class="mb-6 bg-gray-50 p-4 rounded border border-gray-200">
            <h3 class="text-sm font-bold text-gray-700 mb-3">賣方(公司)資料設定</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- 移除 Logo 上傳按鈕，改為直接內建 -->
                <div>
                    <label class="block text-xs text-gray-500 mb-1">公司名稱</label>
                    <input type="text" id="sellerName" class="w-full border border-gray-300 rounded p-2 text-sm" value="健益工程有限公司">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">聯絡人資訊 (顯示於頁尾)</label>
                    <input type="text" id="sellerContact" class="w-full border border-gray-300 rounded p-2 text-sm" placeholder="例如：聯絡人：王小明 09xx-xxx-xxx">
                </div>
            </div>
        </div>
        
        <!-- 客戶與案件資料 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="md:col-span-2 bg-blue-50 p-3 rounded-md border border-blue-100">
                <label class="block text-sm font-medium text-gray-700 mb-1">客戶名稱 (個人/公司)</label>
                <div class="flex gap-2 mb-2">
                    <input type="text" id="taxId" class="w-1/3 border border-gray-300 rounded-md p-2 text-sm" placeholder="輸入統編(選填)" onchange="lookupCompany()">
                    <button onclick="lookupCompany()" class="bg-blue-600 text-white px-3 rounded-md text-xs hover:bg-blue-700 whitespace-nowrap">查詢名稱</button>
                    <span class="text-xs text-gray-500 self-center">*若為公司可輸入統編查詢</span>
                </div>
                <input type="text" id="customer" class="w-full border border-gray-300 rounded-md p-2" placeholder="請輸入完整客戶/公司名稱" oninput="loadCustomerHistory()">
                
                <!-- 客戶歷史紀錄顯示區 -->
                <div id="customer-history-area" class="mt-2 hidden">
                    <p class="text-xs text-gray-500 mb-1 font-bold">歷史報價紀錄：</p>
                    <ul id="customer-history-list" class="text-xs text-gray-600 bg-white border border-gray-200 rounded max-h-24 overflow-y-auto p-1"></ul>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">聯絡人</label>
                <input type="text" id="contactPerson" class="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="輸入聯絡人姓名">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">連絡電話</label>
                <input type="text" id="contactPhone" class="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="範例: 0912-345-678">
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">工程名稱</label>
                <input type="text" id="projectName" class="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="範例: 台北市中山區裝修工程">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">報價日期</label>
                <input type="date" id="quoteDate" class="w-full border border-gray-300 rounded-md p-2 text-sm">
            </div>
        </div>

        <hr class="my-4 border-gray-200">
        <h3 class="text-md font-bold text-gray-700 mb-2">報價明細</h3>

        <!-- 動態品項區 -->
        <div id="items-container" class="space-y-3 mb-4">
            <!-- JS 動態插入 -->
        </div>

        <!-- 雙按鈕設計 -->
        <div class="flex gap-3 mb-6">
            <button onclick="addRow('category')" class="flex-1 py-2 px-4 border border-orange-300 bg-orange-50 text-orange-700 font-bold rounded-md hover:bg-orange-100 transition shadow-sm">
                + 新增大項次
            </button>
            <button onclick="addRow('item')" class="flex-1 py-2 px-4 border border-blue-300 bg-blue-50 text-blue-700 font-bold rounded-md hover:bg-blue-100 transition shadow-sm">
                + 新增子項次(至底部)
            </button>
        </div>

        <!-- 額外費用設定 -->
        <div class="mb-4 bg-yellow-50 p-4 rounded border border-yellow-200">
            <label class="block text-sm font-bold text-gray-700 mb-2">額外費用設定 (管理費、利管費、雜項等)</label>
            <div id="fees-container" class="space-y-2 mb-3"></div>
            <button onclick="addFeeRow()" class="text-sm bg-white border border-yellow-400 text-yellow-700 px-3 py-1 rounded hover:bg-yellow-100 flex items-center">
                <span class="mr-1 text-lg font-bold">+</span> 新增費用項目
            </button>
        </div>

        <!-- 稅務設定 -->
        <div class="mb-6 flex items-center bg-gray-50 p-3 rounded border border-gray-200">
            <input type="checkbox" id="needTax" class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500" checked>
            <label for="needTax" class="ml-2 block text-sm font-bold text-gray-700 cursor-pointer">
                加計 5% 營業稅
            </label>
        </div>

        <!-- 底部備註 -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-1">備註 (顯示於金額下方)</label>
            <textarea id="footerNote" rows="3" class="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="例如：
1. 本報價單有效期限為 15 天。
2. 付款方式：訂金 30%，完工驗收後付清尾款。"></textarea>
        </div>

        <button onclick="generateQuotation()" class="w-full py-3 px-4 text-lg font-bold rounded-md text-white bg-green-600 hover:bg-green-700 shadow-lg">
            預覽並儲存
        </button>
    </div>

    <!-- 預覽區 -->
    <div id="preview-section" class="hidden fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50 overflow-y-auto p-4">
        <div class="bg-white rounded shadow-xl max-w-[230mm] w-full overflow-hidden flex flex-col max-h-[95vh]">
            
            <!-- 報價單畫布 -->
            <div class="overflow-y-auto flex-1 bg-gray-500 p-4 flex justify-center">
                <!-- 調整畫布寬度與 padding 以符合 A4 比例 -->
                <div id="quotation-canvas" class="bg-white p-12 w-full max-w-[210mm] min-h-[297mm] shadow-lg relative">
                    
                    <!-- 1. 抬頭與 Logo -->
                    <div class="flex items-start mb-4 relative">
                        <!-- Logo 顯示區 -->
                        <div class="absolute left-0 top-0">
                            <img id="disp-logo" src="" class="h-20 object-contain hidden" alt="Company Logo">
                        </div>
                        <div class="w-full text-center">
                            <div class="company-title" id="disp-seller-name">健益工程有限公司</div>
                            <div class="doc-title">工程報價單</div>
                        </div>
                    </div>

                    <!-- 2. 客戶與工程資訊表格 (仿 Excel 格線) -->
                    <table class="info-table mb-1">
                        <tr>
                            <td class="text-center w-[15%]">公司名稱</td>
                            <td class="w-[35%]" id="disp-customer"></td>
                            <td class="text-center w-[15%]">聯絡人</td>
                            <td class="w-[35%]" id="disp-contact"></td>
                        </tr>
                        <tr>
                            <td class="text-center">工程名稱</td>
                            <td id="disp-project"></td>
                            <td class="text-center">聯絡電話</td>
                            <td id="disp-phone"></td>
                        </tr>
                    </table>
                    <!-- 日期單號另外放或併入，依照範本日期在右上，這裡微調顯示位置 -->
                    <div class="text-right text-sm mb-2 font-kai">
                        日期：<span id="disp-date"></span> &nbsp;&nbsp; 單號：<span id="disp-id"></span>
                        <span id="disp-taxId-wrapper" class="hidden">&nbsp;&nbsp; 統編：<span id="disp-taxId"></span></span>
                    </div>

                    <!-- 3. 明細表格 -->
                    <table class="items-table mb-2">
                        <thead>
                            <tr class="bg-white">
                                <th style="width: 8%;">項 次</th>
                                <th style="width: 35%;">產品名稱</th> <!-- 包含大項次與子項次 -->
                                <th style="width: 8%;">單位</th>
                                <th style="width: 10%;">數量</th>
                                <th style="width: 12%;">單 價</th>
                                <th style="width: 12%;">複 價</th>
                                <th style="width: 15%;">備 註</th>
                            </tr>
                        </thead>
                        <tbody id="disp-items">
                            <!-- JS 填入 -->
                        </tbody>
                        <!-- 產品小計列 (移到表格內或下方皆可，範本無此列，直接到底部總計) -->
                    </table>

                    <!-- 4. 總計計算區 (仿範本靠右排列) -->
                    <div class="flex justify-end mt-4 px-2">
                        <div class="w-1/2">
                             <!-- 額外費用 -->
                            <div id="disp-additional-fees"></div>
                            
                            <div class="summary-row">
                                <div class="summary-label">合 計 :</div>
                                <div class="summary-value" id="disp-subtotal-notax">0</div>
                            </div>
                            <div class="summary-row">
                                <div class="summary-label">稅 金 :</div>
                                <div class="summary-value" id="disp-tax-amount">0</div>
                            </div>
                            <div class="summary-row" style="border-top: 1px solid #000; margin-top: 2px;">
                                <div class="summary-label">總 計 :</div>
                                <div class="summary-value" id="disp-grand-total">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- 5. 大寫金額 -->
                    <div class="mt-4 text-lg border-b-2 border-transparent pb-1" style="border-bottom: 2px solid #ccc;">
                        新台幣： <span id="disp-chinese-amt" class="font-bold px-2">零元整</span>
                    </div>

                    <!-- 6. 法律聲明 -->
                    <div class="mt-1 text-center font-bold text-sm bg-gray-100 p-1 border border-black">
                        本交易為附條件買賣，內容依動產擔保交易法第三章規定。
                    </div>

                    <!-- 7. 備註 -->
                    <div class="mt-4 flex">
                        <div class="font-bold w-[60px]">備註:</div>
                        <div class="flex-1">
                            <pre id="disp-note" class="whitespace-pre-wrap font-kai"></pre>
                        </div>
                    </div>

                    <!-- 8. LINE帳號/頁尾資訊 -->
                    <div class="mt-12">
                         <div class="mb-2 font-bold">LINE帳號</div>
                         <div class="border-t border-black pt-2 text-center text-sm" id="disp-seller-contact-footer">
                             <!-- 賣方聯絡資訊 -->
                         </div>
                    </div>

                </div>
            </div>

            <!-- 操作按鈕 -->
            <div class="p-4 bg-gray-50 flex gap-4 border-t z-50">
                <button onclick="closePreview()" class="flex-1 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 font-bold">返回修改</button>
                <button onclick="downloadJPG()" id="btn-download" class="flex-1 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold shadow">下載 JPG 圖片</button>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = '您的_GAS_WEB_APP_URL'; 
        const unitOptions = ['m', 'm²', 'm³', 'T(噸)', 'PC', '組', '樘', '才', '坪', '時', '天', '支', '台', '式', '車', '工'];
        const STORAGE_KEY = 'quotation_history_v1';
        
        // 請將您的 Logo Base64 編碼貼入下方引號中
        // 範例：'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg=='
        const DEFAULT_LOGO = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFsAAABbCAMAAAAr6AmrAAAAA3NCSVQICAjb4U/gAAAADFBMVEX/igX/////nS7/kBGlc65UAAAApXpUWHRSYXcgcHJvZmlsZSB0eXBlIEFQUDEAABiVfU5bDsIwDPvvKXYE57G0PU5BBU1CgHb/DxI6xCYhHDV2rShOuvZ7X5fz9Fwfl+XW0xQgtaRVKzcABQMCEIOCvQ9sLOSKXeTtz4OtlgzdzTUcMPuEiVH29zZiFnXs0U+ssBcQx+x2zSd8l/7wGU3jJt78fIyGlEiWIuxdJbuqFiBnNRP8r0B6AQnGQScUvA0CAAABdklEQVRoge3ZWxLCIAwF0DTZ/57V6djyJiG5jjjypZQeUoqAQORNRze56UEFQXaTj7NrPdIu9VibGGhnoYfbhLQJaRPSJqRNSJuBNiFt2tWmXW362y38p21+Jom3swkwLS3lrF5VzpOqq3TdUNkTaion8blsbsE34rG79HE2u8MeyCe+bo+iPpl5P+mk7MaqvjvCsogmdZ5UyqwFu/+gRW0eu77E3Cq4QE9fz7o971Vmm/V3mG192Ot2bFG4LR+wNWOP1eZN7V3bBBn3rr+d6wbFBGi2keOg6AM324aNBLvNatxuD7ZXJM9asJOlT97mXEALdrZkkyrXF3e51Hz+J0m/njUlma/Pev4YpmaBGFyc9gCX9mWDXa+wM8Nnt1f4726jscfvt9TvKxp7/iiWSc5qr6dtbXsz6u1Nt5XMP6jvsWFv0z7K2GzoLrh9E01vQ48doOcl0IMe6AkV9GgNeiYY3hVn82mcHTu2aNYCcXZc8C07qIIHIcAGb2GaLZ0AAAAASUVORK5CYII=';
        
        let userLogoData = DEFAULT_LOGO; // 預設使用內建 Logo

        window.onload = function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('quoteDate').value = today;
            // 載入歷史
            loadCustomerHistory();
        };

        // --- Logo 預覽功能 (移除預覽上傳邏輯，保留變數) ---
        // userLogoData 已經預設，如需更改請使用者直接替換 const DEFAULT_LOGO 的內容

        // --- 數字轉國字大寫 ---
        function toChineseNum(num) {
            if (!/^\d*(\.\d*)?$/.test(num)) { return "Number is wrong!"; }
            var AA = new Array("零", "壹", "貳", "參", "肆", "伍", "陸", "柒", "捌", "玖");
            var BB = new Array("", "拾", "佰", "仟", "萬", "億", "兆", "京");
            var CC = new Array("角", "分", "厘");
            var a = ("" + num).replace(/(^0*)/g, "").split("."), k = 0, re = "";
            for (var i = a[0].length - 1; i >= 0; i--) {
                switch (k) {
                    case 0: re = BB[7] + re; break;
                    case 4: if (!new RegExp("0{4}\\d{" + (a[0].length - i - 1) + "}$").test(a[0])) re = BB[4] + re; break;
                    case 8: re = BB[5] + re; break;
                }
                if (k % 4 == 2 && a[0].charAt(i + 2) != 0 && a[0].charAt(i + 1) == 0) re = AA[0] + re;
                if (a[0].charAt(i) != 0) re = AA[a[0].charAt(i)] + BB[k % 4] + re; k++;
            }
            if (a.length > 1) { // 小數點
                re += "點";
                for (var i = 0; i < a[1].length; i++) {
                    re += AA[a[1].charAt(i)];
                }
            }
            if (re == '') return '零元整';
            return re + "元整";
        }

        // --- 歷史紀錄功能 ---
        function getHistory() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        }

        function saveToHistory(newQuote) {
            let history = getHistory();
            history.unshift(newQuote);
            if (history.length > 100) history = history.slice(0, 100);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        }

        function loadCustomerHistory() {
            const customerName = document.getElementById('customer').value.trim();
            const historyList = document.getElementById('customer-history-list');
            const historyArea = document.getElementById('customer-history-area');
            
            if (!customerName) {
                historyArea.classList.add('hidden');
                return;
            }

            const history = getHistory();
            const customerQuotes = history.filter(q => q.customer === customerName);

            if (customerQuotes.length > 0) {
                let html = '';
                customerQuotes.forEach(q => {
                    html += `<li class="border-b border-gray-100 py-1 hover:bg-gray-50 flex justify-between">
                        <span>${q.project || '(無工程名)'}</span>
                        <span class="font-bold">$${q.subtotalNoTax.toLocaleString()} (未稅)</span>
                    </li>`;
                });
                historyList.innerHTML = html;
                historyArea.classList.remove('hidden');
            } else {
                historyArea.classList.add('hidden');
            }
        }

        function checkItemHistory(inputEl) {
            const itemName = inputEl.value.trim();
            const customerName = document.getElementById('customer').value.trim();
            const row = inputEl.closest('.item-row');
            
            const priceHint = row.querySelector('.history-price-hint');
            const unitHint = row.querySelector('.history-unit-hint');

            if (!itemName || !customerName) {
                if(priceHint) priceHint.innerText = '';
                if(unitHint) unitHint.innerText = '';
                return;
            }

            const history = getHistory();
            let lastRecord = null;
            let lastDate = '';

            for (let quote of history) {
                if (quote.customer === customerName && quote.items) {
                    const foundItem = quote.items.find(i => i.type === 'item' && i.name === itemName);
                    if (foundItem) {
                        lastRecord = foundItem;
                        lastDate = quote.date;
                        break;
                    }
                }
            }

            if (lastRecord) {
                if(priceHint) priceHint.innerText = `歷史: $${lastRecord.price.toLocaleString()} (${lastDate})`;
                if(unitHint) unitHint.innerText = `曾用: ${lastRecord.unit}`;
            } else {
                if(priceHint) priceHint.innerText = '';
                if(unitHint) unitHint.innerText = '';
            }
        }

        async function lookupCompany() {
            const taxId = document.getElementById('taxId').value.trim();
            const nameInput = document.getElementById('customer');
            if (taxId.length !== 8) {
                alert("請輸入正確的 8 碼統一編號");
                return;
            }
            nameInput.placeholder = "查詢中...";
            try {
                const response = await fetch(`https://data.gcis.nat.gov.tw/od/data/api/9D17AE0D-09B5-4432-A8F4-81B43F75F718?$format=json&$filter=Business_Accounting_NO eq ${taxId}&$skip=0&$top=1`);
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        nameInput.value = data[0].Company_Name;
                        loadCustomerHistory();
                    } else alert("查無此統編資料，請手動輸入名稱。");
                } else throw new Error("API Error");
            } catch (e) {
                console.log("Auto lookup failed.", e);
                if(nameInput.value === "") nameInput.placeholder = "無法自動取得，請手動輸入";
            }
        }

        function toggleUnit(selectEl) {
            if (selectEl.value === 'custom') {
                const parent = selectEl.parentElement;
                selectEl.classList.add('hidden');
                parent.querySelector('.input-unit-custom-group').classList.remove('hidden');
                parent.querySelector('.input-unit-custom').focus();
            }
        }
        function resetUnit(btn) {
            const parent = btn.parentElement.parentElement;
            parent.querySelector('.input-unit-custom-group').classList.add('hidden');
            const select = parent.querySelector('.input-unit-select');
            select.classList.remove('hidden');
            select.value = unitOptions[0];
        }

        function addFeeRow() {
            const container = document.getElementById('fees-container');
            const rowId = 'fee-' + Date.now();
            const html = `
                <div id="${rowId}" class="fee-row flex gap-2 items-center bg-white p-2 rounded border border-gray-200">
                    <input type="text" class="fee-name w-1/2 border border-gray-300 rounded p-1 text-sm" placeholder="費用名稱">
                    <div class="flex-1 flex gap-1">
                        <select class="fee-type border border-gray-300 rounded p-1 text-sm bg-white">
                            <option value="percent">%</option>
                            <option value="amount">$</option>
                        </select>
                        <input type="number" class="fee-value w-full border border-gray-300 rounded p-1 text-sm text-right" placeholder="數值">
                    </div>
                    <button onclick="document.getElementById('${rowId}').remove()" class="text-red-500 font-bold px-2 hover:bg-red-50 rounded">✕</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        function getItemRowHtml(index, rowId) {
            let optionsHtml = unitOptions.map(u => `<option value="${u}">${u}</option>`).join('');
            optionsHtml += `<option value="custom" class="font-bold text-blue-600">✎ 自訂(使用者輸入)</option>`;
            
            return `
            <div id="${rowId}" class="item-row bg-white p-4 rounded border border-gray-200 relative shadow-sm ml-4 border-l-4 border-l-blue-400">
                <input type="hidden" class="row-type" value="item">
                <div class="absolute left-2 top-2 bg-gray-200 text-gray-600 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold index-badge">${index}</div>
                <button onclick="removeRow('${rowId}')" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 font-bold p-1">✕</button>
                
                <div class="grid grid-cols-12 gap-2 mt-2">
                    <div class="col-span-12 md:col-span-6">
                        <label class="text-xs text-gray-500">子項次(產品)</label>
                        <input type="text" class="input-name w-full border border-gray-300 rounded p-1" placeholder="品項名稱" oninput="checkItemHistory(this)">
                    </div>
                    <div class="col-span-4 md:col-span-2">
                        <label class="text-xs text-gray-500">數量</label>
                        <input type="number" class="input-qty w-full border border-gray-300 rounded p-1 text-center" value="1">
                    </div>
                    <div class="col-span-4 md:col-span-2">
                        <label class="text-xs text-gray-500">單位</label>
                        <select class="input-unit-select w-full border border-gray-300 rounded p-1 text-center bg-white" onchange="toggleUnit(this)">
                            ${optionsHtml}
                        </select>
                        <div class="input-unit-custom-group hidden flex">
                            <input type="text" class="input-unit-custom w-full border border-gray-300 rounded-l p-1 text-center text-sm" placeholder="輸入">
                            <button onclick="resetUnit(this)" class="bg-gray-200 px-2 rounded-r border border-l-0 border-gray-300 text-gray-500 hover:bg-gray-300">↩</button>
                        </div>
                        <div class="history-unit-hint history-hint"></div>
                    </div>
                    <div class="col-span-4 md:col-span-2">
                        <label class="text-xs text-gray-500">單價</label>
                        <input type="number" class="input-price w-full border border-gray-300 rounded p-1 text-right" placeholder="0">
                        <div class="history-price-hint history-hint"></div>
                    </div>
                    <div class="col-span-12">
                        <label class="text-xs text-gray-500">項次備註</label>
                        <input type="text" class="input-remark w-full border border-gray-300 rounded p-1 text-sm text-gray-600" placeholder="備註...">
                    </div>
                </div>
            </div>`;
        }

        function insertItemAfter(btn) {
            const targetRow = btn.closest('.item-row');
            const rowId = 'row-' + Date.now();
            const html = getItemRowHtml('temp', rowId); 
            targetRow.insertAdjacentHTML('afterend', html);
            updateIndexes();
        }

        function addRow(type) {
            const container = document.getElementById('items-container');
            const index = container.children.length + 1;
            const rowId = 'row-' + Date.now();
            let html = '';

            if (type === 'category') {
                html = `
                <div id="${rowId}" class="item-row bg-orange-50 p-4 rounded border border-orange-200 relative shadow-sm border-l-4 border-l-orange-400">
                    <input type="hidden" class="row-type" value="category">
                    <div class="absolute left-2 top-2 bg-orange-200 text-orange-800 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold index-badge">${index}</div>
                    <button onclick="removeRow('${rowId}')" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 font-bold p-1">✕</button>
                    
                    <div class="mt-2 flex flex-col md:flex-row gap-4 items-end">
                        <div class="flex-1 w-full">
                            <label class="text-xs text-orange-600 font-bold block mb-1">大項次名稱</label>
                            <input type="text" class="input-category w-full border border-orange-300 rounded p-2 font-bold text-gray-800" placeholder="例如：拆除工程、水電工程...">
                        </div>
                        <button onclick="insertItemAfter(this)" class="w-full md:w-auto py-2 px-3 bg-blue-100 text-blue-700 text-sm rounded hover:bg-blue-200 border border-blue-200 font-bold">
                            + 新增此類別子項
                        </button>
                    </div>
                </div>`;
            } else {
                html = getItemRowHtml(index, rowId);
            }

            container.insertAdjacentHTML('beforeend', html);
            updateIndexes();
        }

        function removeRow(id) {
            document.getElementById(id).remove();
            updateIndexes();
        }

        function updateIndexes() {
            document.querySelectorAll('.item-row').forEach((row, idx) => {
                row.querySelector('.index-badge').innerText = idx + 1;
            });
        }

        function generateItemHtml(idx, item) {
            return `
                <tr>
                    <td class="text-center">${idx}</td>
                    <td>${item.name}</td>
                    <td class="text-center">${item.unit}</td>
                    <td class="text-center">${item.qty}</td>
                    <td class="text-right">${item.price.toLocaleString()}</td>
                    <td class="text-right">${item.subtotal.toLocaleString()}</td>
                    <td class="text-left text-sm">${item.remark}</td>
                </tr>
            `;
        }

        async function generateQuotation() {
            const customer = document.getElementById('customer').value.trim();
            if (!customer) return alert('請輸入客戶名稱');

            const needTax = document.getElementById('needTax').checked;
            const sellerName = document.getElementById('sellerName').value;
            const sellerContact = document.getElementById('sellerContact').value;
            
            const baseInfo = {
                taxId: document.getElementById('taxId').value,
                contact: document.getElementById('contactPerson').value,
                phone: document.getElementById('contactPhone').value,
                project: document.getElementById('projectName').value,
                date: document.getElementById('quoteDate').value,
                note: document.getElementById('footerNote').value,
                orderId: 'QT-' + Date.now().toString().slice(-6),
                sellerName,
                sellerContact
            };

            const rows = document.querySelectorAll('.item-row');
            let itemsData = [];
            let itemsTotal = 0; 
            let groupedData = [];
            let currentGroup = null; 
            let miscItems = []; 
            let globalIndex = 1;

            rows.forEach((row, idx) => {
                const type = row.querySelector('.row-type').value;

                if (type === 'category') {
                    if (currentGroup) groupedData.push(currentGroup);
                    const categoryName = row.querySelector('.input-category').value.trim();
                    currentGroup = {
                        type: 'category',
                        name: categoryName || '(未命名項次)',
                        items: [],
                        subtotal: 0
                    };
                } else {
                    const name = row.querySelector('.input-name').value.trim();
                    if (name) {
                        const qty = parseFloat(row.querySelector('.input-qty').value) || 0;
                        const select = row.querySelector('.input-unit-select');
                        const unit = (!select.classList.contains('hidden')) ? select.value : row.querySelector('.input-unit-custom').value;
                        const price = parseFloat(row.querySelector('.input-price').value) || 0;
                        const remark = row.querySelector('.input-remark').value;
                        const subtotal = qty * price;

                        const itemObj = { type: 'item', name, qty, unit, price, subtotal, remark };
                        itemsTotal += subtotal;

                        if (currentGroup) {
                            currentGroup.items.push(itemObj);
                            currentGroup.subtotal += subtotal;
                        } else {
                            miscItems.push(itemObj);
                        }
                    }
                }
            });
            if (currentGroup) groupedData.push(currentGroup);

            if(groupedData.length === 0 && miscItems.length === 0) return alert('請至少輸入一項內容');

            // 費用計算
            const feeRows = document.querySelectorAll('.fee-row');
            let totalFees = 0;
            let feesHtml = '';
            let feesData = []; 

            feeRows.forEach(row => {
                const name = row.querySelector('.fee-name').value.trim();
                const type = row.querySelector('.fee-type').value;
                const val = parseFloat(row.querySelector('.fee-value').value) || 0;
                
                if (name) {
                    let amount = 0;
                    let label = '';
                    if (type === 'percent') {
                        amount = Math.round(itemsTotal * (val / 100));
                        label = `${name}(${val}%)`;
                    } else {
                        amount = val;
                        label = name;
                    }
                    totalFees += amount;
                    feesData.push({ name, type, val, amount });
                    
                    feesHtml += `
                        <div class="summary-row">
                            <div class="summary-label">${label} :</div>
                            <div class="summary-value">$${amount.toLocaleString()}</div>
                        </div>
                    `;
                }
            });

            const subtotalNoTax = itemsTotal + totalFees; 
            const taxAmount = needTax ? Math.round(subtotalNoTax * 0.05) : 0;
            const grandTotal = subtotalNoTax + taxAmount; 

            // 儲存歷史
            const currentQuote = {
                ...baseInfo,
                customer,
                items: itemsData, 
                fees: feesData,
                subtotalNoTax,
                grandTotal
            };
            saveToHistory(currentQuote);

            // 產生顯示 HTML
            let displayHtml = '';
            
            // 未分類項目
            miscItems.forEach(item => {
                displayHtml += generateItemHtml(globalIndex++, item);
                itemsData.push(item);
            });

            // 分類項目
            groupedData.forEach(group => {
                // 大項次標題列
                displayHtml += `
                    <tr>
                        <td class="text-center">${globalIndex++}</td>
                        <td class="font-bold text-lg" colspan="4">${group.name}</td>
                        <td class="text-right font-bold">${group.subtotal > 0 ? group.subtotal.toLocaleString() : ''}</td>
                        <td></td>
                    </tr>
                `;
                itemsData.push({ type: 'category', category: group.name, subtotal: group.subtotal });
                
                group.items.forEach(item => {
                    displayHtml += generateItemHtml(globalIndex++, item);
                    itemsData.push(item);
                });
            });

            // 填入預覽資料
            document.getElementById('disp-seller-name').innerText = sellerName;
            document.getElementById('disp-customer').innerText = customer;
            // 處理統編顯示
            if(baseInfo.taxId) {
                document.getElementById('disp-taxId').innerText = baseInfo.taxId;
                document.getElementById('disp-taxId-wrapper').classList.remove('hidden');
            } else {
                document.getElementById('disp-taxId-wrapper').classList.add('hidden');
            }
            
            document.getElementById('disp-project').innerText = baseInfo.project;
            document.getElementById('disp-contact').innerText = baseInfo.contact;
            document.getElementById('disp-phone').innerText = baseInfo.phone;
            document.getElementById('disp-date').innerText = baseInfo.date;
            document.getElementById('disp-id').innerText = baseInfo.orderId;
            document.getElementById('disp-items').innerHTML = displayHtml;
            document.getElementById('disp-note').innerText = baseInfo.note;
            document.getElementById('disp-seller-contact-footer').innerText = sellerContact;

            // 金額
            document.getElementById('disp-additional-fees').innerHTML = feesHtml; 
            document.getElementById('disp-subtotal-notax').innerText = '$' + subtotalNoTax.toLocaleString();
            document.getElementById('disp-tax-amount').innerText = '$' + taxAmount.toLocaleString();
            document.getElementById('disp-grand-total').innerText = '$' + grandTotal.toLocaleString();
            document.getElementById('disp-chinese-amt').innerText = toChineseNum(grandTotal);

            // Logo 處理
            const logoImg = document.getElementById('disp-logo');
            if (userLogoData) {
                logoImg.src = userLogoData;
                logoImg.classList.remove('hidden');
            } else {
                logoImg.classList.add('hidden');
            }

            document.getElementById('preview-section').classList.remove('hidden');

            if (GAS_URL && GAS_URL !== '您的_GAS_WEB_APP_URL') {
                const payload = { ...currentQuote, itemsTotal, totalFees, taxAmount, needTax };
                fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'text/plain' },
                    mode: 'no-cors'
                }).catch(e => console.error(e));
            }
        }

        function closePreview() {
            document.getElementById('preview-section').classList.add('hidden');
            loadCustomerHistory();
        }

        function downloadJPG() {
            const element = document.getElementById('quotation-canvas');
            const btn = document.getElementById('btn-download');
            const originalText = btn.innerText;
            btn.innerText = '處理中...';
            btn.disabled = true;
            
            // 修正截圖時文字偏移問題：暫時強制設定字型與 scale
            const options = {
                scale: 2, 
                useCORS: true, 
                backgroundColor: '#ffffff',
                logging: false,
                windowWidth: element.scrollWidth, // 確保完整寬度
                windowHeight: element.scrollHeight
            };

            setTimeout(() => {
                html2canvas(element, options).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `報價單_${document.getElementById('disp-customer').innerText}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                    btn.innerText = originalText;
                    btn.disabled = false;
                }).catch(err => {
                    console.error(err);
                    alert("生成失敗");
                    btn.innerText = originalText;
                    btn.disabled = false;
                });
            }, 300); // 稍微增加延遲確保渲染完成
        }
    </script>
</body>
</html>
